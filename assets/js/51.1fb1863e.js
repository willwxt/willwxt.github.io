(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{411:function(s,a,t){"use strict";t.r(a);var e=t(45),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"高并发负载均衡-lvs-keepalived"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高并发负载均衡-lvs-keepalived"}},[s._v("#")]),s._v(" 高并发负载均衡 LVS + keepalived")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1115533",target:"_blank",rel:"noopener noreferrer"}},[s._v("LVS原理知多少"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"http://zh.linuxvirtualserver.org/handbooks",target:"_blank",rel:"noopener noreferrer"}},[s._v("LVS中文站点-手册"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("目录: 高并发 负载均衡 高可用")]),s._v(" "),t("blockquote",[t("p",[s._v("从闲聊开始: 中国 - 入网人口基数 - 硅谷亚太研究院 - 营销 - 陌陌 - 流量->VIP用户 - 高并发 - 计算渠道引流的质量 - 计算每个渠道的转化率和购买力 - 转服务service行业")]),s._v(" "),t("p",[s._v("高并发的重要性")])]),s._v(" "),t("h4",{attrs:{id:"为什么要分层-osi-分层解耦"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么要分层-osi-分层解耦"}},[s._v("#")]),s._v(" 为什么要分层? OSI? - 分层解耦!")]),s._v(" "),t("blockquote",[t("p",[s._v("开发人员可能只需要接触应用层")]),s._v(" "),t("p",[s._v("其中任何一层需要维护更改, 其他任何一层不会受到影响!!")])]),s._v(" "),t("h5",{attrs:{id:"osi七层参考模型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#osi七层参考模型"}},[s._v("#")]),s._v(" OSI七层参考模型")]),s._v(" "),t("blockquote",[t("p",[s._v("只是模型, 没有实现")])]),s._v(" "),t("h3",{attrs:{id:"tcp-ip-协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp-ip-协议"}},[s._v("#")]),s._v(" TCP/IP 协议")]),s._v(" "),t("blockquote",[t("p",[s._v("定义了实现七层参考模型的协议规范")])]),s._v(" "),t("h5",{attrs:{id:"每层可以出现不同的协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#每层可以出现不同的协议"}},[s._v("#")]),s._v(" 每层可以出现不同的协议")]),s._v(" "),t("blockquote",[t("p",[s._v("协议, 通信时候的约定, 报文格式")])]),s._v(" "),t("h4",{attrs:{id:"http协议"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#http协议"}},[s._v("#")]),s._v(" HTTP协议")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 骚操作")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$$")]),s._v("/fd\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示当前运行程序的PID 在bash直接运行就是bash的pid 将这句写进脚本test.sh，运行test.sh时 $$表示执行脚本test.sh的进程的PID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fd 文件描述符")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("8")]),s._v("<>")]),s._v(" /dev/tcp/www.baidu.com/80\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在这个目录下创建 8(输入输出) 指向这个磁盘目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 现在先创建了 socket")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'GET / HTTP/1.0"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -e将\\n识别为换行符  > 输出重定向  >& 表示8不是文件, 是文件描述符 'GET / HTTP/1.0\\n' HTTP协议规定 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将请求头发给socket")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 标准输入0 来自文件描述符8 # 把这个socket怼到当前命令行上 # 把output打印出来")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("8")]),s._v("<&")]),s._v(" - "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把8关掉")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("blockquote",[t("p",[s._v("第一步建立连接")]),s._v(" "),t("p",[s._v("第二步才是传送数据（http协议：规范标准）")]),s._v(" "),t("p",[s._v("最终给你演示的是一个应用层协议")])]),s._v(" "),t("h4",{attrs:{id:"流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[s._v("#")]),s._v(" 流程")]),s._v(" "),t("blockquote",[t("p",[s._v("应用层浏览器整理数据后, 调用传输控制层, 逐级向下调用, 最终是通过物理层进行发送")]),s._v(" "),t("p",[s._v("应用层是用户态")]),s._v(" "),t("p",[s._v("从传输控制层往下基本上都是内核态")])]),s._v(" "),t("h4",{attrs:{id:"传输控制层"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#传输控制层"}},[s._v("#")]),s._v(" 传输控制层")]),s._v(" "),t("blockquote",[t("p",[s._v("TCP(面向连接, 可靠) UDP(不可靠)")])]),s._v(" "),t("h4",{attrs:{id:"面向连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#面向连接"}},[s._v("#")]),s._v(" 面向连接")]),s._v(" "),t("blockquote",[t("p",[s._v("互相确认")])]),s._v(" "),t("h4",{attrs:{id:"三次握手-为什么三次握手才能建立连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三次握手-为什么三次握手才能建立连接"}},[s._v("#")]),s._v(" 三次握手 为什么三次握手才能建立连接")]),s._v(" "),t("blockquote",[t("p",[s._v("C == S ;")]),s._v(" "),t("p",[s._v('s回复之后在等对方确认, 所以需要"第三次握手" (TCP可靠, 需要得到回复来保证可靠)')]),s._v(" "),t("p",[s._v("三次握手之后双方才会开辟内存资源 建立连接")]),s._v(" "),t("p",[s._v("socket 可以有的端口数量是 65535 , 不可能创建端口后不去关闭, 会达到操作系统端口上限, 所以要分手")])]),s._v(" "),t("h4",{attrs:{id:"四次挥手-分手"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四次挥手-分手"}},[s._v("#")]),s._v(" 四次挥手/分手")]),s._v(" "),t("blockquote",[t("p",[s._v("C == S ;")]),s._v(" "),t("p",[s._v("因为TCP是可靠的传输机制, 发送信息之后对方都会返回我收到了 , 但是因为 S端 有可能还需要处理一些数据(或是还需要发送数据等) ,  所以 C端 需要一起处理直到等到 S端 发送一个可以开始断开链接的请求")])]),s._v(" "),t("h4",{attrs:{id:"结论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[s._v("#")]),s._v(" 结论")]),s._v(" "),t("blockquote",[t("p",[s._v("三次握手 - 数据传输 - 四次分手")]),s._v(" "),t("p",[s._v("成为一个最小粒度, 不可被分割 --- 端点之间的传输数据是不允许被打散的 (分布式Case)")]),s._v(" "),t("p",[s._v("没必要只有一个单独的确认过程, 可以额外带上数据包")])]),s._v(" "),t("h4",{attrs:{id:"netstat-natp-nltp"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#netstat-natp-nltp"}},[s._v("#")]),s._v(" netstat -natp/nltp")]),s._v(" "),t("blockquote",[t("p",[s._v("n IP地址不要用逻辑名称显示 a 所有 t tcp p pid")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Local Address")]),s._v(" "),t("th",[s._v("Foreign Address")]),s._v(" "),t("th",[s._v("State")]),s._v(" "),t("th",[s._v("PID")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("本地")]),s._v(" "),t("td",[s._v("对端")]),s._v(" "),t("td",[s._v("连接状态")]),s._v(" "),t("td",[s._v("使用进程")])])])]),s._v(" "),t("blockquote",[t("p",[s._v("SOCKET 就是一个 本地ip:port + 对端ip:port 独立的连接")])]),s._v(" "),t("h4",{attrs:{id:"网络层"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络层"}},[s._v("#")]),s._v(" 网络层")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/sysconfig/network-scripts/ifcfg-eth0\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if interface cfg config 接口配置 eth0 eth enternet")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IP NETMASK GATEWAY DNS 四个维度")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通信id号点分字节 4个255")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 掩码 二进制的按位与运算 得出网络号 192.168.150.0 主机位 14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网关 ")]),s._v("\nroute -n "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由表")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h5",{attrs:{id:"下一跳机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下一跳机制"}},[s._v("#")]),s._v(" 下一跳机制")]),s._v(" "),t("blockquote",[t("p",[s._v("不需要存全网设备, 只需要知道自己一步之内的服务器位置")])]),s._v(" "),t("h5",{attrs:{id:"路由表-所有设备都有路由表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#路由表-所有设备都有路由表"}},[s._v("#")]),s._v(" 路由表 所有设备都有路由表")]),s._v(" "),t("blockquote",[t("p",[s._v("要访问 61.135.169.121 , 需要在路由表内堆Genmask做按位与运算(路由判定), 并匹配目标地址Destination")]),s._v(" "),t("p",[s._v("路由表的最后一条条目, 无论什么地址都可以匹配并跳指网关, 称为默认网关")]),s._v(" "),t("p",[s._v("网络工程师 --- 规划网络")]),s._v(" "),t("p",[s._v("路由表的 Gateway 为 0.0.0.0 说明是同一个网络环境, 否则说明不是直连的(需要路由)")])]),s._v(" "),t("h4",{attrs:{id:"链路层"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#链路层"}},[s._v("#")]),s._v(" 链路层")]),s._v(" "),t("blockquote",[t("p",[s._v("网络层只能找到下一跳, 链路层通过网络层计算出的IP解析为MAC来进行下一跳 (同一局域网内)")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("arp -a\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# arp协议 解释IP地址和网卡硬件地址的映射 arp是同一局域网内的")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"arp"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#arp"}},[s._v("#")]),s._v(" ARP")]),s._v(" "),t("blockquote",[t("p",[s._v("计算机开机并没有 arp 表, 首先封装一个arp包(包含MAC地址FFFFFF, 默认网关)从网卡发送, 交换机会对这个包进行广播, 配对不成功的设备会把arp包丢弃, 而配对成功的设备会返回原地址一个带有自己MAC地址的arp包")]),s._v(" "),t("p",[s._v("交换机 二层 具有学习能力(记录自己设备端口连接设备的MAC地址的能力)")]),s._v(" "),t("p",[s._v("计算机连网后会先通告自己的地址, 减少arp请求过程")])]),s._v(" "),t("h4",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("最终数据包存有几个数据 确定最终给哪个设备/端点")]),s._v(" "),t("ol",[t("li",[s._v("链路层解析出来的MAC(下一跳)")]),s._v(" "),t("li",[s._v("最终需要访问的IP地址")]),s._v(" "),t("li",[s._v("最终需要访问的端口")])]),s._v(" "),t("p",[s._v("过程中只有MAC地址会发生变化")]),s._v(" "),t("p",[s._v("TCP/IP协议基于下一跳的机制, IP是端点间, MAC地址是节点间的")]),s._v(" "),t("h2",{attrs:{id:"第二节"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二节"}},[s._v("#")]),s._v(" 第二节")]),s._v(" "),t("h4",{attrs:{id:"操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#操作"}},[s._v("#")]),s._v(" 操作")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加虚拟网卡 /24是掩码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" eth0:3 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".88.88/24\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加路由表条目 -host是单个主机, -net需要给出掩码位")]),s._v("\nroute "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -host "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".88.88 gw "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.13\nroute del -host "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".88.88\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过增加路由表条目来访问对方网卡")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h4",{attrs:{id:"网络中ip冲突-ip不能重复配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网络中ip冲突-ip不能重复配置"}},[s._v("#")]),s._v(" 网络中IP冲突 IP不能重复配置")]),s._v(" "),t("h4",{attrs:{id:"为什么tomcat慢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么tomcat慢"}},[s._v("#")]),s._v(" 为什么TOMCAT慢")]),s._v(" "),t("blockquote",[t("p",[s._v("应用层软件, 需要走完七层, 传输控制层必须完成了三次握手")]),s._v(" "),t("p",[s._v("跑在JVM上, 内核中的虚拟机")])]),s._v(" "),t("h4",{attrs:{id:"四层负载均衡服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四层负载均衡服务器"}},[s._v("#")]),s._v(" 四层负载均衡服务器")]),s._v(" "),t("blockquote",[t("p",[s._v("低层次的")]),s._v(" "),t("p",[s._v("特别快, 不会和客户端握手, 数据包转发级别, 还能偷窥数据包中的请求IP, 端口")]),s._v(" "),t("p",[s._v("后端的服务器必须是镜像的")])]),s._v(" "),t("h4",{attrs:{id:"nat"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nat"}},[s._v("#")]),s._v(" NAT")]),s._v(" "),t("blockquote",[t("p",[s._v("基于三-四层")]),s._v(" "),t("p",[s._v("虚拟IP, 将虚拟出来的IP和自己IP的不同端口号进行映射来访问网络")]),s._v(" "),t("p",[s._v("路由器还需要一张表, 替换源地址, 靠虚拟Client端口号来进行映射")])]),s._v(" "),t("h4",{attrs:{id:"d-nat"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#d-nat"}},[s._v("#")]),s._v(" D-NAT")]),s._v(" "),t("blockquote",[t("p",[s._v("瓶颈: 通信非对称(上行少, 下行量多), 带宽, 算力")])]),s._v(" "),t("h4",{attrs:{id:"思路-对外隐藏vip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#思路-对外隐藏vip"}},[s._v("#")]),s._v(" 思路: 对外隐藏VIP")]),s._v(" "),t("blockquote",[t("p",[s._v("要对外隐藏VIP, 负载均衡服务器的包的VIP地址不能变更")]),s._v(" "),t("p",[s._v("通过制造 CIP - VIP | RIP@MAC 跳到server")])]),s._v(" "),t("h4",{attrs:{id:"dr-直接路由"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dr-直接路由"}},[s._v("#")]),s._v(" DR 直接路由")]),s._v(" "),t("blockquote",[t("p",[s._v("基于二层 速度更快, 成本更低, 企业级使用最多")]),s._v(" "),t("p",[s._v("MAC欺骗 (修改内核, 修改arp协议)")]),s._v(" "),t("p",[s._v("缺陷: 因为是MAC欺骗, 所以负载均衡服务器和server必须在同一个局域网")])]),s._v(" "),t("h2",{attrs:{id:"第三节"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第三节"}},[s._v("#")]),s._v(" 第三节")]),s._v(" "),t("h4",{attrs:{id:"tun隧道技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tun隧道技术"}},[s._v("#")]),s._v(" TUN隧道技术")]),s._v(" "),t("blockquote",[t("p",[s._v("IP包 背着 IP包")]),s._v(" "),t("p",[s._v("到达server端后解析(打开背包)")]),s._v(" "),t("p",[s._v("PPPOE")]),s._v(" "),t("p",[s._v("VPN & 翻墙")])]),s._v(" "),t("h4",{attrs:{id:"基础常识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基础常识"}},[s._v("#")]),s._v(" 基础常识")]),s._v(" "),t("blockquote",[t("p",[s._v("虚拟网卡lo")]),s._v(" "),t("p",[s._v("127.0.0.1 localhost 请求发送直接rollback本机 lo是不和网络通信的 lo对外隐藏, 对内可见")]),s._v(" "),t("p",[s._v("任何借口都有子接口")])]),s._v(" "),t("h4",{attrs:{id:"调度算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#调度算法"}},[s._v("#")]),s._v(" 调度算法")]),s._v(" "),t("h4",{attrs:{id:"静态调度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#静态调度"}},[s._v("#")]),s._v(" 静态调度")]),s._v(" "),t("blockquote",[t("p",[s._v("rr 轮询 wrr dh sh")])]),s._v(" "),t("h4",{attrs:{id:"动态调度算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动态调度算法"}},[s._v("#")]),s._v(" 动态调度算法")]),s._v(" "),t("blockquote",[t("p",[s._v("lc 最少连接数")]),s._v(" "),t("p",[s._v("...")])]),s._v(" "),t("h4",{attrs:{id:"dr偷窥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dr偷窥"}},[s._v("#")]),s._v(" DR偷窥")]),s._v(" "),t("blockquote",[t("p",[s._v("通过偷窥客户端发送的 sync ack包, fin ack包, 来计算哪个服务有多少连接")])]),s._v(" "),t("h4",{attrs:{id:"lvs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lvs"}},[s._v("#")]),s._v(" LVS")]),s._v(" "),t("blockquote",[t("p",[s._v("linux模块自带LVS 模块名称为ipvs")]),s._v(" "),t("p",[s._v("ipvsadm 内核lvs模块的交互软件, 是用户态的使用C写的接口调用")])]),s._v(" "),t("h4",{attrs:{id:"ipvsadm-基本操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ipvsadm-基本操作"}},[s._v("#")]),s._v(" ipvsadm 基本操作")]),s._v(" "),t("blockquote",[t("p",[s._v("yum install ipvsadm -y 安装")]),s._v(" "),t("p",[s._v("-A/-a 添加集群服务")])]),s._v(" "),t("h4",{attrs:{id:""}},[t("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])]),s._v(" "),t("h4",{attrs:{id:"vmware"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#vmware"}},[s._v("#")]),s._v(" VMware")]),s._v(" "),t("h4",{attrs:{id:"虚拟网络"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#虚拟网络"}},[s._v("#")]),s._v(" 虚拟网络")]),s._v(" "),t("blockquote",[t("p",[s._v("VMware NAT Service")]),s._v(" "),t("p",[s._v("创建虚拟网络(虚拟网卡), 地址是192.168.145.2 具有NAT功能, 并且VMware NAT Service实现和Internet之间的地址映射/转换, 可以上网")]),s._v(" "),t("p",[s._v("其次, 在windows中创建虚拟网卡VMnet8, 地址为 192.168.145.1 网关指向192.168.145.2 使得windows本机可以访问到虚拟网络")])]),s._v(" "),t("h4",{attrs:{id:"环回地址-loopback"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环回地址-loopback"}},[s._v("#")]),s._v(" 环回地址 loopback")]),s._v(" "),t("blockquote",[t("p",[s._v("127.0.0.1 localhost")]),s._v(" "),t("p",[s._v("lo 虚拟网卡")])]),s._v(" "),t("h4",{attrs:{id:"实验手册"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实验手册"}},[s._v("#")]),s._v(" 实验手册")]),s._v(" "),t("blockquote",[t("p",[s._v("其中一台作为LVS服务器, 持有RIP(真实访问IP)(这里使用eth0子IP) , 请求访问到之后给他后面带上服务器的MAC地址, 发到另外两台Server服务器")]),s._v(" "),t("p",[s._v("Server服务器 lo网卡设置子IP(自己使用, 不共享到局域网)")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加虚拟网卡 /24是掩码 24个1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 也可以写 netmask 255.255.255.0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 首先给LVS主机增加访问IP")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" eth0:2 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".145.100/24 \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁用 down掉")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" eth0:2 down\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ***先设置隐藏协议, 再修改ip!!!********************")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /proc/sys/ne/ipv4/conf/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改下面的 eth0 和 all 两个接口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# arp协议文件修改, 不能使用vim(不允许在该文件下创建缓存)")]),s._v("\narp_ignore \t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0->1\t使用 echo 1 > arp_ignore 重定向")]),s._v("\narp_announce\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0->2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 增加隐藏VIP 必须配255.255.255.255")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" lo:2 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".145.100 netmask "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.255\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h5",{attrs:{id:"搭建httpd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建httpd"}},[s._v("#")]),s._v(" 搭建httpd")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" httpd -y\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service httpd start")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个主页 index.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/www/html/\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认目录")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h5",{attrs:{id:"使用lvs-ipvsadm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用lvs-ipvsadm"}},[s._v("#")]),s._v(" 使用lvs (ipvsadm)")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 入包规则")]),s._v("\nipvsadm -A -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".145.100:80 -s rr\nipvsadm -ln\nipvsadm -a -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".145.100:80 -r "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.12 -g -w "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nipvsadm -a -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".145.100:80 -r "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".150.13 -g -w "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nipvsadm -ln\nipvsadm -lnc\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看偷窥记录本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# FIN_WAIT： 连接过，偷窥了所有的包")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SYN_RECV(握手发送)： 基本上lvs都记录了，证明lvs没事，一定是后边网络层出问题")]),s._v("\nipvsadm -C "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清空")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"第三节-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第三节-2"}},[s._v("#")]),s._v(" 第三节")]),s._v(" "),t("h4",{attrs:{id:"问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),t("h4",{attrs:{id:"lvs服务器可能挂掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lvs服务器可能挂掉"}},[s._v("#")]),s._v(" LVS服务器可能挂掉")]),s._v(" "),t("blockquote",[t("p",[s._v("虽然服务没有下线但是用户无法访问")])]),s._v(" "),t("h4",{attrs:{id:"server服务器可能挂掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#server服务器可能挂掉"}},[s._v("#")]),s._v(" Server服务器可能挂掉")]),s._v(" "),t("blockquote",[t("p",[s._v("LVS还拥有其负载条目, 会造成一部分用户无法访问")])]),s._v(" "),t("h4",{attrs:{id:"单点故障的解决方式-一变多"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单点故障的解决方式-一变多"}},[s._v("#")]),s._v(" 单点故障的解决方式 一变多")]),s._v(" "),t("blockquote",[t("p",[s._v("问题: VIP必须是唯一的")]),s._v(" "),t("p",[s._v("两个思路:  1. 主备 2. 主主")])]),s._v(" "),t("h4",{attrs:{id:"主备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主备"}},[s._v("#")]),s._v(" 主备")]),s._v(" "),t("p",[s._v("方向性")]),s._v(" "),t("p",[s._v("效率性")]),s._v(" "),t("h4",{attrs:{id:"keepalived"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalived"}},[s._v("#")]),s._v(" keepalived")]),s._v(" "),t("blockquote",[t("p",[s._v("代替人运维, 解决单点故障, 实现HA, 通用的工具")]),s._v(" "),t("ol",[t("li",[s._v("监控自己服务")]),s._v(" "),t("li",[s._v("Master通过自己还活着, Backup监听Master状态, Backup选举")]),s._v(" "),t("li",[s._v("配置")]),s._v(" "),t("li",[s._v("对后端server做健康检查")])]),s._v(" "),t("p",[s._v("Nginx也可以用keepalived保证HA")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" keepalived -y "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/keepalived/\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置文件夹 备份配置文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全局配置 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vrrp虚拟路由冗余协议 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virtual_server虚拟服务{real_server} 多个")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主机贵 备机便宜")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器多个网卡")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证id的对应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先级")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 权限")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# virtual_ipaddress VIP IP漂移")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("man")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" keepalived.conf "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看5类帮助文件")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" ./keepalived.conf root@node04:"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 远程拷贝")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" keepalived start\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("blockquote",[t("p",[s._v("LVS 没有数据备份的问题, 主机恢复后可以作为Master")]),s._v(" "),t("p",[s._v("所有操作对用户来说都是透明的")])]),s._v(" "),t("h4",{attrs:{id:"问题-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题-2"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),t("blockquote",[t("p",[s._v("程序异常退出, 没有收回 VIP 和 LVS 配置 备机网卡也会出现 VIP")]),s._v(" "),t("p",[s._v("三次握手或四次挥手会负载到不同服务器, 发送的数据包会丢包")]),s._v(" "),t("p",[s._v("单兵作战")])])])}),[],!1,null,null,null);a.default=r.exports}}]);