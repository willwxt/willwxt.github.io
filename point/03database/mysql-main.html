<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql总结 | SUCKED BloG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.42575a28.js" as="script"><link rel="preload" href="/assets/js/2.0d7d09b8.js" as="script"><link rel="preload" href="/assets/js/39.10801a2a.js" as="script"><link rel="prefetch" href="/assets/js/10.1a30ebe5.js"><link rel="prefetch" href="/assets/js/100.022f696a.js"><link rel="prefetch" href="/assets/js/101.06eb0acb.js"><link rel="prefetch" href="/assets/js/102.e944c220.js"><link rel="prefetch" href="/assets/js/103.45b9da9a.js"><link rel="prefetch" href="/assets/js/104.cf53f5d1.js"><link rel="prefetch" href="/assets/js/105.200d7fe5.js"><link rel="prefetch" href="/assets/js/106.a0cc3502.js"><link rel="prefetch" href="/assets/js/107.4a71d17e.js"><link rel="prefetch" href="/assets/js/108.d7a39a75.js"><link rel="prefetch" href="/assets/js/109.35619cf9.js"><link rel="prefetch" href="/assets/js/11.f78ae8b3.js"><link rel="prefetch" href="/assets/js/110.f667d72e.js"><link rel="prefetch" href="/assets/js/111.de83ce6f.js"><link rel="prefetch" href="/assets/js/112.417d40bf.js"><link rel="prefetch" href="/assets/js/113.0f26c1ca.js"><link rel="prefetch" href="/assets/js/114.c7014acb.js"><link rel="prefetch" href="/assets/js/115.b502c0f1.js"><link rel="prefetch" href="/assets/js/116.10fb230e.js"><link rel="prefetch" href="/assets/js/117.f7cb9e2a.js"><link rel="prefetch" href="/assets/js/118.978d3075.js"><link rel="prefetch" href="/assets/js/119.09272191.js"><link rel="prefetch" href="/assets/js/12.140aa2af.js"><link rel="prefetch" href="/assets/js/120.32b5dbd7.js"><link rel="prefetch" href="/assets/js/121.8d618bbb.js"><link rel="prefetch" href="/assets/js/122.dcd4190d.js"><link rel="prefetch" href="/assets/js/123.2ee061d1.js"><link rel="prefetch" href="/assets/js/124.5a3760a7.js"><link rel="prefetch" href="/assets/js/125.a874a4bc.js"><link rel="prefetch" href="/assets/js/126.c6c6b7e6.js"><link rel="prefetch" href="/assets/js/127.38c35051.js"><link rel="prefetch" href="/assets/js/128.8d775ac8.js"><link rel="prefetch" href="/assets/js/129.6100ddb1.js"><link rel="prefetch" href="/assets/js/13.b2a6e590.js"><link rel="prefetch" href="/assets/js/130.9a83da2a.js"><link rel="prefetch" href="/assets/js/131.22de7670.js"><link rel="prefetch" href="/assets/js/132.f88798bf.js"><link rel="prefetch" href="/assets/js/133.925bbfed.js"><link rel="prefetch" href="/assets/js/134.481fad71.js"><link rel="prefetch" href="/assets/js/135.c3efb09b.js"><link rel="prefetch" href="/assets/js/136.758c447a.js"><link rel="prefetch" href="/assets/js/137.dcde1032.js"><link rel="prefetch" href="/assets/js/138.616a346b.js"><link rel="prefetch" href="/assets/js/139.b58dd07f.js"><link rel="prefetch" href="/assets/js/14.15374560.js"><link rel="prefetch" href="/assets/js/140.62b4c7ea.js"><link rel="prefetch" href="/assets/js/15.ffd155fa.js"><link rel="prefetch" href="/assets/js/16.feb1b022.js"><link rel="prefetch" href="/assets/js/17.6d491eb6.js"><link rel="prefetch" href="/assets/js/18.03ddaa95.js"><link rel="prefetch" href="/assets/js/19.021bbcc8.js"><link rel="prefetch" href="/assets/js/20.8aa708b0.js"><link rel="prefetch" href="/assets/js/21.59d7a21e.js"><link rel="prefetch" href="/assets/js/22.21597439.js"><link rel="prefetch" href="/assets/js/23.77303f0b.js"><link rel="prefetch" href="/assets/js/24.0789ed5b.js"><link rel="prefetch" href="/assets/js/25.244a12a8.js"><link rel="prefetch" href="/assets/js/26.a6ee95e4.js"><link rel="prefetch" href="/assets/js/27.9e0f0e9d.js"><link rel="prefetch" href="/assets/js/28.189031c5.js"><link rel="prefetch" href="/assets/js/29.b3100d33.js"><link rel="prefetch" href="/assets/js/3.2a5d4cd5.js"><link rel="prefetch" href="/assets/js/30.fe8fe8c0.js"><link rel="prefetch" href="/assets/js/31.86fec3f7.js"><link rel="prefetch" href="/assets/js/32.24cac061.js"><link rel="prefetch" href="/assets/js/33.f1db2ed0.js"><link rel="prefetch" href="/assets/js/34.c220692f.js"><link rel="prefetch" href="/assets/js/35.9e7b4779.js"><link rel="prefetch" href="/assets/js/36.0cb1d1bc.js"><link rel="prefetch" href="/assets/js/37.7d1fcf79.js"><link rel="prefetch" href="/assets/js/38.bc9bc4b3.js"><link rel="prefetch" href="/assets/js/4.b4d9a5aa.js"><link rel="prefetch" href="/assets/js/40.c980543d.js"><link rel="prefetch" href="/assets/js/41.3f4581d8.js"><link rel="prefetch" href="/assets/js/42.60b85cdf.js"><link rel="prefetch" href="/assets/js/43.1338528d.js"><link rel="prefetch" href="/assets/js/44.786fc51f.js"><link rel="prefetch" href="/assets/js/45.d65f6744.js"><link rel="prefetch" href="/assets/js/46.543c2b26.js"><link rel="prefetch" href="/assets/js/47.59f19ed2.js"><link rel="prefetch" href="/assets/js/48.60de6b25.js"><link rel="prefetch" href="/assets/js/49.f3df62ef.js"><link rel="prefetch" href="/assets/js/5.013522c1.js"><link rel="prefetch" href="/assets/js/50.fd9871d6.js"><link rel="prefetch" href="/assets/js/51.1fb1863e.js"><link rel="prefetch" href="/assets/js/52.c06ce3f3.js"><link rel="prefetch" href="/assets/js/53.a3d55203.js"><link rel="prefetch" href="/assets/js/54.89ac64bc.js"><link rel="prefetch" href="/assets/js/55.ccf38d1e.js"><link rel="prefetch" href="/assets/js/56.ffb8595b.js"><link rel="prefetch" href="/assets/js/57.5f1bd695.js"><link rel="prefetch" href="/assets/js/58.7463616d.js"><link rel="prefetch" href="/assets/js/59.ea4eb5dd.js"><link rel="prefetch" href="/assets/js/6.72ad7c85.js"><link rel="prefetch" href="/assets/js/60.a2add219.js"><link rel="prefetch" href="/assets/js/61.3eae0362.js"><link rel="prefetch" href="/assets/js/62.801d1658.js"><link rel="prefetch" href="/assets/js/63.b47a17bb.js"><link rel="prefetch" href="/assets/js/64.d5e2bdea.js"><link rel="prefetch" href="/assets/js/65.24d540f4.js"><link rel="prefetch" href="/assets/js/66.09a1ae52.js"><link rel="prefetch" href="/assets/js/67.75bd38e7.js"><link rel="prefetch" href="/assets/js/68.1fe6956e.js"><link rel="prefetch" href="/assets/js/69.d3306c2d.js"><link rel="prefetch" href="/assets/js/7.60760bb7.js"><link rel="prefetch" href="/assets/js/70.95aa4503.js"><link rel="prefetch" href="/assets/js/71.7065ebf0.js"><link rel="prefetch" href="/assets/js/72.55ae5081.js"><link rel="prefetch" href="/assets/js/73.c7624eee.js"><link rel="prefetch" href="/assets/js/74.63bcc7bd.js"><link rel="prefetch" href="/assets/js/75.e2731e20.js"><link rel="prefetch" href="/assets/js/76.1711af80.js"><link rel="prefetch" href="/assets/js/77.f1c4e2d3.js"><link rel="prefetch" href="/assets/js/78.900bc856.js"><link rel="prefetch" href="/assets/js/79.a1b8c47b.js"><link rel="prefetch" href="/assets/js/8.0c261cf2.js"><link rel="prefetch" href="/assets/js/80.7cf435bf.js"><link rel="prefetch" href="/assets/js/81.fa33b2af.js"><link rel="prefetch" href="/assets/js/82.cdabd386.js"><link rel="prefetch" href="/assets/js/83.879fc50c.js"><link rel="prefetch" href="/assets/js/84.7e460788.js"><link rel="prefetch" href="/assets/js/85.339356d5.js"><link rel="prefetch" href="/assets/js/86.d526418c.js"><link rel="prefetch" href="/assets/js/87.12877e38.js"><link rel="prefetch" href="/assets/js/88.d5a7d193.js"><link rel="prefetch" href="/assets/js/89.2f4a62c2.js"><link rel="prefetch" href="/assets/js/9.50eda380.js"><link rel="prefetch" href="/assets/js/90.6d83f5bf.js"><link rel="prefetch" href="/assets/js/91.f3364825.js"><link rel="prefetch" href="/assets/js/92.158fcc7a.js"><link rel="prefetch" href="/assets/js/93.0c4e5f88.js"><link rel="prefetch" href="/assets/js/94.c5725f80.js"><link rel="prefetch" href="/assets/js/95.dc61d501.js"><link rel="prefetch" href="/assets/js/96.3a598fc5.js"><link rel="prefetch" href="/assets/js/97.712aa8be.js"><link rel="prefetch" href="/assets/js/98.e757fe7a.js"><link rel="prefetch" href="/assets/js/99.1418024a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SUCKED BloG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>mysql总结</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/point/03database/mysql-main.html#一-mysql架构" class="sidebar-link">一. mysql架构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/03database/mysql-main.html#二-存储引擎" class="sidebar-link">二. 存储引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#存储引擎对比" class="sidebar-link">存储引擎对比</a></li></ul></li><li><a href="/point/03database/mysql-main.html#三-数据类型" class="sidebar-link">三. 数据类型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/03database/mysql-main.html#四-索引" class="sidebar-link">四. 索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#索引优缺点" class="sidebar-link">索引优缺点</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#mysql索引分类" class="sidebar-link">MySQL索引分类</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#mysql索引结构" class="sidebar-link">MySQL索引结构</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#b-索引" class="sidebar-link">B+索引</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#索引失效-建索引的原则-索引优化" class="sidebar-link">索引失效 / 建索引的原则 / 索引优化</a></li></ul></li><li><a href="/point/03database/mysql-main.html#五-mysql查询" class="sidebar-link">五. MySQL查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#join图" class="sidebar-link">JOIN图</a></li></ul></li><li><a href="/point/03database/mysql-main.html#六-mysql事务" class="sidebar-link">六. MySQL事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#事务隔离级别及其实现" class="sidebar-link">事务隔离级别及其实现</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#undo-log-保证事务的原子性-mvcc" class="sidebar-link">undo log, 保证事务的原子性, MVCC</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#事务开启-事务提交" class="sidebar-link">事务开启 &amp; 事务提交</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#innodb分布式事务支持-xa事务" class="sidebar-link">InnoDB分布式事务支持: XA事务</a></li></ul></li><li><a href="/point/03database/mysql-main.html#七-锁机制" class="sidebar-link">七. 锁机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#锁的分类" class="sidebar-link">锁的分类</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#锁的三种模式" class="sidebar-link">锁的三种模式</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#死锁" class="sidebar-link">死锁</a></li></ul></li><li><a href="/point/03database/mysql-main.html#八-mysql调优" class="sidebar-link">八. MySQL调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#mysql常见性能分析手段" class="sidebar-link">MySQL常见性能分析手段</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#explain执行计划" class="sidebar-link">explain执行计划</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#慢查询日志" class="sidebar-link">慢查询日志</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#show-profile-分析查询" class="sidebar-link">show profile 分析查询</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#性能优化-sql优化" class="sidebar-link">性能优化, sql优化</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#服务器参数配置" class="sidebar-link">服务器参数配置</a></li></ul></li><li><a href="/point/03database/mysql-main.html#九-主从复制-分库分表" class="sidebar-link">九. 主从复制 + 分库分表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#主从集群概述" class="sidebar-link">主从集群概述</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#分库分表" class="sidebar-link">分库分表</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#shardingsphere" class="sidebar-link">ShardingSphere</a></li><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#核心概念" class="sidebar-link">核心概念</a></li></ul></li><li><a href="/point/03database/mysql-main.html#其他" class="sidebar-link">其他</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/03database/mysql-main.html#sql基础问题" class="sidebar-link">SQL基础问题</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql总结"><a href="#mysql总结" class="header-anchor">#</a> mysql总结</h1> <p><a href="https://zhuanlan.zhihu.com/p/164519371" target="_blank" rel="noopener noreferrer">参考链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>目录
MySQL
	MySQL架构
	存储引擎
	数据类型
	索引
	SQL
	事务
	锁机制
	性能优化
	分库分表分区
	主从复制
	其他问题
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="一-mysql架构"><a href="#一-mysql架构" class="header-anchor">#</a> 一. mysql架构</h2> <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj0sffrl6ij30t30gqdlf.jpg" alt=""></p> <p>与其他数据库相比: 插件式的存储引擎架构, 查询处理和数据存储分离</p> <ul><li>连接层: 管理连接, 授权验证</li> <li>服务层: 负责大部分核心功能
<ul><li>解析器, 分析器, 优化器, 执行器, 缓存, 所有内置函数</li> <li>触发器, 存储过程, 视图</li> <li>RBO基于规则的优化器; CBO基于成本的优化器</li></ul></li> <li>引擎层: 负责MySQL中数据的存储和读取</li> <li>存储层: 将数据存储运行于当前设备的文件系统之上, 提供读写API</li></ul> <blockquote><p>面试官: 画出MySQL架构 / MySQL查询流程? / SQL语句执行顺序?</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>client -- 连接器(鉴权,建立连接) -- 查询缓存 -- 分析器(语法分析) 
 -- 优化器(选择最优执行方案)
 -- 执行器(检查执行权限,实际执行SQL) -- 去引擎层读取数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://pic2.zhimg.com/80/v2-0d2070e8f84c4801adbfa03bda1f98d9_720w.jpg" alt="img"></p> <blockquote><p>msg: MySQL有哪些存储引擎? 区别?</p></blockquote> <h2 id="二-存储引擎"><a href="#二-存储引擎" class="header-anchor">#</a> 二. 存储引擎</h2> <p>一个数据库中的不同表可以使用不同引擎以满足需求, 不同引擎提供不同的存储机制, 锁, 索引</p> <p>(MySQL服务器使用可插拔的存储引擎, 可以加载或卸载)</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span><span class="token comment">-- 查看存储引擎</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'storage_engine'</span><span class="token punctuation">;</span><span class="token comment">-- 查看默认存储引擎</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span>tablename<span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token comment">-- 查看具体某一个表所使用的存储引擎</span>
<span class="token comment">-- 准确查看某个数据库中的某一表所使用的存储引擎</span>
<span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'&lt;tablename&gt;'</span><span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token keyword">FROM</span> <span class="token keyword">DATABASE</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'&lt;tablename&gt;'</span><span class="token punctuation">;</span>
<span class="token comment">-- 设置存储引擎</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t1 <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> t1 <span class="token keyword">ENGINE</span> <span class="token operator">=</span> CSV<span class="token punctuation">;</span>
<span class="token comment">-- 修改默认存储引擎 , 也可以在配置文件my.cnf中修改默认引擎</span>
<span class="token keyword">SET</span> default_storage_engine<span class="token operator">=</span>NDBCLUSTER<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="存储引擎对比"><a href="#存储引擎对比" class="header-anchor">#</a> 存储引擎对比</h3> <p>常见存储引擎: InnoDB(默认), MyISAM, Memory, NDB;</p> <h4 id="文件存储结构对比"><a href="#文件存储结构对比" class="header-anchor">#</a> 文件存储结构对比</h4> <ul><li>frm文件: 对应在MySQL中建立的一张表, 存储表的元数据信息, 结构定义信息</li> <li>MyISAM:
<ul><li>MYD(MyData)文件: 存储表数据</li> <li>MYI(MyIndex)文件: 存储索引</li></ul></li> <li>InnoDB:
<ul><li>ibd文件: 独享表空间使用, 每个表一个ibd文件</li> <li>ibdata文件: 共享表空间, 所有表共用一个ibdata文件</li></ul></li></ul> <h4 id="innodb与myisam对比"><a href="#innodb与myisam对比" class="header-anchor">#</a> InnoDB与MyISAM对比</h4> <ol><li>InnoDB支持事务, 外键, 行锁, MyISAM不支持</li> <li>InnoDB是聚簇索引: 数据存放在主键索引的叶子节点上, 所以必须有主键; 辅助索引比主键索引多了回表, 效率会差些; 主键太大会导致其他索引也很大; MyISAM是非聚簇索引, 主键索引和辅助索引是独立的</li> <li>InnoDB不保存表的具体行数, COUNT(1) 需要全表扫描, 而MyISAM用一个变量保存了整个表的行数, COUNT(1)很快</li> <li>锁粒度: InnoDB锁粒度最小是行锁, MyISAM是表锁</li></ol> <blockquote><p>msg: 一张表id(自增主键), 插入17条记录后, 删除15, 16, 17条记录, 重启MySQL后插入的新纪录id是多少?</p></blockquote> <ul><li>MyISAM是18, 因为会把自增主键的最大ID 记录到数据文件中</li> <li>InnoDB是15, 只记录到内存中, 重启导致最大ID丢失</li></ul> <blockquote><p>哪个存储引擎SELECT COUNT(1)更快?  -- 显然MyISAM更快</p></blockquote> <ul><li>InnoDB需要把所有数据读出来进行累加计算; 由于MVCC的原因, InnoDB应该返回多少行是不确定的, 所以不能像MyISAM那样准确记录行数</li></ul> <h2 id="三-数据类型"><a href="#三-数据类型" class="header-anchor">#</a> 三. 数据类型</h2> <p>包括五大类: 整型, 浮点, 字符串, 日期, 其他(ENUM, SET...)</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">TINYINT</span> <span class="token number">1</span>byte <span class="token operator">-</span><span class="token number">128</span><span class="token operator">~</span><span class="token number">127</span>
<span class="token keyword">SMALLINT</span> <span class="token number">2</span>bytes<span class="token punctuation">;</span>  <span class="token keyword">MEDIUMINT</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">INT</span><span class="token operator">/</span><span class="token keyword">INTEGER</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token keyword">BIGINT</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">FLOAT</span> <span class="token number">4</span> 单精度<span class="token punctuation">;</span> <span class="token keyword">DOUBLE</span> <span class="token number">8</span> 双精度<span class="token punctuation">;</span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span>D<span class="token punctuation">)</span> 取决于M和D<span class="token punctuation">;</span>

<span class="token keyword">DATE</span> <span class="token number">3</span>bytes <span class="token number">1000</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">/</span><span class="token number">9999</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> YYYY<span class="token operator">-</span>MM<span class="token operator">-</span>DD
<span class="token keyword">TIME</span> <span class="token number">3</span> <span class="token string">'-838:59:59'</span><span class="token operator">/</span><span class="token string">'838:59:59'</span> HH:MM:SS 时间或持续时间
<span class="token keyword">YEAR</span> <span class="token number">1</span> <span class="token number">1901</span><span class="token operator">/</span><span class="token number">2155</span>YYYY年份
<span class="token keyword">DATETIME</span> <span class="token number">8</span> <span class="token number">1001</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">/</span><span class="token number">9999</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">23</span>:<span class="token number">59</span>:<span class="token number">59</span> YYYY<span class="token operator">-</span>MM<span class="token operator">-</span>DD HH:MM:SS混合日期和时间
<span class="token keyword">TIMESTAMP</span> <span class="token number">4</span> <span class="token number">1970</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span><span class="token operator">/</span><span class="token number">2038</span> 结束时间是maxint秒<span class="token punctuation">,</span>到<span class="token number">2038</span>年 YYYYMMDD HHMMSS 时间戳

<span class="token keyword">CHAR</span> <span class="token number">0</span><span class="token operator">-</span><span class="token number">255</span> 定长字符串
<span class="token keyword">VARCHAR</span> <span class="token number">0</span><span class="token operator">-</span><span class="token number">65535</span> 变长字符串
<span class="token keyword">BLOB</span><span class="token operator">/</span><span class="token keyword">TEXT</span> <span class="token number">0</span><span class="token operator">-</span><span class="token number">65535</span> 二进制形式<span class="token operator">/</span>文本数据
<span class="token keyword">MEDIUMBLOB</span><span class="token operator">/</span><span class="token keyword">TEXT</span><span class="token punctuation">,</span> <span class="token keyword">LONGBLOB</span><span class="token operator">/</span><span class="token keyword">TEXT</span><span class="token punctuation">,</span> <span class="token keyword">TINYBLOB</span><span class="token operator">/</span><span class="token keyword">TEXT</span>

以及其他数据类型
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>msg: CHAR和VARCHAR的区别是?</p></blockquote> <ul><li>CHAR是固定长度(不论存储什么占用固定字节), VARCHAR是可变长度(占用实际字节空间加上长度符号位)</li> <li>存储上限不一样: 255 和 65535</li> <li>CAHR会截断尾部的空格, 适合存储较短, 长度固定的字符串, 例如用户密码的MD5值</li></ul> <blockquote><p>msg: 字符串类型可以是什么?</p></blockquote> <p>SET, BLOB, ENUM, CHAR, VARCHAR, TEXT</p> <blockquote><p>BLOB 和 TEXT的区别是什么?</p></blockquote> <ul><li>BLOB是一个二进制对象, 可以容纳可变数量的数据, 用于保存二进制数据</li> <li>TEXT是一个不区分大小写的BLOB, 用于保存字符串数据</li></ul> <h2 id="四-索引"><a href="#四-索引" class="header-anchor">#</a> 四. 索引</h2> <blockquote><p>msg: 说说你对索引的理解?</p> <p>为什么索引底层要用B+树, 为什么不用hash, B树?</p> <p>聚簇索引和非聚簇索引的区别? 叶子节点存放的是数据还是数据的内存地址?</p> <p>InnoDB引擎中的索引策略了解过吗?</p> <p>创建索引的方式有哪些?</p> <p>使用索引需要注意什么地方?</p></blockquote> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>索引本质上是一种数据结构, 可以帮助MySQL高效获取数据;</p> <ul><li>为了加快某一列的数据查找, 我们可以维护一个搜索树, 树的每个节点存放键值以及指向该行数据的索引, 我们可以通过树的特性快速查找到该行数据</li> <li>索引本身也很大, 一般以文件形式存储在磁盘上</li> <li>一般索引都是B+树结构(包括聚簇索引,次要索引,覆盖索引,前缀索引,唯一索引)</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 索引基本语法</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>indexname<span class="token operator">&gt;</span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">column</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 创建索引</span>
<span class="token comment">-- 如果是CHAR, VARCHAR类型, length可以小于数字段实际长度, 而BLOB和TEXT必须指定长度</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">&gt;</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>indexname<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>columnn<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 修改</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> <span class="token operator">&lt;</span>indexname<span class="token operator">&gt;</span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>		<span class="token comment">-- 删除</span>
<span class="token comment">-- 小知识: 大数据表删除时可以先删索引, 再删数据, 再创建索引</span>
<span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> <span class="token operator">&lt;</span><span class="token keyword">table</span><span class="token operator">&gt;</span>\G<span class="token punctuation">;</span>				<span class="token comment">-- 查看索引信息</span>
<span class="token comment">-- ALTER TABLE &lt;table&gt;命令详细使用 ADD PRIMARY KEY (&lt;column&gt;)</span>
<span class="token comment">-- ADD UNIQUE/INDEX/FULLTEXT &lt;indexname&gt; (&lt;column&gt;); 唯一索引,普通索引,全文索引, 可以多个column创建联合索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="索引优缺点"><a href="#索引优缺点" class="header-anchor">#</a> 索引优缺点</h3> <ul><li>提高数据检索效率, 降低IO, 降低排序成本</li> <li>索引也是一张表, 需要占用硬盘/内存</li> <li>虽然提高了查询速度, 但是修改一些数据需要同步到索引文件, 降低了增删改效率</li> <li>对于频繁更新, 重复内容, 非常小的表, 索引没啥用</li></ul> <h3 id="mysql索引分类"><a href="#mysql索引分类" class="header-anchor">#</a> MySQL索引分类</h3> <h4 id="数据结构角度"><a href="#数据结构角度" class="header-anchor">#</a> 数据结构角度</h4> <p>B+树索引, Hash索引, FullText全文索引, R-Tree索引</p> <h4 id="物理存储角度"><a href="#物理存储角度" class="header-anchor">#</a> 物理存储角度</h4> <p>聚簇索引和非聚簇索引(辅助索引,次要索引)</p> <h4 id="逻辑角度"><a href="#逻辑角度" class="header-anchor">#</a> 逻辑角度</h4> <ul><li>主键索引: 特殊的索引, 不允许空值</li> <li>普通索引/单列索引/二级索引 <a href="http://mysql.taobao.org/monthly/2020/01/01/" target="_blank" rel="noopener noreferrer">二级索引分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>联合索引/复合索引/多列索引: 多个字段, 遵循最左匹配原则</li> <li>唯一索引</li> <li>空间索引: 对空间数据类型建立的索引, 必须非空, 必须MyISAM</li></ul> <h3 id="mysql索引结构"><a href="#mysql索引结构" class="header-anchor">#</a> MySQL索引结构</h3> <p>首先索引是在存储引擎层实现的, 不是所有的存储引擎都支持某些索引类型, 即便支持其实现和行为也可能有所差别</p> <h4 id="前置知识"><a href="#前置知识" class="header-anchor">#</a> 前置知识</h4> <ol><li>磁盘存储是以扇区为单位(如:512bytes, 无法更改)</li> <li>文件系统以 块(IO Block) 为单位进行管理, 一般为4K(连续的扇区, 可设置)
<ul><li>所以即便创建一个文件只有少量数据, 也会占用 4K</li></ul></li> <li>磁盘预读以及局部性原理
<ul><li>被查询过的数据可能很快被再次查询</li> <li>程序与数据往往有聚集的倾向, 一段时间内可能只访问一部分的数据</li> <li>磁盘预读是基于上述两点, 一次读取一页(数个块)到内存中(一次读取视为一次IO操作)</li> <li>InnoDB中一次读取的页为 16k</li></ul></li> <li>内存操作是以页(page)为单位, 一般为4k</li></ol> <h3 id="b-索引"><a href="#b-索引" class="header-anchor">#</a> B+索引</h3> <p><a href="http://mysql.taobao.org/monthly/2018/09/01/" target="_blank" rel="noopener noreferrer">B+树并发控制机制的前世今生<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2018/11/01/" target="_blank" rel="noopener noreferrer">敢问路在何方~论B+树索引的演进方向(上)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>MyISAM和InnoDB存储引擎均使用B+树实现</p> <p>二叉树: 常用的数据结构</p> <p>BST二叉查找树: 通过保证左子树所有节点小于根节点, 右子树所有节点大于根节点, 达到Ologn的最好查找效率, 但是可能会退化成链表O(n)效率</p> <p>AVL树: 自平衡二叉查找树, 借助多次旋转实现树平衡; 追求完全平衡, 插入和删除旋转次数较多</p> <p><strong>红黑树</strong>: 不追求完全平衡+变色, 从而降低旋转次数(插入最多2次, 删除3次), 总体性能高于AVL</p> <p>以上都有深度过深问题</p> <p><strong>B-树</strong>: 平衡多路查找树,M阶B树每个节点最多M个孩子, 可存储ceil(m/2)-1到m-1个关键字, 使树的结构更加扁平, 减少了IO次数</p> <p><strong>B+树</strong>: 非叶子节点不再存放数据, 所有数据按照顺序存放在同一层叶子节点; 每个节点可以存入更多关键字(索引字段字节尽量小); 所有叶子节点之间通过双向指针链接, 优化了范围查找/顺序查找的效率</p> <p><strong>树的分裂</strong>: B树分裂将原节点数据分布到(原节点,父亲,兄弟节点),可能导致高度增加; B+树分裂是分配原节点一半的数据到新增的节点中; B*树分裂是通过指针找到兄弟节点分摊,等兄弟节点和自己都满,创建新节点均摊1/3数据</p> <h4 id="myisam主键索引与辅助索引的结构"><a href="#myisam主键索引与辅助索引的结构" class="header-anchor">#</a> MyISAM主键索引与辅助索引的结构</h4> <p>MyISAM中数据文件与索引文件是分离的(非聚簇索引), 索引文件中的B+树叶子节点存放的是数据记录的地址(数据物理地址的偏移量)</p> <p><strong>查找流程:</strong> 从索引文件的根节点开始一直到对应叶子节点进行读取, 然后根据文件指针读取目标数据</p> <h4 id="innodb主键索引与辅助索引结构"><a href="#innodb主键索引与辅助索引结构" class="header-anchor">#</a> InnoDB主键索引与辅助索引结构</h4> <p>InnoDB索引结构的叶子节点就是实际的数据记录(主键索引), 而辅助索引的叶子节点存储的是主键, 显然主键是必须的(若不指定, MySQL会自动创建隐式索引6字节整型ROWID)</p> <p><strong>主键选择</strong>: 推荐使用代理主键(业务无关, 更易于维护)</p> <p><strong>回表</strong>: 辅助索引先查找到主键, 再根据主键索引查找到目标数据</p> <blockquote><p>msg: 为什么用自增整型而不是用UUID作为主键?</p></blockquote> <ul><li>UUID是字符串, 消耗更多存储空间, 同时整型equals比字符串更快</li> <li>自增的主键索引在磁盘中连续存储, 而UUID是随机生成, 可能导致数据结构的重构, 页分裂等</li></ul> <blockquote><p>msg: 为什么非主键索引结构叶子节点存储主键</p></blockquote> <p>保证数据一致性, 节省存储空间; 一些场景下的更新, 可以避免索引文件的修改</p> <blockquote><p>msg:</p> <p>为什么用B+树, 不用B树? 为什么不用Hash?</p> <p>为什么建议自增列作为主键?</p></blockquote> <ol><li>首先主键索引底层实现为B+树, 数据都存放在叶子节点, 叶子节点则是顺序存放的</li> <li>一个叶子节点作为一页存放, 插入数据过程中, 若该页数据大小超过阈值, 则会开辟一个新的页</li> <li>如果是自增的主键, 只需要在后续位置开辟新的页即可</li> <li>如果是随机的主键, 可能需要在中间某个位置新维护一页, 需要进行数据移动(增加了额外开销), 甚至导致碎片空间(索引结构不够紧凑, 后续需要OPTIMIZE TABLE重建表)</li></ol> <h4 id="页分裂"><a href="#页分裂" class="header-anchor">#</a> 页分裂</h4> <p>简单而言, 自增主键会使得添加数据的时候其他数据不用动, 而不规则的数据会导致改变之前的数据结构, 从而导致页分裂: 降低插入效率, 导致碎片空间(需要页合并)</p> <h4 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h4> <p>覆盖索引, 或索引覆盖, 也即平时所说的不需要回表操作</p> <ul><li>查询的数据只用从索引中就可以取得, 不需要读数据行</li> <li><strong>判断标准</strong>: 使用explain, 输出的extra列显示为using index</li></ul> <h4 id="索引下推-谓词下推-icp-index-condition-pushdown"><a href="#索引下推-谓词下推-icp-index-condition-pushdown" class="header-anchor">#</a> 索引下推 / 谓词下推 ICP (index condition pushdown)</h4> <p>MySQL5.6推出, 是在非主键索引(且是联合索引)上的优化 <a href="http://mysql.taobao.org/monthly/2015/03/05/" target="_blank" rel="noopener noreferrer">进一步了解ICP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>不使用ICP: 只通过最左索引查出数据返回MySQL服务器, 再判断其他条件</li> <li>使用ICP: 直接判断所有联合索引的条件, 可能返回的数据都减少了, 再判断其他条件
<ul><li>减少了数据复制, 减少了回表次数, 如果加锁,可以减少记录锁的个数</li> <li>如果是主键索引, 或者谓词不能有效过滤, 效果较差; 不支持多表update和delete;</li></ul></li> <li><strong>判断标准</strong>: explain后, extra结果为using index condition</li></ul> <h4 id="索引合并-index-merge"><a href="#索引合并-index-merge" class="header-anchor">#</a> 索引合并 (index merge)</h4> <p>查询条件中涉及多个索引字段的 and 或 or, 可能会使用到index merge, 先通过多个索引各自查询结果, 再进行合并 (MySQL5.1开始支持)</p> <p><a href="https://www.cnblogs.com/digdeep/p/4975977.html" target="_blank" rel="noopener noreferrer">索引合并的进一步参考资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="最左匹配-最左前缀"><a href="#最左匹配-最左前缀" class="header-anchor">#</a> 最左匹配, 最左前缀</h4> <ul><li>联合索引中只有存在最左的索引列作为查询条件才能生效,</li> <li>最左前缀匹配原则, 一直向右匹配直到遇到范围查询(&gt;, &lt;, between, like)就停止匹配</li> <li>比如a=1 and b=2 and c&gt;3 and d=4 如果建立(a,b,c,d)顺序的索引, d是用不到索引的;  如果建立(a,b,d,c)的索引则都可以用到</li></ul> <h3 id="索引失效-建索引的原则-索引优化"><a href="#索引失效-建索引的原则-索引优化" class="header-anchor">#</a> 索引失效 / 建索引的原则 / 索引优化</h3> <p><a href="http://mysql.taobao.org/monthly/2017/03/03/" target="_blank" rel="noopener noreferrer">MySQL常见SQL错误用法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>组合索引左边索引可以使用范围查询, 但会导致后续右边索引失效</li> <li>不要让索引参与任何计算, 函数, 类型转换操作(字符类型未加单引号导致隐式转换)</li> <li>尽量使用主键索引(避免回表)</li> <li>is null 和 is not null 无法使用索引</li> <li>like语句以%开头</li> <li>选用区分度高的列, 一般保持比例 <code>count(distinct col)/count(*)&gt;0.1</code></li> <li>单表索引数量控制5个以内</li></ol> <h4 id="哪些情况需要创建索引-不需要创建索引"><a href="#哪些情况需要创建索引-不需要创建索引" class="header-anchor">#</a> 哪些情况需要创建索引/ 不需要创建索引</h4> <p>需要</p> <ol><li>频繁作为查询条件的字段</li> <li>查询中与其他表关联的字段 , 外键关系建立索引</li> <li>单键/组合索引的选择问题 , 高并发下倾向创建组合索引</li> <li>查询中排序的字段 , 排序字段通过索引访问大幅提高排序速度</li> <li>查询中统计或分组字段</li></ol> <p>不需要</p> <ol><li>表记录太少</li> <li>经常增删改的表</li> <li>没有区分度的字段</li> <li>频繁更新的字段不适合创建索引 (会加重IO负担)</li> <li>where条件里用不到的字段</li></ol> <h4 id="索引的一般性建议"><a href="#索引的一般性建议" class="header-anchor">#</a> 索引的一般性建议</h4> <ul><li>对于单键索引, 尽量选择针对当前query过滤性更好的索引</li> <li>在选择组合索引的时候, 当前Query中过滤性最好的字段在索引字段顺序中, 位置越靠前越好。</li> <li>在选择组合索引的时候, 尽量选择可以能够包含当前query中的where字句中更多字段的索引</li> <li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li> <li>少用Hint强制索引</li></ul> <h4 id="索引监控"><a href="#索引监控" class="header-anchor">#</a> 索引监控</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Handler_read%'</span><span class="token punctuation">;</span> <span class="token comment">-- Handler_read_key 走索引次数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="混个眼熟"><a href="#混个眼熟" class="header-anchor">#</a> 混个眼熟</h4> <p><a href="http://mysql.taobao.org/monthly/2019/03/07/" target="_blank" rel="noopener noreferrer">MySQL8.0 Descending Index<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2019/05/06/" target="_blank" rel="noopener noreferrer">MySQL8.0 Skip Scan Range<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>Hash索引, Memory存储引擎支持
<ul><li>通过计算hashcode(直接定址法, 平方取中, 折叠法, 取余, 随机数法), 将记录转换成定长的Hash值, 和行数据指针一起存储到表中; 若值相同则下拉链表;</li> <li>不能排序, 不能范围查询, hash冲突;</li> <li>使用CRC32循环冗余校验Cyclic Redundancy Check</li> <li>innodb存储引擎支持自适应hash</li></ul></li> <li>FullText全文索引 <a href="http://mysql.taobao.org/monthly/2015/10/01/" target="_blank" rel="noopener noreferrer">全文索引进一步了解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>用于全文索引, MyISAM提供, InnoDB自5.6版本开始提供</li> <li>用于替代效率低下的like模糊匹配, 可以多字段组合一次性全模糊匹配多个字段</li></ul></li> <li>R树空间索引, 特殊索引, 用于地理空间数据类型</li> <li>OLTP: 在线事务, 很短时间内返回结果</li> <li>OLAP: 对历史数据进行分析 --- 数据仓库</li></ul> <h2 id="五-mysql查询"><a href="#五-mysql查询" class="header-anchor">#</a> 五. MySQL查询</h2> <blockquote><p>msg: count(*) 和 count(1) 的区别?</p></blockquote> <blockquote><p>msg: MySQL中in和exist的区别?</p></blockquote> <ul><li>exists exists对外表用loop逐条查询 , 每次查询都会查看exists的条件语句 , 当exists里的条件语句能够返回记录行时 (无论记录行是的多少 , 只要能返回)  , 条件就为真 , 返回当前loop到的这条记录；反之 , 如果exists里的条件语句不能返回记录行 , 则当前loop到的这条记录被丢弃 , exists的条件就像一个bool条件 , 当能返回结果集则为true , 不能返回结果集则为false</li> <li>in in查询相当于多个or条件的叠加</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span>id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> B<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> B <span class="token keyword">WHERE</span> B<span class="token punctuation">.</span>id <span class="token operator">=</span> A<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>如果查询的两个表大小相当 , 那么用in和exists差别不大</strong>。</p> <p>如果两个表中一个较小 , 一个是大表 , 则子查询表大的用exists , 子查询表小的用in</p> <blockquote><p>msg: UNION和UNION ALL的区别?</p></blockquote> <p>UNION和UNION ALL都是将两个结果集合并为一个 , <strong>两个要联合的SQL语句 字段个数必须一样 , 而且字段类型要“相容”(一致</strong></p> <ul><li><p>UNION在进行表连接后会筛选掉重复的数据记录 (效率较低)  , 而UNION ALL则不会去掉重复的数据记录</p></li> <li><p>UNION会按照字段的顺序进行排序 , 而UNION ALL只是简单的将两个结果合并就返回</p></li></ul> <h4 id="sql执行顺序"><a href="#sql执行顺序" class="header-anchor">#</a> SQL执行顺序</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 手写</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">&gt;</span>
<span class="token keyword">FROM</span>  <span class="token operator">&lt;</span>left_table<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>join_type<span class="token operator">&gt;</span>
<span class="token keyword">JOIN</span>  <span class="token operator">&lt;</span>right_table<span class="token operator">&gt;</span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>join_condition<span class="token operator">&gt;</span>
<span class="token keyword">WHERE</span>  <span class="token operator">&lt;</span>where_condition<span class="token operator">&gt;</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  <span class="token operator">&lt;</span>group_by_list<span class="token operator">&gt;</span>
<span class="token keyword">HAVING</span> <span class="token operator">&lt;</span>having_condition<span class="token operator">&gt;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>order_by_condition<span class="token operator">&gt;</span>
<span class="token keyword">LIMIT</span> <span class="token operator">&lt;</span>limit_number<span class="token operator">&gt;</span>
<span class="token comment">-- </span>
<span class="token comment">-- 机器读取</span>
<span class="token keyword">FROM</span>  <span class="token operator">&lt;</span>left_table<span class="token operator">&gt;</span>
<span class="token keyword">ON</span> <span class="token operator">&lt;</span>join_condition<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>join_type<span class="token operator">&gt;</span> <span class="token keyword">JOIN</span>  <span class="token operator">&lt;</span>right_table<span class="token operator">&gt;</span> 
<span class="token keyword">WHERE</span>  <span class="token operator">&lt;</span>where_condition<span class="token operator">&gt;</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  <span class="token operator">&lt;</span>group_by_list<span class="token operator">&gt;</span>
<span class="token keyword">HAVING</span> <span class="token operator">&lt;</span>having_condition<span class="token operator">&gt;</span>
<span class="token keyword">SELECT</span>
<span class="token keyword">DISTINCT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">&gt;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token operator">&lt;</span>order_by_condition<span class="token operator">&gt;</span>
<span class="token keyword">LIMIT</span> <span class="token operator">&lt;</span>limit_number<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>总结</p> <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf3t8jyy81j30s2083wg2.jpg" alt="sql-parse"></p> <blockquote><p>msg: mysql 的内连接、左连接、右连接有什么区别?</p> <p>什么是内连接、外连接、交叉连接、笛卡尔积?</p></blockquote> <h3 id="join图"><a href="#join图" class="header-anchor">#</a> JOIN图</h3> <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf3t8novxpj30qu0l4wi7.jpg" alt="sql-joins"></p> <h4 id="join原理"><a href="#join原理" class="header-anchor">#</a> JOIN原理</h4> <ul><li>Simple Nested-Loop Join 简单嵌套连接, 非常简单
<ul><li>从驱动表中顺序取出数据一个个匹配被动表的所有列, 匹配完毕后合并数据</li></ul></li> <li>Index Nested-Loop Join 索引嵌套连接
<ul><li>从驱动表取出的数据会走索引查找, 主键索引最佳</li></ul></li> <li>Block Nested-Loop Join
<ul><li>在没有索引的情况下, 优先使用Block Nest-Loop Join</li> <li>额外使用一个join buffer: 将驱动表涉及join的相关列缓存进join buffer, 批量地与被动表比较, 这样减少了被动表的访问频率</li></ul></li></ul> <p><a href="http://mysql.taobao.org/monthly/2019/11/02/" target="_blank" rel="noopener noreferrer">MySQL 哈希连接实现介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="六-mysql事务"><a href="#六-mysql事务" class="header-anchor">#</a> 六. MySQL事务</h2> <blockquote><p>msg:</p> <p>事务隔离级别有? 默认的隔离级别?</p> <p>幻读脏读不可重复读?</p> <p>MySQL事务的ACID四大特性以及实现原理?</p> <p>MVCC原理?</p></blockquote> <p><a href="http://mysql.taobao.org/monthly/2015/12/01/" target="_blank" rel="noopener noreferrer">InnoDB 事务子系统介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2017/12/01/" target="_blank" rel="noopener noreferrer">InnoDB 事务系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>事务概述</strong>: 事务是一组SQL语句组成的逻辑处理单元, 具有ACID四大特性</p> <ul><li>Atomic原子性: 要么全部成功要么全部失败, 不会有中间状态 (undo log)</li> <li>Consistency一致性: 保证数据结构不被破坏 (doublewrite buffer和crash recovery) ; 在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设约束, 触发器, 级联回滚等</li> <li>Isolation隔离性: 事务之间不互相干扰, 不同时对同一目标数据做修改 (通过mvcc, 锁)</li> <li>Durability持久性: 事务结果持久化至数据库 (redo log, WAL预写日志)</li></ul> <h4 id="并发事务带来的问题"><a href="#并发事务带来的问题" class="header-anchor">#</a> 并发事务带来的问题</h4> <ul><li>更新丢失: 两个事务处理同一目标数据, 导致数据问题</li> <li>脏读: (可以读到其他未提交数据) 事务A读取到了事务B(未提交)的数据</li> <li>不可重复读: (两次相同查询不同结果) 事务B提交修改的数据, 导致事务A读取的数据前后不一致, 主要针对UPDATE, DELETE</li> <li>幻读: (之前不存在的数据突然存在了) 事务B提交插入了一些新数据行, 导致事务A范围查询中读到的记录数前后不一致;  或者说事务A先前查询没有这条数据, 但是后续插入的时候报错数据重复了; 主要针对INSERT</li></ul> <h4 id="并发解决办法"><a href="#并发解决办法" class="header-anchor">#</a> 并发解决办法</h4> <ul><li>更新丢失: 很明显需要由应用控制</li> <li>脏读, 不可重复读, 幻读: 由数据库提供的隔离机制解决
<ul><li>加锁: 对数据进行加锁, 阻止其他事务对其进行修改</li> <li>MVCC: 多版本并发控制, 不需要加锁, 通过一定机制生成数据快照, 为事务提供一致性读取的能力</li></ul></li></ul> <h3 id="事务隔离级别及其实现"><a href="#事务隔离级别及其实现" class="header-anchor">#</a> 事务隔离级别及其实现</h3> <ul><li>READ-UNCOMMITED: 一个事务可以读到另一个未提交的数据</li> <li>READ-COMMITED: 可以读到提交的数据, 没有脏读, 是大部分数据库默认的隔离级别</li> <li>REPEATABLE-READ: 同一个事务重复读取的数据保证一致, 解决了不可重复读, 可能出现幻读, 是InnoDB默认的隔离级别
<ul><li>**注意,sql标准中定义的RR是存在幻读的,但实际上mysql的RR级别不存在幻读 **</li></ul></li> <li>SERIALIZABLE: 串行化</li> <li>事务隔离机制是实现: 基于锁和MVCC</li></ul> <p>考虑业务需求+并发需求选择合适的隔离级别, 一般用默认的即可</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLE <span class="token operator">LIKE</span> <span class="token string">'tx_isolation'</span><span class="token punctuation">;</span> <span class="token comment">-- 查看当前数据库的隔离级别</span>
<span class="token keyword">SELECT</span> @<span class="token variable">@tx_isolation</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> @<span class="token variable">@transaction_isolation</span><span class="token punctuation">;</span> <span class="token comment">-- mysql 8.0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="mvcc多版本并发控制"><a href="#mvcc多版本并发控制" class="header-anchor">#</a> MVCC多版本并发控制</h4> <p><strong>概述</strong>: 通过版本管理实现无锁并发访问</p> <ul><li>这里只讲述InnoDB中的实现: 通过保存快照来实现一致的查询结果
<ul><li>即便有读写冲突, 也能实现不加锁非阻塞并发读, 提高了数据库并发性能</li> <li>实现了RC和RR隔离级别, 解决了脏读和不可重复读</li></ul></li> <li><strong>当前读</strong>: 读到当前数据(最新版本数据)
<ul><li>select lock in share mode; select for update; update</li> <li>; delete操作</li></ul></li> <li><strong>快照读</strong>: 读到历史快照/版本数据
<ul><li>不加锁的select就是快照读, 非阻塞, 读取的历史版本在undolog中</li></ul></li> <li><strong>隐式字段</strong>:
<ul><li>回滚指针 : 7字节, 指向这条记录的上一个(pre)旧版本</li> <li>创建/更新事务id : 6字节, <strong>insert和update操作</strong>会把字段值设置为当前操作事务id</li> <li>删除事务头标记 : <strong>delete操作</strong>时会将该标记置为true</li> <li>另: 系统事务id: 由InnoDB维护的递增版本号, 开启事务先分配再递增</li></ul></li> <li><strong>undo log</strong>: 回滚日志, 在执行增删改操作时产生
<ul><li>insert操作在事务提交前只对当前事务可见, 产生的日志在事务提交后可以直接删除</li> <li>而update和delete需要维护多版本信息, 统一归类为update_undo</li></ul></li> <li><strong>readview</strong>: 绑定当前session, 可以认为是当时的数据库全局事务快照;</li></ul> <h3 id="undo-log-保证事务的原子性-mvcc"><a href="#undo-log-保证事务的原子性-mvcc" class="header-anchor">#</a> undo log, 保证事务的原子性, MVCC</h3> <p><strong>概述</strong>: MVCC重要组成部分, 保证了事务回滚, 每当产生记录变更就会产生undo记录, 存储了老版本数据; 当一个旧事务需要读取数据时, 需要顺着undo链找到满足其可见性的记录</p> <p><strong>undo log操作流程 / 事务流程</strong></p> <ul><li>事务开启时, 会在undo log结构中分配一个回滚段;</li> <li>事务开始, 执行insert以及update/delete语句会分开记录(区分insert_undo和update_undo)</li> <li>开始一条条写入undo_log, 构建回滚指针
<ul><li>update和delete直接将旧数据放入undo_log, 生成的新数据持有当前事务id以及回滚指针</li> <li>如果是DML语句, 无需判断可见性, 而是单纯的发现事务锁冲突, 直接堵塞操作</li></ul></li> <li>事务提交: 为了支持XA, 分为prepare阶段和commit阶段
<ul><li>prepare阶段: 将事务状态设置为prepare</li> <li>commit: 将事务状态设置为commit, 判断哪些回滚段加入purge, 然后清理undo</li></ul></li> <li>事务回滚: 读取老版本记录, 逆向操作</li> <li>多版本控制: 也就是select语句</li></ul> <h4 id="readview-可见性判断"><a href="#readview-可见性判断" class="header-anchor">#</a> readview, 可见性判断</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>readview包括  1.当前事务id, 2.活跃事务id的有序数组, 3.最小未分配事务id, 4.活跃事务id数组最小值
===============================================================
已提交事务 |(最小事务id) 未提交或已提交事务 | (尚未分配最low事务id) 未开始事务
(肯定可见的)				(两种情况)						(不可见的)
==========================||===================================
两种情况: 这条undo的事务id是否在活跃事务id数组中?
a.在活跃事务id数组中, 说明未提交, 只有这个id等于当前事务id才可见, 否则不可见
b.不在活跃事务id数组中, 说明已经提交的, 可见
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>此外对于readview的生成时间:</p> <ul><li>RC隔离级别情况下, 每次select(只有select创建)都要生成readview</li> <li>RR级别只有开启事务后的第一次select生成readview, 该事务后续查询沿用此readview</li> <li>RU(读已提交)情况下, 直接读最新的, 根本不判断可见性, 不去查看老版本</li> <li>serializable序列化下, 直接读写锁, 有修改和查询互相阻塞</li></ul> <h4 id="redo-log-保证事务的持久性"><a href="#redo-log-保证事务的持久性" class="header-anchor">#</a> redo log, 保证事务的持久性</h4> <p>保证WAL(write-ahead log): 在持久化数据文件前, 保证日志先落盘; 日志落盘后即可给用户返回操作成功, 不需要保证数据当时落盘</p> <p>重启时能够恢复</p> <ul><li>流程: 先写到内存, 然后fsync写到磁盘</li> <li>优势:
<ul><li>随机IO转变为顺序IO, 日志的写入开销小</li> <li>即使奔溃也可恢复这部分数据</li> <li>非临时表的undo log也可以恢复, 等于可以恢复未提交的事务</li></ul></li> <li>LSN(log sequence number) 用于记录日志序号</li> <li>innodb_flush_log_at_trx_commit配置项, 显然对性能的影响是随着持久化程度的增加而增加的. 通常我们建议在日常场景将该值设置为1, 但在系统高峰期临时修改成2以应对大负载</li></ul> <p><img src="http://mysql.taobao.org/monthly/pic/2015-05-01/5.png" alt="持久化程度"></p> <blockquote><p>msg: mysql共有多少种日志</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>错误日志, 查询日志, 慢查询日志, 二进制日志, 中继日志, 事务日志
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="innodb崩溃恢复流程"><a href="#innodb崩溃恢复流程" class="header-anchor">#</a> InnoDB崩溃恢复流程</h4> <p><a href="http://mysql.taobao.org/monthly/2015/06/01/" target="_blank" rel="noopener noreferrer">崩溃恢复进一步了解资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>初始化崩溃恢复 &gt;&gt; 恢复truncate &gt;&gt; redo崩溃恢复 &gt;&gt; 初始化事务子系统
&gt;&gt; 应用redo日志 &gt;&gt; 完成崩溃恢复 &gt;&gt; 无效数据清理&amp;事务回滚(回滚不处于prepare的事务)
&gt;&gt; binlog XA recover(恢复binlog)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>msg: XA下数据恢复问题?</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 非双1配置存在的问题: 
a. 引擎层提交了, 但是binlog没写入, 备库丢数据
b. 引擎层没有prepare , 但binlog写入了 , 主库丢事务
- 双1配置下存在的问题: 
a. 主库crash时还有binlog没传递到备库,直接提升备库为主库,会导致主备不一致
--此时老主库必须根据新主库重做才能恢复一致, 如何解决?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>sync_binlog + innodb_flush_log_at_trx_commit 双一配置; (主库比从库多出的都是prepare事务)
开启semisync(半同步) AFTER_SYNC; 超时时间设置到极大值;
从库执行relay log消费, 并记录执行结束的日志位点, 然后提升为新主库;
截断老主库binlog和上面的记录位点保持一致; 重启老主库;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><a href="http://mysql.taobao.org/monthly/2017/03/07/" target="_blank" rel="noopener noreferrer">MySQL半同步复制数据安全性分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2017/04/01/" target="_blank" rel="noopener noreferrer">MySQL半同步复制数据一致性分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="事务开启-事务提交"><a href="#事务开启-事务提交" class="header-anchor">#</a> 事务开启 &amp; 事务提交</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 事务开启: </span>
<span class="token keyword">begin</span><span class="token punctuation">;</span> <span class="token keyword">begin</span> <span class="token keyword">work</span><span class="token punctuation">;</span> <span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span> <span class="token comment">-- 开启一个事务,会根据sql变为只读或读写事务</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token keyword">read</span> only<span class="token punctuation">;</span> <span class="token comment">-- 开启只读事务(5.6加入,没有事务id,回滚段,全局链表)</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token keyword">read</span> <span class="token keyword">write</span><span class="token punctuation">;</span> <span class="token comment">-- 开启读写事务</span>
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token keyword">with</span> <span class="token keyword">consistent</span> <span class="token keyword">snapshot</span><span class="token punctuation">;</span> <span class="token comment">-- 开启事务顺便创建一个readview</span>
autocommit <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">-- 不自动提交事务...别用</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 事务提交:</span>
<span class="token comment">-- 显式开启一个事务,或执行一条非临时表DDL,就会隐式地将上一个事务提交</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">-- 显式提交</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="innodb分布式事务支持-xa事务"><a href="#innodb分布式事务支持-xa事务" class="header-anchor">#</a> InnoDB分布式事务支持: XA事务</h3> <p><a href="/question/06distributed/distrubuted-transaction/">分布式事务专题, XA协议, 2PC协议</a></p> <p><a href="http://mysql.taobao.org/monthly/2017/09/05/" target="_blank" rel="noopener noreferrer">InnoDB XA<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2021/01/02/" target="_blank" rel="noopener noreferrer">内部XA事务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="xa事务发起"><a href="#xa事务发起" class="header-anchor">#</a> XA事务发起</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/* 
Binlog/Engine XA --- 开启binlog时, MySQL默认使用隐式XA模式
binlog prepare + InnoDB prepare + 组提交

Engine/Engine XA --- binlog关闭, 如果事务跨引擎, 就可以在事务引擎间XA, 例如InnoDB和TokuDB(RDS MySQL)

Engine Commit --- binlog关闭, 且只使用了一个事务引擎, 无需进行XA  */</span>

<span class="token comment">-- 显式XA</span>
xa <span class="token keyword">begin</span> <span class="token string">'xidname'</span>
  <span class="token comment">-- do something ...</span>
xa <span class="token keyword">end</span> <span class="token string">'xidname'</span>
xa <span class="token keyword">prepare</span> <span class="token string">'xidname'</span>
xa <span class="token keyword">commit</span> <span class="token string">'xidname'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="mysql内部xa"><a href="#mysql内部xa" class="header-anchor">#</a> MySQL内部XA</h4> <p>单个MySQL实例 + 多个存储引擎实现的内部XA</p> <p>server层作为事务协调器, 多个存储引擎作为参与者</p> <ul><li>协调器对象:
<ul><li>如果开启binlog且存在事务引擎, 用binlog记录事务状态</li> <li>如果关闭binlog且存在多个事务引擎, 用tc_log_mmap内存记录事务状态</li> <li>其他情况, 则不需要XA</li></ul></li> <li>二阶段提交过程
<ul><li>prepare: 将undo回滚段设置为prepare, 将redolog刷盘</li> <li>commit: binlog写入, binlog刷盘, 事务提交</li></ul></li></ul> <p>如何保证XA事务中崩溃恢复, 以及组提交优化看这篇 <a href="http://mysql.taobao.org/monthly/2020/05/07/" target="_blank" rel="noopener noreferrer">内部 XA 和组提交<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="临键锁-next-key锁-解决幻读"><a href="#临键锁-next-key锁-解决幻读" class="header-anchor">#</a> 临键锁(next-key锁), 解决幻读</h4> <p><a href="http://mysql.taobao.org/monthly/2017/06/07/" target="_blank" rel="noopener noreferrer">InnoDB在RR隔离级别下的幻读问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果在事务中使用update更新幻读数据, 该数据的事务id会设置成为本事务id, 具有了可见性</p> <h2 id="七-锁机制"><a href="#七-锁机制" class="header-anchor">#</a> 七. 锁机制</h2> <p><a href="https://blog.csdn.net/weixin_39629876/article/details/112776744" target="_blank" rel="noopener noreferrer">入分析解读MySQL锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>锁概念: 在并发访问下保护数据一致性所设计的规则, 保证了目标数据在同一时刻只允许一个线程进行操作</p> <blockquote><p>msg:数据库的乐观锁和悲观锁? MySQL中有哪些锁?</p></blockquote> <h3 id="锁的分类"><a href="#锁的分类" class="header-anchor">#</a> 锁的分类</h3> <h4 id="从数据操作分类-读锁-共享锁-s锁-写锁-排他锁-x锁-意向锁-is锁和ix锁-自增锁"><a href="#从数据操作分类-读锁-共享锁-s锁-写锁-排他锁-x锁-意向锁-is锁和ix锁-自增锁" class="header-anchor">#</a> 从数据操作分类: 读锁(共享锁, S锁) , 写锁(排他锁, X锁) , 意向锁(IS锁和IX锁), 自增锁</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span><span class="token punctuation">;</span> <span class="token comment">-- S锁, 行锁</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment">-- X锁, 行锁</span>
只有明确指定索引的情况下走行锁<span class="token punctuation">,</span> 索引不明确<span class="token punctuation">,</span> 非索引<span class="token punctuation">,</span> 都会走表锁
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>问题: 在InnoDB引擎中行锁和表锁共存的</strong> : 如果t1上加了行锁, 其他事务能再加表锁吗?</p> <p><strong>意向锁是表锁</strong>, 是MySQL自己维护的, 用户无法手动设置</p> <p><strong>解决: 意向锁</strong>: 当需要给数据加上S锁/X锁的时候, MySQL会先给这张表加上IS锁/IX锁; 所以加锁的时候先判断这个表上的哪种锁, 根据兼容性判断是否可以加锁</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/da08474c065b6c6d98e7194505865d00.png" alt="XSIXIS兼容性"></p> <h4 id="从数据粒度分类-表锁-行锁-页面锁-间隙锁"><a href="#从数据粒度分类-表锁-行锁-页面锁-间隙锁" class="header-anchor">#</a> 从数据粒度分类: 表锁, 行锁, 页面锁, (间隙锁?)</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">LOCK</span> <span class="token keyword">TABLE</span> <span class="token operator">&lt;</span>tablename<span class="token operator">&gt;</span> <span class="token keyword">READ</span><span class="token punctuation">;</span> <span class="token comment">-- 表锁; 锁定后只读</span>
<span class="token keyword">UNLOCK</span> <span class="token keyword">TABLE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">-- 解锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="从实现-乐观锁-悲观锁"><a href="#从实现-乐观锁-悲观锁" class="header-anchor">#</a> 从实现: 乐观锁 , 悲观锁</h4> <p>乐观锁: 乐观认为可以大概率没有冲突, 可以成功数据更新, 所以在访问数据过程中不加锁, 只是通过数据版本号进行判断是否有冲突, 数据库没有实现, 请自己实现;</p> <h4 id="到底锁了什么-innodb中锁的是索引"><a href="#到底锁了什么-innodb中锁的是索引" class="header-anchor">#</a> 到底锁了什么 --- InnoDB中锁的是索引</h4> <ul><li>假如一张表没有索引, InnoDB会进行锁表</li> <li>假如我们对辅助索引加锁, 那么辅助索引所对应的主键索引也会被锁住</li> <li>主键索引被锁住, 实际上就等于是整条记录都被锁住了</li></ul> <blockquote><p>msg: InnoDB行锁是怎么实现的? 间隙锁? 临键锁?</p></blockquote> <h3 id="锁的三种模式"><a href="#锁的三种模式" class="header-anchor">#</a> 锁的三种模式</h3> <p><a href="https://zhuanlan.zhihu.com/p/48269420" target="_blank" rel="noopener noreferrer">记录所, 间隙锁, 临键锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>记录锁(Record Lock): 当我们的查询能命中一条记录的时候, 锁住所命中的这一行记录</li> <li>间隙锁(Gap Lock): (RR级别) 查询没有记录的时候(命中间隙), 会加上间隙锁. 会阻塞插入操作 (目标数据和主键数据区间追加后一个区间);</li> <li>临键锁(Next-Key Lock): 范围查询中不但命中了记录, 同时包括了间隙, 此时使用临键锁
<ul><li>将数据划分区间, 锁住所有 (查询到数据的区间并追加上后一个区间)</li></ul></li></ol> <blockquote><p>msg: 死锁? 写一段可以造成死锁的sql, mysql如何解决死锁?</p></blockquote> <h3 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h3> <p>多个事务等待获取对方已持有但又不释放的资源, 最终引起互相等待的现象</p> <p>死锁条件: 互斥条件, 持有并等待条件, 不可剥夺条件, 环路等待条件</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">FOR</span> UDPATE<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">20</span> <span class="token keyword">FOR</span> UDPATE<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">20</span> <span class="token keyword">FOR</span> UDPATE<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">FOR</span> UDPATE<span class="token punctuation">;</span>
<span class="token comment">-- 两个session同时执行以上语句可能导致死锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="死锁的检测"><a href="#死锁的检测" class="header-anchor">#</a> 死锁的检测</h4> <p>采用wait-for graph (等待图) 的方式来进行死锁检测:</p> <ul><li>数据库首先记录两种信息:  1.锁的信息链表;   2.事务的等待链表</li> <li>wait-for graph算法会根据这两个信息构建一张图, 当图中存在回路则证明存在死锁</li> <li>检测到死锁后一般将开销小的事务释放锁并回退, 另一个事务获得锁继续执行</li> <li>InnoDB不能完全检测到的死锁, 需要通过锁超时时间解决(默认50秒) innodb_lock_wait_timeout</li></ul> <p>下图中, t1和t2之间存在回路, 证明t1和t2事务之间存在死锁</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/02f3f99a7017c6597e574b13b5df4c63.png" alt="wait-for graph"></p> <h4 id="死锁的避免"><a href="#死锁的避免" class="header-anchor">#</a> 死锁的避免</h4> <ul><li>减少长事务</li> <li>避免没有where 条件的sql, 尽量使用索引, 尽量使用等值查询</li></ul> <h4 id="锁信息查询"><a href="#锁信息查询" class="header-anchor">#</a> 锁信息查询</h4> <p>information_schema数据库中提供了3张表查询事务和锁相关问题, 分别是1.INNODB_TRX(事务); 2.INNODB_LOCKS(事务锁); 3.INNODB_LOCK_WAITS(锁等待);</p> <p>进阶: <a href="http://mysql.taobao.org/monthly/2016/01/01/" target="_blank" rel="noopener noreferrer">事务锁进一步资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2016/03/10/" target="_blank" rel="noopener noreferrer">MySQL锁问题最佳实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2017/01/01/" target="_blank" rel="noopener noreferrer">InnoDB锁同步机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2017/12/02/" target="_blank" rel="noopener noreferrer">Innodb 锁子系统浅析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2018/02/01/" target="_blank" rel="noopener noreferrer">常用SQL语句的MDL加锁源码分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2018/05/04/" target="_blank" rel="noopener noreferrer">InnoDB行锁分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2020/04/02/" target="_blank" rel="noopener noreferrer">InnoDB读写锁实现分析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="八-mysql调优"><a href="#八-mysql调优" class="header-anchor">#</a> 八. MySQL调优</h2> <blockquote><p>日常工作中你是怎么优化SQL的？</p> <p>SQL优化的一般步骤是什么 , 怎么看执行计划 (explain)  , 如何理解其中各个字段的含义？</p> <p>如何写sql能够有效的使用到复合索引？</p> <p>一条sql执行过长的时间 , 你如何优化 , 从哪些方面入手？</p></blockquote> <h4 id="sql语句的优化器-mysql-query-optimizer"><a href="#sql语句的优化器-mysql-query-optimizer" class="header-anchor">#</a> SQL语句的优化器 - MySQL Query Optimizer</h4> <ol><li>RBO基于规则的优化器:
<ol><li>对sql进行优化, 分析Hint信息, 得出最后的执行计划</li></ol></li> <li>CBO基于成本的优化器: 根据计算分析系统收集到的统计信息</li></ol> <h4 id="sql性能下降原因"><a href="#sql性能下降原因" class="header-anchor">#</a> SQL性能下降原因</h4> <ul><li>查询语句写的烂</li> <li>索引失效 (单值/复合)</li> <li>关联查询太多 join (设计缺陷或不得已的需求)</li> <li>服务器调优及各个参数设置 (缓冲, 线程数等)</li></ul> <h3 id="mysql常见性能分析手段"><a href="#mysql常见性能分析手段" class="header-anchor">#</a> MySQL常见性能分析手段</h3> <ul><li>慢查询日志</li> <li>explain执行计划分析</li> <li>profiling分析</li> <li>show命令查询系统状态及系统变量</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token comment">-- 显示状态信息 (扩展show status like ‘XXX’) </span>
<span class="token keyword">show</span> variables <span class="token comment">-- 显示系统变量 (扩展show variables like ‘XXX’) </span>
<span class="token keyword">show</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span> <span class="token comment">-- 显示InnoDB存储引擎的状态</span>
<span class="token keyword">show</span> processlist <span class="token comment">-- 查看当前SQL执行 , 包括执行状态、是否锁表等</span>
mysqladmin variables <span class="token operator">-</span>u username <span class="token operator">-</span>p password <span class="token comment">-- 显示系统变量</span>
mysqladmin <span class="token keyword">extended</span><span class="token operator">-</span><span class="token keyword">status</span> <span class="token operator">-</span>u username <span class="token operator">-</span>p password <span class="token comment">-- 显示状态信息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="explain执行计划"><a href="#explain执行计划" class="header-anchor">#</a> explain执行计划</h3> <p>可以模拟优化器执行sql查询语句, 从而知道MySQL是如何处理你的sql语句的, 可以看到:</p> <ul><li>表的读取顺序</li> <li>数据读取操作的操作类型</li> <li>哪些索引可以使用</li> <li>哪些索引被实际使用</li> <li>表之间的引用</li> <li>每张表有多少行被优化器查询</li></ul> <h4 id="explain各字段解释"><a href="#explain各字段解释" class="header-anchor">#</a> explain各字段解释</h4> <ul><li><p><strong>id</strong>: select 查询的序列号, 包含一组数字, 表示执行顺序</p> <ul><li>id 相同, 执行顺序从上往下</li> <li>id 全不同, 如果是子查询, id 的序号会递增, id 值越大优先级越高, 越先被执行</li> <li>id 部分相同, 执行顺序是先按照数字大的先执行, 然后相同的按从上往下顺序执行</li></ul></li> <li><p><strong>select_type</strong>: 查询类型, 用于区别普通查询, 联合查询, 子查询等复杂查询</p></li> <li><p><strong>SIMPLE</strong> 简单的 select 查询 , 查询中不包含子查询或 UNION</p></li> <li><p>**PRIMARY ** 查询中若包含任何复杂的子部分, 最外层查询被标记为 PRIMARY</p></li> <li><p><strong>SUBQUERY</strong> 在select或where列表中包含了子查询</p></li> <li><p><strong>DERIVED</strong> 在from列表中包含的子查询被标记为DERIVED, MySQL会递归执行这些子查询, 把结果放在临时表里</p></li> <li><p><strong>UNION</strong> 若第二个select出现在UNION之后, 则被标记为UNION, 若UNION包含在from子句的子查询中, 外层select将被标记为DERIVED</p></li> <li><p><strong>UNION RESULT</strong> 从UNION表获取结果的select</p></li> <li><p><strong>table</strong> (显示这一行的数据是关于哪张表的)</p></li> <li><p><strong>type</strong> (显示查询使用了那种类型 , 从最好到最差依次排列	<strong>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</strong> )</p></li> <li><p>system 表只有一行记录 (等于系统表)  , 是 const 类型的特例 , 平时不会出现</p></li> <li><p>const 表示通过索引一次就找到了 , const 用于比较 primary key 或 unique 索引 , 因为只要匹配一行数据 , 所以很快 , 如将主键置于 where 列表中 , mysql 就能将该查询转换为一个常量</p></li> <li><p>eq_ref 唯一性索引扫描 , 对于每个索引键 , 表中只有一条记录与之匹配 , 常见于主键或唯一索引扫描</p></li> <li><p>ref 非唯一性索引扫描 , 范围匹配某个单独值得所有行。本质上也是一种索引访问 , 他返回所有匹配某个单独值的行 , 它可能也会找到多个符合条件的行</p></li> <li><p>range 只检索给定范围的行 , 使用一个索引来选择行。key列显示使用了哪个索引 , 一般就是在你的where语句中出现了between、&lt;、&gt;、in等的查询</p></li> <li><p>index (Full Index Scan) , 只遍历索引树, 通常比ALL快</p></li> <li><p>ALL (Full Table Scan) , 将遍历全表</p></li></ul> <p>tip: 一般来说 , 得保证查询至少达到range级别 , 最好到达ref</p> <ul><li><p><strong>possible_keys</strong> (显示可能应用在这张表中的索引 , 一个或多个 , 查询涉及到的字段若存在索引 , 则该索引将被列出 , 但不一定被查询实际使用)</p></li> <li><p><strong>key</strong></p></li> <li><p>实际使用的索引, 如果为 NULL, 则没有使用索引</p></li> <li><p>查询中若使用了覆盖索引, 则该索引和查询的 select 字段重叠, 仅出现在key列表中</p></li></ul> <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf2hsty7iaj30nt0373yb.jpg" alt="explain-key"></p> <ul><li><p><strong>key_len</strong></p></li> <li><p>表示索引中使用的字节数 , 可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下 , 长度越短越好</p></li> <li><p>key_len显示的值为索引字段的最大可能长度 , 并非实际使用长度 , 即key_len是根据表定义计算而得 , 不是通过表内检索出的</p></li> <li><p><strong>ref</strong>  (显示索引的哪一列被使用了 , 如果可能的话 , 是一个常数。哪些列或常量被用于查找索引列上的值)</p></li> <li><p><strong>rows</strong>  (根据表统计信息及索引选用情况 , 大致估算找到所需的记录所需要读取的行数)</p></li> <li><p><strong>Extra</strong> (包含不适合在其他列中显示但十分重要的额外信息)</p></li></ul> <ol><li><font color="red">using filesort</font>: 说明mysql会对数据使用一个外部的索引排序 , 不是按照表内的索引顺序进行读取。
<ul><li>mysql中无法利用索引完成的排序操作称为“文件排序”。常见于order by和group by语句中</li></ul></li> <li><font color="red">Using temporary</font> 使用了临时表保存中间结果 , mysql在对查询结果排序时使用临时表。常见于排序order by和分组查询group by。</li> <li><font color="red">using index</font> 表示相应的select操作中使用了覆盖索引 , 避免访问了表的数据行 , 效率不错 ,
<ul><li>如果同时出现using where , 表明索引被用来执行索引键值的查找；否则索引被用来读取数据而非执行查找操作</li></ul></li> <li>using where 使用了where过滤</li> <li>using join buffer 使用了连接缓存</li> <li>impossible where where子句的值总是false , 不能用来获取任何元祖</li> <li>select tables optimized away 在没有group by子句的情况下 , 基于索引 优化操作或对于MyISAM存储引擎优化COUNT(*)操作 , 不必等到执行阶段再进行计算 , 查询执行计划生成的阶段即完成优化</li> <li>distinct 优化distinct操作 , 在找到第一匹配的元祖后即停止找同样值的动作</li></ol> <h4 id="explain案例1"><a href="#explain案例1" class="header-anchor">#</a> explain案例1</h4> <p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gf2hszmc0lj30lc05w75c.jpg" alt="explain-demo"></p> <ol><li><p>第一行 (执行顺序4) : id列为1, 表示是union里的第一个select, select_type列的primary表示该查询为外层查询, table列被标记为&lt;derived3&gt;, 表示查询结果来自一个衍生表, 其中derived3中3代表该查询衍生自第三个select查询, 即id为3的select。【select d1.name......】</p></li> <li><p>第二行 (执行顺序2) : id为3, 是整个查询中第三个select的一部分。因查询包含在from中, 所以为derived。【select id,name from t1 where other_column=''】</p></li> <li><p>第三行 (执行顺序3) : select列表中的子查询select_type为subquery, 为整个查询中的第二个select。【select id from t3】</p></li> <li><p>第四行 (执行顺序1) : select_type为union, 说明第四个select是union里的第二个select, 最先执行【select name,id from t2】</p></li> <li><p>第五行 (执行顺序5) : 代表从union的临时表中读取行的阶段, table列的&lt;union1,4&gt;表示用第一个和第四个select的结果进行union操作。【两个结果union操作】</p></li></ol> <h3 id="慢查询日志"><a href="#慢查询日志" class="header-anchor">#</a> 慢查询日志</h3> <p>概述: MySQL提供的一种日志记录, 记录响应时间超过阈值的sql</p> <ul><li>默认阈值 <code>long_query_time=10</code> , 意指执行10秒以上</li> <li>默认情况下不开启</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%slow_query_log%'</span><span class="token punctuation">;</span> <span class="token comment">-- 查看开启状态</span>
<span class="token comment">-- 开启慢查询日志: 临时配置, 重启后失效;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log <span class="token operator">=</span> <span class="token string">'ON'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> slow_query_log_file <span class="token operator">=</span> <span class="token string">'/var/lib/mysql/hostname-slow.log'</span><span class="token punctuation">;</span>
<span class="token keyword">set</span> <span class="token keyword">global</span> long_query_time <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- 开启慢查询日志: 永久配置, 配置文件my.cnf</span>
<span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
slow_query_log <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span>
slow_query_log_file <span class="token operator">=</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>hostname<span class="token operator">-</span>slow<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
long_query_time <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 通过 mysqldumpslow --help 查看操作帮助信息</span>
<span class="token comment"># 得到返回记录集最多的10个SQL</span>
mysqldumpslow -s r -t <span class="token number">10</span> /var/lib/mysql/hostname-slow.log

<span class="token comment"># 得到访问次数最多的10个SQL</span>
mysqldumpslow -s c -t <span class="token number">10</span> /var/lib/mysql/hostname-slow.log

<span class="token comment"># 得到按照时间排序的前10条里面含有左连接的查询语句</span>
mysqldumpslow -s t -t <span class="token number">10</span> -g <span class="token string">&quot;left join&quot;</span> /var/lib/mysql/hostname-slow.log

<span class="token comment"># 也可以和管道配合使用</span>
mysqldumpslow -s r -t <span class="token number">10</span> /var/lib/mysql/hostname-slow.log <span class="token operator">|</span> <span class="token function">more</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>慢日志查询看哪些sql执行效率低下, 通过explain得知sql的具体执行情况, 索引使用等</p> <h3 id="show-profile-分析查询"><a href="#show-profile-分析查询" class="header-anchor">#</a> show profile 分析查询</h3> <p>概述: 使用show profile命令查看执行状态</p> <ul><li>可以用来分析当前会话中语句执行的资源消耗情况, 可以用于sql的调优的测量</li> <li>默认情况下, 参数处于关闭状态, 并保存最近15次的运行结果</li></ul> <h4 id="show-profile使用"><a href="#show-profile使用" class="header-anchor">#</a> show profile使用</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'profiling'</span><span class="token punctuation">;</span> <span class="token comment">-- 查看当前mysql是否支持</span>
<span class="token keyword">set</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">-- 默认是关闭, 使用前需要开启</span>
<span class="token comment">-- 执行sql语句, 然后查看结果, 比如: </span>
<span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+------------+---------------------------------+</span>
<span class="token operator">|</span> Query_ID <span class="token operator">|</span> Duration   <span class="token operator">|</span> Query                           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+---------------------------------+</span>
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">0.00385450</span> <span class="token operator">|</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;profiling&quot;</span> <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">0.00170050</span> <span class="token operator">|</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;profiling&quot;</span> <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token number">3</span> <span class="token operator">|</span> <span class="token number">0.00038025</span> <span class="token operator">|</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_base_user       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+------------+---------------------------------+</span>
<span class="token comment">-- 诊断sql</span>
<span class="token keyword">show</span> profile cpu<span class="token punctuation">,</span> block io <span class="token keyword">for</span> query <span class="token operator">&lt;</span>query_id<span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">-- 以上一步的id查看详细信息</span>
<span class="token comment">-- 开发需要注意的结论</span>
<span class="token operator">-</span> converting HEAP <span class="token keyword">to</span> MyISAM 	<span class="token comment">-- 查询结果太大, 内存都不够用了, 往磁盘上搬</span>
<span class="token operator">-</span> <span class="token keyword">create</span> tmp <span class="token keyword">table</span> 				<span class="token comment">-- 创建临时表, 这个要注意</span>
<span class="token operator">-</span> Copying <span class="token keyword">to</span> tmp <span class="token keyword">table</span> <span class="token keyword">on</span> <span class="token keyword">disk</span>  <span class="token comment">-- 把内存临时表复制到磁盘</span>
<span class="token operator">-</span> locked
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="性能优化-sql优化"><a href="#性能优化-sql优化" class="header-anchor">#</a> 性能优化, sql优化</h3> <h4 id="索引优化-详见索引章节"><a href="#索引优化-详见索引章节" class="header-anchor">#</a> 索引优化, 详见索引章节</h4> <h4 id="查询优化"><a href="#查询优化" class="header-anchor">#</a> 查询优化</h4> <ol><li><p>永远小表(数据集)驱动大表</p></li> <li><p>当 B 表的数据集小于 A 表的数据集时, 用 in 优于 exists ; 反之~</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A <span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> B <span class="token keyword">where</span> B<span class="token punctuation">.</span>id<span class="token operator">=</span>A<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> A <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> B<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>如果明确知道只有一条结果返回, <code>limit 1</code> 可以提高效率, 尽量使用limit, limit分页数据过多会变为全表查询</p> <ul><li>limit过多数据可以先根据主键筛选大部分数据, 再limit; (也就是使用覆盖索引)</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> rental <span class="token keyword">limit</span> <span class="token number">1000000</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">;</span>		<span class="token comment">-- 优化该sql到只遍历几行数据</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> rental a <span class="token keyword">join</span><span class="token punctuation">(</span><span class="token keyword">select</span> rental_id <span class="token keyword">from</span> rental <span class="token keyword">limit</span> <span class="token number">1000000</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> b <span class="token keyword">on</span> a<span class="token punctuation">.</span>rental_id <span class="token operator">=</span> b<span class="token punctuation">.</span>rental_id<span class="token punctuation">;</span>	<span class="token comment">-- 更快</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>表连接最好不要超过三张表, 需要join的字段, 数据类型必须一致, 最好条件相同</p></li> <li><p>尽量使用 union all 而不是 union , 除非需要消除重复的行</p></li></ol> <h4 id="order-by-关键字优化"><a href="#order-by-关键字优化" class="header-anchor">#</a> order by 关键字优化</h4> <ul><li><p>order by子句, 尽量使用 Index 方式排序, 避免使用 FileSort 方式排序</p></li> <li><p>MySQL 支持两种方式的排序, FileSort 和 Index, Index指 MySQL 扫描索引本身完成排序, FileSort 效率较低；</p></li> <li><p>order by 满足两种情况, 会使用 Index 方式排序；</p> <ul><li>order by 语句使用联合索引最左列</li> <li>使用 where 子句与 order by 子句条件列组合满足索引最左前列</li></ul></li> <li><p>尽可能在索引列上完成排序操作, 遵照建索引的最左前缀, order by顺序与联合索引顺序一致</p></li> <li><p>如果不在索引列上, filesort 有两种算法, 双路排序和单路排序</p> <ul><li>双路排序: 先将需要排序的字段读出来, 排序后按照需要再读取一次数据行</li> <li>单路排序: 从磁盘读取查询需要的所有列, 按照 order by 列在 buffer 对它们进行排序</li> <li>需要排序的列的总大小超过 <code>max_length_for_sort_data</code> 这个值, 会进行两次排序</li></ul></li> <li><p>优化策略</p> <ul><li>增大 sort_buffer_size 参数的设置</li> <li>增大 max_lencth_for_sort_data 参数的设置</li></ul></li></ul> <h4 id="group-by-关键字优化"><a href="#group-by-关键字优化" class="header-anchor">#</a> GROUP BY 关键字优化</h4> <ul><li>group by 实质是先排序后进行分组, 遵照索引建的最佳左前缀</li> <li>当无法使用索引列, 增大 <code>max_length_for_sort_data</code> <code>sort_buffer_size</code> 参数的设置</li> <li>where 效率高于 having, 能写在 where 限定的条件就不要去 having 限定了</li></ul> <h4 id="数据类型优化"><a href="#数据类型优化" class="header-anchor">#</a> 数据类型优化</h4> <ul><li>更小的通常更好: 选择正确存储数据的最小数据类型</li> <li>简单就好: 选择数值比字符串更好, 枚举使用数字来映射</li> <li>尽量避免NULL, 通常情况下指定列为not null</li></ul> <h4 id="适当的数据冗余-别再join了"><a href="#适当的数据冗余-别再join了" class="header-anchor">#</a> 适当的数据冗余: 别再join了</h4> <h4 id="适当拆分"><a href="#适当拆分" class="header-anchor">#</a> 适当拆分</h4> <ul><li>AKF</li> <li>垂直拆分: 将大字段拆分成多条小字段或是独立表</li></ul> <h3 id="服务器参数配置"><a href="#服务器参数配置" class="header-anchor">#</a> 服务器参数配置</h3> <h4 id="connection"><a href="#connection" class="header-anchor">#</a> connection</h4> <ul><li>最大连接数</li> <li>backlog</li> <li>等待时间</li></ul> <h4 id="说一下大表的优化方案"><a href="#说一下大表的优化方案" class="header-anchor">#</a> 说一下大表的优化方案</h4> <p>https://segmentfault.com/a/1190000006158186</p> <h2 id="九-主从复制-分库分表"><a href="#九-主从复制-分库分表" class="header-anchor">#</a> 九. 主从复制 + 分库分表</h2> <h3 id="主从集群概述"><a href="#主从集群概述" class="header-anchor">#</a> 主从集群概述</h3> <p>概述: 数据可以从数据库主节点复制到从节点,</p> <ul><li>可以做数据的备份, 主机宕机后可以提升备机为新主机</li> <li>业务量越来越大的情况下, 突破单机的I/O瓶颈</li></ul> <h4 id="复制过程-简略"><a href="#复制过程-简略" class="header-anchor">#</a> 复制过程(简略)</h4> <p>这里讲述的基于日志重放 (物理日志或逻辑日志) 的主从集群;  (MySQL就是以逻辑日志为基础的)</p> <ol><li>master记录binlog</li> <li>slave定时对主机的binlog日志进行检查, 如果发生改变则开启一个IO_thread将数据同步到relay log</li> <li>从节点驱动sql_thread读取relay log进行replay重放</li></ol> <p><img src="http://img.wandouip.com/crawler/article/201942/94aec4abf353527cbbe2bef5a484471d" alt="img"></p> <h4 id="复制历史优化"><a href="#复制历史优化" class="header-anchor">#</a> 复制历史优化</h4> <ol><li>最初只有io_thread和sql_thread: 当主库写入压力较大, 从库sql_thread重放速度跟不上主库的写入速度, 导致主备延迟 + relaylog不断堆积</li> <li>mysql5.6基于scheme级别的并行复制: 开启并行复制后会启动多个worker线程, relaylog中可以并行的事务发给worker执行, 不能并行的事务等worker处理完毕后由coordinator线程自己执行 (提高多表环境下的并行度)</li> <li>mysql5.7引入组提交, 组提交的flush, fsync, commit三个阶段可以并发执行, 提高主库的并行度
<ul><li>binlog_group_commit_sync_delay: 等待延迟提交的时间, binlog提交后等待一段时间再 fsync. 让每个 group 的事务更多, 人为提高并行度</li> <li>binlog_group_commit_sync_no_delay_count: 等待提交的最大事务数, 如果等待时间没到, 而事务数达到了, 就立即 fsync</li></ul></li> <li>mysql8.0实现了即使主库是串行提交, 只要通过算法判断互相不冲突, 备库可以并行回放replay</li></ol> <h4 id="异步复制数据不一致问题-semi-sync"><a href="#异步复制数据不一致问题-semi-sync" class="header-anchor">#</a> 异步复制数据不一致问题 - semi-sync</h4> <p>延迟: 如果master与slave之间采用异步模式进行binlog复制, 显然就会存在部分binlog未复制到slave的情况</p> <ul><li>为提高可用性, MySQL支持semi-sync模式, 也就是当master在提交事务之前, 保证binlog已经复制到slave, 并且收到slave回复的ACK后, master再将事务提交</li> <li>虽然提高了可用性, 极端情况下还是不一致: binlog还未复制到从机, 主机故障, 从机升为新主机, 旧主机重启后作为从机, 此时主从数据不一致</li></ul> <p>解决: 基于RAFT的多副本集群 - 阿里云MySQL金融版...</p> <h3 id="分库分表"><a href="#分库分表" class="header-anchor">#</a> 分库分表</h3> <h4 id="表分区-分区表-partitions"><a href="#表分区-分区表-partitions" class="header-anchor">#</a> 表分区, 分区表 partitions</h4> <p>概述 :  partitioning 按自定义的规则分布各个表的各个部分, 会以多个文件形式存储, 也可能分布在不同机器</p> <h5 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h5> <ol><li>表非常大以至于无法全部放进内存, 或者只在表的最后部分有热点数据, 其他均是历史数据</li> <li>批量删除大量数据可以使用清除整个分区的方式</li> <li>可以对一个独立分区进行优化, 检查, 修复等操作</li> <li>分区表的数据可以分布在不同的物理设备上，从而高效地利用多个硬件设备</li> <li>ext3文件系统的inode锁竞争</li> <li>可以备份和恢复独立的分区</li></ol> <h5 id="分区表的限制"><a href="#分区表的限制" class="header-anchor">#</a> 分区表的限制</h5> <ol><li>一个表最多只能有1024个分区，在5.7版本的时候可以支持8196个分区</li> <li>成本高, 包括选择分区的成本, 锁住所有表的成本, 维护分区的成本</li> <li>分区键设计不太灵活, 如果不走分区键, 很容易出现全表锁</li> <li>一旦数据并发量上来, 如果在分区表实施关联, 就是一个灾难</li> <li>不可控</li></ol> <h5 id="分区表使用场景"><a href="#分区表使用场景" class="header-anchor">#</a> 分区表使用场景</h5> <ul><li>数量过大, 时间序列性比较强(可以按时间来分区)</li> <li>有明显热点数据</li></ul> <h4 id="mysql分表-数据分片"><a href="#mysql分表-数据分片" class="header-anchor">#</a> MySQL分表, 数据分片</h4> <ul><li><p>垂直拆分: 业务拆分, 将主要的字段作为主要表, 不常用的字段作为次要表</p></li> <li><p>水平拆分: 数据拆分, 拆成完全相同的表, 根据时间, 热点数据, 主键顺序, hash值进行拆分</p></li></ul> <h4 id="mysql分库"><a href="#mysql分库" class="header-anchor">#</a> MySQL分库</h4> <p>概述: 单主集群无法支撑大量并发写入操作的情况下, 考虑分库:  可以将库中的表分到不同数据库中, 减少单库的访问频率</p> <p>问题: 分布式事务问题, 跨库联表查询问题(比起单库, 应用需要处理更多数据)</p> <h3 id="shardingsphere"><a href="#shardingsphere" class="header-anchor">#</a> ShardingSphere</h3> <p><a href="https://shardingsphere.apache.org/document/current/cn/overview/" target="_blank" rel="noopener noreferrer">概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://shardingsphere.apache.org/document/current/cn/features/governance/" target="_blank" rel="noopener noreferrer">分布式治理&amp;链路追踪<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: 实现了zookeeper和etcd的分布式治理, openTracing/skywalking分布式链路追踪</p> <h4 id="sharding-jdbc"><a href="#sharding-jdbc" class="header-anchor">#</a> Sharding-JDBC</h4> <p>在 Java 的 JDBC 层提供的额外服务: 它使用客户端直连数据库, 以 jar 包形式提供服务, 无需额外部署和依赖, 可理解为增强版的 JDBC 驱动, 完全兼容 JDBC 和各种 ORM 框架</p> <p>特点:  可视为JDBC, 数据库连接数消耗较多, 性能损耗小, 去中心化</p> <h4 id="sharding-proxy"><a href="#sharding-proxy" class="header-anchor">#</a> Sharding-Proxy</h4> <p>数据库代理; 定位为透明化的数据库代理端, 可以直接当做数据库使用</p> <p>特点: 性能损耗较多, 需要额外维护加入的代理层</p> <h4 id="shardingsphere-sidecar"><a href="#shardingsphere-sidecar" class="header-anchor">#</a> ShardingSphere-Sidecar</h4> <p>定位为 Kubernetes 的云原生数据库代理, Database Mesh</p> <h3 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h3> <p><a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/" target="_blank" rel="noopener noreferrer">ShardingSphere核心概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>逻辑表: 概念上的表, 比如流水表 cb_edraft_flow</li> <li>真实表: 分片后的物理表, 比如 cb_edraft_flow_0 到 cb_edraft_flow_9</li> <li>数据节点: 数据分片的最小单元, 比如 ebank_0.cb_edraft_flow_0</li> <li>绑定表: 分片规则一致的主表和字表, 比如 cb_hist_flow和 cb_edraft_flow
<ul><li>绑定表之间的多表关联不会出现笛卡尔积, 提高关联查询效率</li></ul></li> <li>广播表: 所有的分片数据源(db_0, db_1)中都存在的表, 表结构和数据完全一致</li> <li>单表: 所有数据源中只存在唯一一张的表</li></ul> <h4 id="分片"><a href="#分片" class="header-anchor">#</a> <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sharding/" target="_blank" rel="noopener noreferrer">分片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <ul><li>分片键: 用于分片数据库的字段; 例如将cb_edraft_flow表中的主键尾数取模分片</li> <li>分片运算: 除了键值以为, 还需要根据算法决定, 某键值应该到哪个分片
<ul><li>标准分片算法: 支持等于, in, between, &gt;, &lt; 等基本分片场景</li> <li>复合分片算法: 支持多列分片键</li></ul></li> <li>分片策略: 分片键+分片算法, 同样分为标准策略, 复合策略...</li> <li>在配置中需要指定以上策略, 配置中可以编写表达式</li></ul> <h4 id="分布式主键"><a href="#分布式主键" class="header-anchor">#</a> <a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/key-generator/" target="_blank" rel="noopener noreferrer">分布式主键<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h4> <p>为数据分片后, 不同数据节点生成全局唯一的主键</p> <p>内置支持UUID和SNOWFLAKE, 且支持自定义扩展</p> <h4 id="snowflake"><a href="#snowflake" class="header-anchor">#</a> SNOWFLAKE</h4> <p><strong>概述</strong>: 默认使用snowflake雪花算法</p> <p><font color="0099FF">雪花算法</font>: 生成<font color="0099FF">64bit</font>的长整型数据, 能够保证</p> <ol><li>不同进程的主键不重复</li> <li>相同进程主键的有序性</li></ol> <p><strong>原理</strong>:</p> <p>在同一个进程中: 通过时间位 + 序列位保证有序</p> <p>不同进程: 各个服务器大体做了时间同步, 那么可以认为主键是整体有序的</p> <ul><li>雪花算法的主键二进制表示形式包含 4 部分, 分别为1bit 符号位、41bit 时间戳位、10bit 工作进程位以及 12bit 序列号位</li> <li>符号位(1bit): 预留</li> <li>时间戳位(41bit): 容纳2^41毫秒数, 约69.73年</li> <li>工作进程位(10bit): 分布式下应保证每个工作进程id是不同的(支持1024台机器)</li> <li>序列号位(12bit): 用于在同一个毫秒内生成不同的id, 如果这个毫秒内超过了2^12, 则顺延到下个毫秒继续生成</li> <li>时钟回拨: 服务器时钟回拨可能导致重复序列, ShardingSphere可以设置一段的超时时间, 让时钟追上</li></ul> <p><img src="https://shardingsphere.apache.org/document/current/img/sharding/snowflake_cn_v2.png" alt="snowflake"></p> <h4 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h4> <p><a href="https://shardingsphere.apache.org/document/current/cn/features/transaction/" target="_blank" rel="noopener noreferrer">分布式事务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>XA事务</li> <li>Seata AT柔性事务, <a href="https://shardingsphere.apache.org/document/current/cn/features/transaction/concept/base-transaction-seata/" target="_blank" rel="noopener noreferrer">Seata柔性事务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="其他功能"><a href="#其他功能" class="header-anchor">#</a> 其他功能</h4> <ul><li>读写分离</li> <li>分布式治理</li> <li>弹性伸缩</li> <li><a href="https://shardingsphere.apache.org/document/current/cn/features/shadow/" target="_blank" rel="noopener noreferrer">影子压测(生产)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>性能测试</li></ul> <p>更多知识</p> <ul><li><a href="http://mysql.taobao.org/monthly/2017/06/03/" target="_blank" rel="noopener noreferrer">MySQL从节点可更新机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mysql.taobao.org/monthly/2018/06/04/" target="_blank" rel="noopener noreferrer">8.0 WriteSet 并行复制的演进<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mysql.taobao.org/monthly/2018/06/03/" target="_blank" rel="noopener noreferrer">MySQL也可以无损自由切换<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mysql.taobao.org/monthly/2018/07/01/" target="_blank" rel="noopener noreferrer">WAL那些事儿<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mysql.taobao.org/monthly/2018/08/01/" target="_blank" rel="noopener noreferrer">主库binlog概览<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://mysql.taobao.org/monthly/2018/12/04/" target="_blank" rel="noopener noreferrer">再议MySQL的故障恢复<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="进阶-物理复制"><a href="#进阶-物理复制" class="header-anchor">#</a> 进阶-物理复制</h4> <p><a href="http://mysql.taobao.org/monthly/2016/05/01/" target="_blank" rel="noopener noreferrer">基于InnoDB的物理复制实现<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="sql基础问题"><a href="#sql基础问题" class="header-anchor">#</a> SQL基础问题</h3> <h4 id="行转列"><a href="#行转列" class="header-anchor">#</a> 行转列</h4> <h4 id="优化排名"><a href="#优化排名" class="header-anchor">#</a> 优化排名</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">set</span> <span class="token variable">@i</span>:<span class="token operator">=</span>i<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@i</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@i</span>:<span class="token operator">=</span><span class="token variable">@i</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 类似的各种操作</span>
<span class="token comment">-- mysql 开箱函数</span>
<span class="token comment">-- 1. 无缓存</span>
<span class="token comment">-- 2. 生命周期在本次连接中</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="更新值"><a href="#更新值" class="header-anchor">#</a> 更新值</h4> <h4 id="字符集的选择"><a href="#字符集的选择" class="header-anchor">#</a> 字符集的选择</h4> <p>不使用mysql的utf8(不全), 推荐使用utf8mb4; mysql的字符集可以精确到字段</p> <h4 id="范式-vs-数据冗余"><a href="#范式-vs-数据冗余" class="header-anchor">#</a> 范式 vs 数据冗余</h4> <ul><li>第一范式 (1NF) : 所有字段都是单一属性的, 不可再分</li> <li>第二范式 (2NF) : 所有每列都和联合主键相关, 不能部分相关</li> <li>第三范式 (3NF) : 所有字段必须依赖主键, 不包含其他表已包含的非关键字信息</li></ul> <p>数据库设计根据具体场景, 合理使用范式和反范式 (常混合使用)</p> <h4 id="临时表"><a href="#临时表" class="header-anchor">#</a> 临时表</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLE</span> SalesSummary <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">column</span><span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 会话级别, 断开连接就删除</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="事务并发控制"><a href="#事务并发控制" class="header-anchor">#</a> 事务并发控制</h4> <h4 id="高优先级事务"><a href="#高优先级事务" class="header-anchor">#</a> 高优先级事务</h4> <h4 id="savepoint"><a href="#savepoint" class="header-anchor">#</a> SAVEPOINT</h4> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">savepoint</span> sp_name<span class="token punctuation">;</span> <span class="token comment">-- 设置保存点的方式来管理事务的执行过程</span>
<span class="token keyword">rollback</span> <span class="token keyword">to</span> <span class="token punctuation">[</span><span class="token keyword">savepoint</span><span class="token punctuation">]</span> sp_name<span class="token punctuation">;</span> <span class="token comment">-- 回滚到保存点</span>
<span class="token keyword">release</span> <span class="token keyword">savepoint</span> sp_name<span class="token punctuation">;</span> <span class="token comment">-- 删除一个保存点</span>
<span class="token comment">-- 还有隐式保存点(略)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="mysql性能问题诊断"><a href="#mysql性能问题诊断" class="header-anchor">#</a> MySQL性能问题诊断</h4> <p><a href="http://mysql.taobao.org/monthly/2018/11/08/" target="_blank" rel="noopener noreferrer">MySQL性能问题多维度诊断<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2019/11/03/" target="_blank" rel="noopener noreferrer">性能分析的大杀器—Optimizer trace<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mysql.taobao.org/monthly/2019/07/03/" target="_blank" rel="noopener noreferrer">Buffer Pool 漫谈<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/7/2021, 12:08:35 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.42575a28.js" defer></script><script src="/assets/js/2.0d7d09b8.js" defer></script><script src="/assets/js/39.10801a2a.js" defer></script>
  </body>
</html>
