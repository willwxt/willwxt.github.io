<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SUCKED BloG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.42575a28.js" as="script"><link rel="preload" href="/assets/js/2.0d7d09b8.js" as="script"><link rel="preload" href="/assets/js/30.fe8fe8c0.js" as="script"><link rel="prefetch" href="/assets/js/10.1a30ebe5.js"><link rel="prefetch" href="/assets/js/100.022f696a.js"><link rel="prefetch" href="/assets/js/101.06eb0acb.js"><link rel="prefetch" href="/assets/js/102.e944c220.js"><link rel="prefetch" href="/assets/js/103.45b9da9a.js"><link rel="prefetch" href="/assets/js/104.cf53f5d1.js"><link rel="prefetch" href="/assets/js/105.200d7fe5.js"><link rel="prefetch" href="/assets/js/106.a0cc3502.js"><link rel="prefetch" href="/assets/js/107.4a71d17e.js"><link rel="prefetch" href="/assets/js/108.d7a39a75.js"><link rel="prefetch" href="/assets/js/109.35619cf9.js"><link rel="prefetch" href="/assets/js/11.f78ae8b3.js"><link rel="prefetch" href="/assets/js/110.f667d72e.js"><link rel="prefetch" href="/assets/js/111.de83ce6f.js"><link rel="prefetch" href="/assets/js/112.417d40bf.js"><link rel="prefetch" href="/assets/js/113.0f26c1ca.js"><link rel="prefetch" href="/assets/js/114.c7014acb.js"><link rel="prefetch" href="/assets/js/115.b502c0f1.js"><link rel="prefetch" href="/assets/js/116.10fb230e.js"><link rel="prefetch" href="/assets/js/117.f7cb9e2a.js"><link rel="prefetch" href="/assets/js/118.978d3075.js"><link rel="prefetch" href="/assets/js/119.09272191.js"><link rel="prefetch" href="/assets/js/12.140aa2af.js"><link rel="prefetch" href="/assets/js/120.32b5dbd7.js"><link rel="prefetch" href="/assets/js/121.8d618bbb.js"><link rel="prefetch" href="/assets/js/122.dcd4190d.js"><link rel="prefetch" href="/assets/js/123.2ee061d1.js"><link rel="prefetch" href="/assets/js/124.5a3760a7.js"><link rel="prefetch" href="/assets/js/125.a874a4bc.js"><link rel="prefetch" href="/assets/js/126.c6c6b7e6.js"><link rel="prefetch" href="/assets/js/127.38c35051.js"><link rel="prefetch" href="/assets/js/128.8d775ac8.js"><link rel="prefetch" href="/assets/js/129.6100ddb1.js"><link rel="prefetch" href="/assets/js/13.b2a6e590.js"><link rel="prefetch" href="/assets/js/130.9a83da2a.js"><link rel="prefetch" href="/assets/js/131.22de7670.js"><link rel="prefetch" href="/assets/js/132.f88798bf.js"><link rel="prefetch" href="/assets/js/133.925bbfed.js"><link rel="prefetch" href="/assets/js/134.481fad71.js"><link rel="prefetch" href="/assets/js/135.c3efb09b.js"><link rel="prefetch" href="/assets/js/136.758c447a.js"><link rel="prefetch" href="/assets/js/137.dcde1032.js"><link rel="prefetch" href="/assets/js/138.616a346b.js"><link rel="prefetch" href="/assets/js/139.b58dd07f.js"><link rel="prefetch" href="/assets/js/14.15374560.js"><link rel="prefetch" href="/assets/js/140.62b4c7ea.js"><link rel="prefetch" href="/assets/js/15.ffd155fa.js"><link rel="prefetch" href="/assets/js/16.feb1b022.js"><link rel="prefetch" href="/assets/js/17.6d491eb6.js"><link rel="prefetch" href="/assets/js/18.03ddaa95.js"><link rel="prefetch" href="/assets/js/19.021bbcc8.js"><link rel="prefetch" href="/assets/js/20.8aa708b0.js"><link rel="prefetch" href="/assets/js/21.59d7a21e.js"><link rel="prefetch" href="/assets/js/22.21597439.js"><link rel="prefetch" href="/assets/js/23.77303f0b.js"><link rel="prefetch" href="/assets/js/24.0789ed5b.js"><link rel="prefetch" href="/assets/js/25.244a12a8.js"><link rel="prefetch" href="/assets/js/26.a6ee95e4.js"><link rel="prefetch" href="/assets/js/27.9e0f0e9d.js"><link rel="prefetch" href="/assets/js/28.189031c5.js"><link rel="prefetch" href="/assets/js/29.b3100d33.js"><link rel="prefetch" href="/assets/js/3.2a5d4cd5.js"><link rel="prefetch" href="/assets/js/31.86fec3f7.js"><link rel="prefetch" href="/assets/js/32.24cac061.js"><link rel="prefetch" href="/assets/js/33.f1db2ed0.js"><link rel="prefetch" href="/assets/js/34.c220692f.js"><link rel="prefetch" href="/assets/js/35.9e7b4779.js"><link rel="prefetch" href="/assets/js/36.0cb1d1bc.js"><link rel="prefetch" href="/assets/js/37.7d1fcf79.js"><link rel="prefetch" href="/assets/js/38.bc9bc4b3.js"><link rel="prefetch" href="/assets/js/39.10801a2a.js"><link rel="prefetch" href="/assets/js/4.b4d9a5aa.js"><link rel="prefetch" href="/assets/js/40.c980543d.js"><link rel="prefetch" href="/assets/js/41.3f4581d8.js"><link rel="prefetch" href="/assets/js/42.60b85cdf.js"><link rel="prefetch" href="/assets/js/43.1338528d.js"><link rel="prefetch" href="/assets/js/44.786fc51f.js"><link rel="prefetch" href="/assets/js/45.d65f6744.js"><link rel="prefetch" href="/assets/js/46.543c2b26.js"><link rel="prefetch" href="/assets/js/47.59f19ed2.js"><link rel="prefetch" href="/assets/js/48.60de6b25.js"><link rel="prefetch" href="/assets/js/49.f3df62ef.js"><link rel="prefetch" href="/assets/js/5.013522c1.js"><link rel="prefetch" href="/assets/js/50.fd9871d6.js"><link rel="prefetch" href="/assets/js/51.1fb1863e.js"><link rel="prefetch" href="/assets/js/52.c06ce3f3.js"><link rel="prefetch" href="/assets/js/53.a3d55203.js"><link rel="prefetch" href="/assets/js/54.89ac64bc.js"><link rel="prefetch" href="/assets/js/55.ccf38d1e.js"><link rel="prefetch" href="/assets/js/56.ffb8595b.js"><link rel="prefetch" href="/assets/js/57.5f1bd695.js"><link rel="prefetch" href="/assets/js/58.7463616d.js"><link rel="prefetch" href="/assets/js/59.ea4eb5dd.js"><link rel="prefetch" href="/assets/js/6.72ad7c85.js"><link rel="prefetch" href="/assets/js/60.a2add219.js"><link rel="prefetch" href="/assets/js/61.3eae0362.js"><link rel="prefetch" href="/assets/js/62.801d1658.js"><link rel="prefetch" href="/assets/js/63.b47a17bb.js"><link rel="prefetch" href="/assets/js/64.d5e2bdea.js"><link rel="prefetch" href="/assets/js/65.24d540f4.js"><link rel="prefetch" href="/assets/js/66.09a1ae52.js"><link rel="prefetch" href="/assets/js/67.75bd38e7.js"><link rel="prefetch" href="/assets/js/68.1fe6956e.js"><link rel="prefetch" href="/assets/js/69.d3306c2d.js"><link rel="prefetch" href="/assets/js/7.60760bb7.js"><link rel="prefetch" href="/assets/js/70.95aa4503.js"><link rel="prefetch" href="/assets/js/71.7065ebf0.js"><link rel="prefetch" href="/assets/js/72.55ae5081.js"><link rel="prefetch" href="/assets/js/73.c7624eee.js"><link rel="prefetch" href="/assets/js/74.63bcc7bd.js"><link rel="prefetch" href="/assets/js/75.e2731e20.js"><link rel="prefetch" href="/assets/js/76.1711af80.js"><link rel="prefetch" href="/assets/js/77.f1c4e2d3.js"><link rel="prefetch" href="/assets/js/78.900bc856.js"><link rel="prefetch" href="/assets/js/79.a1b8c47b.js"><link rel="prefetch" href="/assets/js/8.0c261cf2.js"><link rel="prefetch" href="/assets/js/80.7cf435bf.js"><link rel="prefetch" href="/assets/js/81.fa33b2af.js"><link rel="prefetch" href="/assets/js/82.cdabd386.js"><link rel="prefetch" href="/assets/js/83.879fc50c.js"><link rel="prefetch" href="/assets/js/84.7e460788.js"><link rel="prefetch" href="/assets/js/85.339356d5.js"><link rel="prefetch" href="/assets/js/86.d526418c.js"><link rel="prefetch" href="/assets/js/87.12877e38.js"><link rel="prefetch" href="/assets/js/88.d5a7d193.js"><link rel="prefetch" href="/assets/js/89.2f4a62c2.js"><link rel="prefetch" href="/assets/js/9.50eda380.js"><link rel="prefetch" href="/assets/js/90.6d83f5bf.js"><link rel="prefetch" href="/assets/js/91.f3364825.js"><link rel="prefetch" href="/assets/js/92.158fcc7a.js"><link rel="prefetch" href="/assets/js/93.0c4e5f88.js"><link rel="prefetch" href="/assets/js/94.c5725f80.js"><link rel="prefetch" href="/assets/js/95.dc61d501.js"><link rel="prefetch" href="/assets/js/96.3a598fc5.js"><link rel="prefetch" href="/assets/js/97.712aa8be.js"><link rel="prefetch" href="/assets/js/98.e757fe7a.js"><link rel="prefetch" href="/assets/js/99.1418024a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SUCKED BloG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/point/01java/juc-msb.html#复习" class="sidebar-link">复习</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第一天-线程基础-synchronized" class="sidebar-link">第一天 线程基础 synchronized</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第二天-synchronized-volatile-cas" class="sidebar-link">第二天 synchronized volatile CAS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/01java/juc-msb.html#volatile" class="sidebar-link">volatile</a></li></ul></li><li><a href="/point/01java/juc-msb.html#第三天-reentrantlock-等api" class="sidebar-link">第三天 ReentrantLock 等api</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第四天-面试题-locksupport-源码阅读技巧" class="sidebar-link">第四天 面试题 LockSupport 源码阅读技巧</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第五天-aqs-threadlocal-四种引用" class="sidebar-link">第五天 AQS ThreadLocal 四种引用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第六天-各种容器-queue" class="sidebar-link">第六天 各种容器 QUEUE</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第七天-线程池" class="sidebar-link">第七天 线程池</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第八天" class="sidebar-link">第八天</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/01java/juc-msb.html#第九天-jmh-disruptor-生产环境测试工具" class="sidebar-link">第九天 JMH Disruptor 生产环境测试工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/point/01java/juc-msb.html#纤程-协程" class="sidebar-link">纤程/协程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><h1 id="多线程和高并发"><a href="#多线程和高并发" class="header-anchor">#</a> 多线程和高并发</h1> <h2 id="复习"><a href="#复习" class="header-anchor">#</a> 复习</h2> <h2 id="第一天-线程基础-synchronized"><a href="#第一天-线程基础-synchronized" class="header-anchor">#</a> 第一天 线程基础 synchronized</h2> <h6 id="什么是程序-进程-线程-协程-纤程"><a href="#什么是程序-进程-线程-协程-纤程" class="header-anchor">#</a> 什么是程序, 进程, 线程, 协程/纤程</h6> <blockquote><p>进程相对于程序而言, 运行的程序, 进程的最小单位是线程</p></blockquote> <h6 id="java-开启线程的三种方式"><a href="#java-开启线程的三种方式" class="header-anchor">#</a> java 开启线程的三种方式</h6> <ul><li>1继承thread 2实现Runnable 3线程池获取</li></ul> <h6 id="线程方法介绍"><a href="#线程方法介绍" class="header-anchor">#</a> 线程方法介绍</h6> <blockquote><p><code>Thread.yield()</code> 让出一次cpu时间片, 回到就绪Ready, 等待队列中</p> <p><code>thread1.join()</code> 等线程t1执行完再继续向下执行代码</p> <p><code>this.getState()</code> 线程状态, 同一个线程对象结束后不能再次调用start</p> <p>不要去关闭线程, 要让线程正常结束 不要用 <code>stop</code> 少用 <code>interrupt</code></p> <p><code>sleep join wait park...</code> 的时候 <code>interrupt</code> 程序会收到异常, 然后选择对异常进行处理</p></blockquote> <h6 id="线程状态"><a href="#线程状态" class="header-anchor">#</a> 线程状态</h6> <p><svg id="SvgjsSvg1162" width="883.9943084716797" height="565.994288444519" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs"><defs id="SvgjsDefs1163"><marker id="SvgjsMarker1216" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1217" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1224" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1225" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1234" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1235" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1246" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1247" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1258" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1259" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1268" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1269" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1276" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1277" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1290" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1291" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1302" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1303" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker><marker id="SvgjsMarker1312" markerWidth="16" markerHeight="12" refX="16" refY="6" viewBox="0 0 16 12" orient="auto" markerUnits="userSpaceOnUse" stroke-dasharray="0,0"><path id="SvgjsPath1313" d="M0,2 L14,6 L0,11 L0,2" fill="#323232" stroke="#323232" stroke-width="2"></path></marker></defs><g id="SvgjsG1164" transform="translate(25,279.00284481048584)"><path id="SvgjsPath1165" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#e6ffcc"></path><g id="SvgjsG1166"><text id="SvgjsText1167" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1168" dy="16" x="54.5"><tspan id="SvgjsTspan1169">NEW</tspan></tspan></text></g></g><g id="SvgjsG1170" transform="translate(359,25.00284481048584)"><path id="SvgjsPath1171" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffb366"></path><g id="SvgjsG1172"><text id="SvgjsText1173" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1174" dy="16" x="54.5"><tspan id="SvgjsTspan1175">WAITING</tspan></tspan></text></g></g><g id="SvgjsG1176" transform="translate(751,279.00284481048584)"><path id="SvgjsPath1177" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(0,0,0,1)" stroke-width="2" fill-opacity="1" fill="#000000"></path><g id="SvgjsG1178"><text id="SvgjsText1179" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#ffffff" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="4.55" transform="rotate(0)"><tspan id="SvgjsTspan1180" dy="16" x="54.5"><tspan id="SvgjsTspan1181">TERMINATE</tspan></tspan><tspan id="SvgjsTspan1182" dy="16" x="54.5"><tspan id="SvgjsTspan1183">D</tspan></tspan></text></g></g><g id="SvgjsG1184" transform="translate(613,478.00284481048584)"><path id="SvgjsPath1185" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ff9999"></path><g id="SvgjsG1186"><text id="SvgjsText1187" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1188" dy="16" x="54.5"><tspan id="SvgjsTspan1189">BLOCKED</tspan></tspan></text></g></g><g id="SvgjsG1190" transform="translate(54,496.00284481048584)"><path id="SvgjsPath1191" d="M 0 4Q 0 0 4 0L 135 0Q 139 0 139 4L 139 40Q 139 44 135 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ffb366"></path><g id="SvgjsG1192"><text id="SvgjsText1193" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="119px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1194" dy="16" x="69.5"><tspan id="SvgjsTspan1195">TIMED_WAITING</tspan></tspan></text></g></g><g id="SvgjsG1196" transform="translate(257,192.00284481048584)"><path id="SvgjsPath1197" d="M 0 0L 337 0L 337 218L 0 218Z" stroke-dasharray="3,4" stroke="rgba(255,153,153,1)" stroke-width="2" fill-opacity="1" fill="#ffffff"></path><g id="SvgjsG1198"><text id="SvgjsText1199" font-family="微软雅黑" text-anchor="start" font-size="18px" width="317px" fill="#990000" font-weight="700" align="top" anchor="start" family="微软雅黑" size="18px" weight="700" font-style="italic" opacity="1" y="-2.6999999999999997" transform="rotate(0)"><tspan id="SvgjsTspan1200" dy="22" x="10"><tspan id="SvgjsTspan1201">RUNNABLE</tspan></tspan></text></g></g><g id="SvgjsG1202" transform="translate(277,279.00284481048584)"><path id="SvgjsPath1203" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ff99ff"></path><g id="SvgjsG1204"><text id="SvgjsText1205" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1206" dy="16" x="54.5"><tspan id="SvgjsTspan1207">READY</tspan></tspan></text></g></g><g id="SvgjsG1208" transform="translate(468,279.00284481048584)"><path id="SvgjsPath1209" d="M 0 4Q 0 0 4 0L 105 0Q 109 0 109 4L 109 40Q 109 44 105 44L 4 44Q 0 44 0 40Z" stroke="rgba(50,50,50,1)" stroke-width="2" fill-opacity="1" fill="#ff99ff"></path><g id="SvgjsG1210"><text id="SvgjsText1211" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="89px" fill="#323232" font-weight="700" align="middle" anchor="middle" family="微软雅黑" size="13px" weight="700" font-style="" opacity="1" y="12.55" transform="rotate(0)"><tspan id="SvgjsTspan1212" dy="16" x="54.5"><tspan id="SvgjsTspan1213">RUNNING</tspan></tspan></text></g></g><g id="SvgjsG1214"><path id="SvgjsPath1215" d="M331.5 279.00284481048584L331.5 249.00284481048584L522.5 249.00284481048584L522.5 279.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1216)"></path><rect id="SvgjsRect1218" width="52" height="15" x="401" y="241.50284481048584" fill="#ffffff"></rect><text id="SvgjsText1219" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="52px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="239.55284481048585" transform="rotate(0)"><tspan id="SvgjsTspan1220" dy="16" x="427"><tspan id="SvgjsTspan1221">系统调度</tspan></tspan></text></g><g id="SvgjsG1222"><path id="SvgjsPath1223" d="M522.5 323.00284481048584L522.5 353.00284481048584L331.5 353.00284481048584L331.5 323.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1224)"></path><rect id="SvgjsRect1226" width="52" height="31" x="401" y="337.50284481048584" fill="#ffffff"></rect><text id="SvgjsText1227" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="52px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="335.55284481048585" transform="rotate(0)"><tspan id="SvgjsTspan1228" dy="16" x="427"><tspan id="SvgjsTspan1229">系统调度</tspan></tspan><tspan id="SvgjsTspan1230" dy="16" x="427"><tspan id="SvgjsTspan1231">yield()</tspan></tspan></text></g><g id="SvgjsG1232"><path id="SvgjsPath1233" d="M455.6392059326172 68.01989650726318C 455.6392059326172 136.58350089585522 574 123.4392404218938 574 192.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1234)"></path><rect id="SvgjsRect1236" width="125" height="46" x="452.3196029663086" y="107.01137065887451" fill="#ffffff"></rect><text id="SvgjsText1237" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="125px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="105.06137065887451" transform="rotate(0)"><tspan id="SvgjsTspan1238" dy="16" x="514.8196029663086"><tspan id="SvgjsTspan1239">Object.notify()</tspan></tspan><tspan id="SvgjsTspan1240" dy="16" x="514.8196029663086"><tspan id="SvgjsTspan1241">Object.notifyAll()</tspan></tspan><tspan id="SvgjsTspan1242" dy="16" x="514.8196029663086"><tspan id="SvgjsTspan1243">LockSupport.unpark</tspan></tspan></text></g><g id="SvgjsG1244"><path id="SvgjsPath1245" d="M272 192.00284481048584C 272 127.31214197176968 374.6392059326172 131.71059934597935 374.6392059326172 67.01989650726318" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1246)"></path><rect id="SvgjsRect1248" width="109" height="46" x="268.8196029663086" y="106.51137065887451" fill="#ffffff"></rect><text id="SvgjsText1249" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="109px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="104.56137065887451" transform="rotate(0)"><tspan id="SvgjsTspan1250" dy="16" x="323.3196029663086"><tspan id="SvgjsTspan1251">Object.wait()</tspan></tspan><tspan id="SvgjsTspan1252" dy="16" x="323.3196029663086"><tspan id="SvgjsTspan1253">Object.join()</tspan></tspan><tspan id="SvgjsTspan1254" dy="16" x="323.3196029663086"><tspan id="SvgjsTspan1255">LockSupport.park</tspan></tspan></text></g><g id="SvgjsG1256"><path id="SvgjsPath1257" d="M594 301.00284481048584C 656.8 301.00284481048584 688.2 301.00284481048584 751 301.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1258)"></path><rect id="SvgjsRect1260" width="78" height="31" x="633.5" y="285.50284481048584" fill="#ffffff"></rect><text id="SvgjsText1261" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="78px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="283.55284481048585" transform="rotate(0)"><tspan id="SvgjsTspan1262" dy="16" x="672.5"><tspan id="SvgjsTspan1263">线程执行结束</tspan></tspan><tspan id="SvgjsTspan1264" dy="16" x="672.5"><tspan id="SvgjsTspan1265">异常退出</tspan></tspan></text></g><g id="SvgjsG1266"><path id="SvgjsPath1267" d="M134 301.00284481048584C 183.2 301.00284481048584 207.8 301.00284481048584 257 301.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1268)"></path><rect id="SvgjsRect1270" width="75" height="15" x="158" y="293.50284481048584" fill="#ffffff"></rect><text id="SvgjsText1271" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="75px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="291.55284481048585" transform="rotate(0)"><tspan id="SvgjsTspan1272" dy="16" x="195.5"><tspan id="SvgjsTspan1273">Thread.start</tspan></tspan></text></g><g id="SvgjsG1274"><path id="SvgjsPath1275" d="M266 408.00284481048584C 201.0028533935547 415.7471532821655 61 406.7669775821118 61 496.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1276)"></path><rect id="SvgjsRect1278" width="149" height="62" x="64.62607002258301" y="390.4435102767254" fill="#ffffff"></rect><text id="SvgjsText1279" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="149px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="388.49351027672543" transform="rotate(0)"><tspan id="SvgjsTspan1280" dy="16" x="139.126070022583"><tspan id="SvgjsTspan1281">Thread.sleep()</tspan></tspan><tspan id="SvgjsTspan1282" dy="16" x="139.126070022583"><tspan id="SvgjsTspan1283">Object.wait()</tspan></tspan><tspan id="SvgjsTspan1284" dy="16" x="139.126070022583"><tspan id="SvgjsTspan1285">Thread.join()</tspan></tspan><tspan id="SvgjsTspan1286" dy="16" x="139.126070022583"><tspan id="SvgjsTspan1287">LockSupport.parkNanos</tspan></tspan></text></g><g id="SvgjsG1288"><path id="SvgjsPath1289" d="M193 518.0028448104858C 295.5438442813609 518.0028448104858 425.5 512.5466890918468 425.5 410.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1290)"></path><rect id="SvgjsRect1292" width="125" height="46" x="285.20394160551035" y="479.4567864159962" fill="#ffffff"></rect><text id="SvgjsText1293" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="125px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="477.5067864159962" transform="rotate(0)"><tspan id="SvgjsTspan1294" dy="16" x="347.70394160551035"><tspan id="SvgjsTspan1295">Object.notify</tspan></tspan><tspan id="SvgjsTspan1296" dy="16" x="347.70394160551035"><tspan id="SvgjsTspan1297">Object.notifyAll</tspan></tspan><tspan id="SvgjsTspan1298" dy="16" x="347.70394160551035"><tspan id="SvgjsTspan1299">LockSupport.unpark</tspan></tspan></text></g><g id="SvgjsG1300"><path id="SvgjsPath1301" d="M483 410.00284481048584C 483 473.2483980138534 549.7544467966325 500.00284481048584 613 500.00284481048584" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1302)"></path><rect id="SvgjsRect1304" width="160" height="31" x="444.28291754873715" y="463.2199272617487" fill="#ffffff"></rect><text id="SvgjsText1305" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="160px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="461.2699272617487" transform="rotate(0)"><tspan id="SvgjsTspan1306" dy="16" x="524.2829175487371"><tspan id="SvgjsTspan1307">当前线程等待进入</tspan></tspan><tspan id="SvgjsTspan1308" dy="16" x="524.2829175487371"><tspan id="SvgjsTspan1309">synchronized方法或代码块</tspan></tspan></text></g><g id="SvgjsG1310"><path id="SvgjsPath1311" d="M722 500.00284481048584C 787.4137050277544 500.00284481048584 843.9119262695312 404.7471532821655 592.0340741737109 400.7440257653833" stroke="#323232" stroke-width="2" fill="none" marker-end="url(#SvgjsMarker1312)"></path><rect id="SvgjsRect1314" width="117" height="15" x="717.501371008196" y="444.3746081067279" fill="#ffffff"></rect><text id="SvgjsText1315" font-family="微软雅黑" text-anchor="middle" font-size="13px" width="117px" fill="#323232" font-weight="400" align="top" anchor="middle" family="微软雅黑" size="13px" weight="400" font-style="" opacity="1" y="442.42460810672793" transform="rotate(0)"><tspan id="SvgjsTspan1316" dy="16" x="776.001371008196"><tspan id="SvgjsTspan1317">当前线程成功获得锁</tspan></tspan></text></g></svg></p> <h6 id="synchronize"><a href="#synchronize" class="header-anchor">#</a> synchronize</h6> <blockquote><p>锁, 锁了对象o, 和拿到锁后执行的代码需要分开</p> <p>锁对象o -- 锁this -- 锁方法在</p> <p>对于 <code>static</code> 方法被 <code>synchronize</code> 修饰, 锁的是这个类的类对象(class)  T.class 单例或存在于不同的classLoad</p> <p>synchronize 必须是可重入锁, 考虑到父子类继承 synchronize 构造, 子类调父类可重入才能不死锁</p> <p>程序中出现异常, 默认锁会被释放</p></blockquote> <h6 id="synchronize的底层实现"><a href="#synchronize的底层实现" class="header-anchor">#</a> synchronize的底层实现</h6> <blockquote><p>Hotspot 的实现是, 在该对象头上使用两位来代表锁的类型/状态, 还在对象头上记录了哪个线程获得了这把锁</p> <p>JDK 早期的synchronize是重量级的悲观锁, 直接向OS申请, 后期改进为锁升级</p> <p>首先记录这个线程ID (偏向锁) , 自用没有问题 (也是加在对象头中)</p> <p>如果有线程争用, 升级为自旋锁 (占用CPU, 但是不调用内核)</p> <p>轻量级锁?</p> <p>自旋10次后, 升级为重量级锁, 向OS</p> <p>============以上为Hotspot的JVM实现==============</p> <p>(加锁代码) 执行时间长, 线程特别多的 用OS锁, 因为自旋会占用CPU资源</p> <p>反之使用自旋锁</p></blockquote> <h6 id="第一天回顾"><a href="#第一天回顾" class="header-anchor">#</a> 第一天回顾</h6> <blockquote><p>线程概念, 启动方式, 常用方法</p> <ul><li>少讲的问题, synchronize(Obj) 不能锁定String常量, Integer Long 的这些常量, 会造成锁了这些常量的不同的方法块都会进行争抢, 性能大幅降低</li></ul> <p>线程同步中的 synchronize</p> <ul><li>锁的是对象 this, t.class</li> <li>锁升级</li></ul></blockquote> <h2 id="第二天-synchronized-volatile-cas"><a href="#第二天-synchronized-volatile-cas" class="header-anchor">#</a> 第二天 synchronized volatile CAS</h2> <h3 id="volatile"><a href="#volatile" class="header-anchor">#</a> volatile</h3> <blockquote><ol><li>保证线程可见性
<ul><li>java里面有堆内存, 每个线程有自己私有的工作内存, 访问堆内存先cp一份放在工作空间中, 修改值首先修改自己工作内存中再写回堆内存, 什么时候其他线程再向堆读取更新后的值是不可控制的, 这叫内存不可见</li> <li>底层实现 使用了CPU的缓存一致性协议 MESI等</li></ul></li> <li>禁止指令重排序
<ul><li>DCL(Double Check Lock) 单例, 要加volatile
<ul><li>首先, new一个对象的过程(1初始化 2赋值 3和栈内存中的引用联系) 当发生指令重排序, 2和3位置调换, 会出现生成了一个未赋值的引用, 这时候在一开始的判断对象是不为空的, 但是对象的内容只有初始化值</li> <li>使用 volatile 能够保证操作这个对象的指令不会重排序</li></ul></li> <li><code>singleton/Mgr06.java</code> DCL代码</li></ul></li> <li>volatile并不保证原子性, 不能替代synchronize</li> <li>CPU层面实现禁止指令重排序
<ol><li>lfence sfence mfence 内存屏障(针对CPU)</li> <li>lock 指令</li></ol></li> <li>volatile 使用 lock addl 0x0 实现, 主要是为了执行lock指令, 使lock前后指令按顺序执行!</li></ol></blockquote> <h4 id="jsr内存屏障-背过-volatile-jvm层面的实现细节"><a href="#jsr内存屏障-背过-volatile-jvm层面的实现细节" class="header-anchor">#</a> JSR内存屏障 (背过) volatile JVM层面的实现细节</h4> <blockquote><p>(JVM规范要求) 只是一种规范, 不是真正硬件底层实现, 一般JVM使用 lock 指令 或 lfence指令来达到这个规范!</p> <p>volatile的规范内容:</p> <p>StoreStoreBarrier				LoadLoadBarrier</p> <p>volatile写							  volatile 读</p> <p>StoreLoadBarrier				LoadStoreBarrier</p></blockquote> <h4 id="volatile-修饰对象需要打问号"><a href="#volatile-修饰对象需要打问号" class="header-anchor">#</a> volatile 修饰对象需要打问号!!</h4> <blockquote><p>还是别修饰了吧您内</p></blockquote> <h4 id="happens-before-原则-实现jvm需要保证哪些情况下不允许指令重排序"><a href="#happens-before-原则-实现jvm需要保证哪些情况下不允许指令重排序" class="header-anchor">#</a> happens-before 原则 (实现JVM需要保证哪些情况下不允许指令重排序)</h4> <blockquote><p>JLS17.4.5</p> <p>unlock必须在lock后, volatile的一些规则, 线程启动, wait, 打断的一些规则</p></blockquote> <h4 id="as-if-serial-不管如何重排序-单线程执行结果不会改变"><a href="#as-if-serial-不管如何重排序-单线程执行结果不会改变" class="header-anchor">#</a> as_if_serial 不管如何重排序, 单线程执行结果不会改变!</h4> <blockquote><p>这些指令随便怎么乱序执行, 看上去就像是顺序执行一样!</p></blockquote> <h4 id="面试题-singletreadpool-任务按顺序执行"><a href="#面试题-singletreadpool-任务按顺序执行" class="header-anchor">#</a> 面试题: SingleTreadPool 任务按顺序执行</h4> <h6 id="synchronize-锁优化"><a href="#synchronize-锁优化" class="header-anchor">#</a> synchronize 锁优化</h6> <blockquote><p>锁的细化, 锁粒度的细化, 分离出不需要加锁的业务逻辑</p> <p>锁的粗化, 如果一个方法中有很多地方需要加锁, 不如就把整个方法都锁了避免太多竞争</p></blockquote> <h6 id="synchronize-锁对象的问题"><a href="#synchronize-锁对象的问题" class="header-anchor">#</a> synchronize 锁对象的问题</h6> <blockquote><p>在有竞争的情况下, 锁定的引用对象如果发生改变(引用指向了另外的对象), 那么之前的那把锁就会失效, 所以请不要改变锁定的引用对象 (加final)</p></blockquote> <h6 id="cas-无锁优化-自旋-自旋锁-乐观锁-无锁"><a href="#cas-无锁优化-自旋-自旋锁-乐观锁-无锁" class="header-anchor">#</a> CAS-无锁优化/自旋/自旋锁/乐观锁/无锁</h6> <blockquote><p>由于有些常规操作, 多线程情况下特别容易加锁, java提供了一些线程安全的操作方法(CAS), 凡是在 <code>java.util.concurrent.atomic</code> 包下的类都使用CAS保证线程安全</p> <p>用法 - 自己去用 <code>AtomicInteger count; count.incrementAndGet();</code></p></blockquote> <h6 id="原理-cas操作"><a href="#原理-cas操作" class="header-anchor">#</a> 原理 - CAS操作</h6> <blockquote><p><code>AtomicInteger</code> 中调用了 <code>unsafe</code> 类中的 <code>compareAndSet</code> (atomic类的实现都用了这个)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//获取需要修改的值V, 看是不是Expected我所期望的值, </span>
<span class="token comment">//如果是, 就改成newvalue</span>
<span class="token comment">//如果不是(说明有人改了), 将Expected值更新后重复CAS, 或者失败</span>
<span class="token function">cas</span><span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">Expected</span><span class="token punctuation">,</span> <span class="token class-name">New</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">V</span> <span class="token operator">==</span> <span class="token class-name">E</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">V</span> <span class="token operator">=</span> <span class="token class-name">New</span> <span class="token class-name">Value</span><span class="token punctuation">}</span> 
<span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">try</span> again or fail <span class="token punctuation">}</span>	<span class="token comment">// ABA问题</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>CAS 是CPU原语支持 (lock cmpxchg)</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>Compare And Set
cas(V, Expected, NewValue)
	if V == E
	V = New
	otherwise try again or fail
	CPU原语支持
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h6 id="aba-问题"><a href="#aba-问题" class="header-anchor">#</a> ABA 问题</h6> <blockquote><p>CAS中, 有线程把对象修改后又修改回来, CAS无法识别ABA操作! (女友复合问题)</p> <p>一般没问题, 但如果需要识别, 给修改对象添加版本号(version), CAS时比较版本号</p> <p>Atomic包下有用于添加版本号的类 AtomicStampedReference 额外维护了一个时间戳</p></blockquote> <h6 id="unsafe-类-简单了解"><a href="#unsafe-类-简单了解" class="header-anchor">#</a> Unsafe 类 简单了解</h6> <blockquote><p>写在前面, blog: <a href="https://baijiahao.baidu.com/s?id=1648712942552745701" target="_blank" rel="noopener noreferrer">首先在Oracle的Jdk8无法获取到sun.misc包的源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>构造方法 private, 单例, jdk8不能用(反射可以), 只有jdk源码能用, jdk11<a href="https://segmentfault.com/a/1190000018037554" target="_blank" rel="noopener noreferrer">还是反射调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>是一个直接操作JVM内存的类, 申请/分配/销毁内存(内存管理), 修改数据/对象/线程, 提供CAS机制, 等同于C和C++的指针</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 直接操作内存
	allocateMemory putXX freeMemory pageSize
- 直接生成类实例
	allocateInstance
- 直接操作类或实例变量
	objectFieldOffset
	getInt
	getObject
- CAS相关操作
	weakCompareAndSetObject Int Long
- c &gt; malloc free
- c++ &gt; new delete
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="第三天-reentrantlock-等api"><a href="#第三天-reentrantlock-等api" class="header-anchor">#</a> 第三天 ReentrantLock 等api</h2> <h6 id="比较几种加锁的方式"><a href="#比较几种加锁的方式" class="header-anchor">#</a> 比较几种加锁的方式</h6> <blockquote><p>简单的测试, 对于每种加锁的情况要根据实际线程数量和数据操作量来测试</p> <p>LongAdder 使用了数组/分段锁(分治思想), 将线程数平摊, 最终将数据整合, 线程越多的时候效果明显 ConcurrentHashMap也用到了这种思想(本身就是数组)</p></blockquote> <h6 id="可重入锁-reentrantlock"><a href="#可重入锁-reentrantlock" class="header-anchor">#</a> 可重入锁 ReentrantLock</h6> <blockquote><p>可重入锁: 获得锁的线程重复调用加锁的方法</p> <p>synchronize 本身就是可重入锁</p> <p>ReentrantLock 是新加入用来替代 synchronize 的, 使用时候需要加锁和手动解锁</p> <p>拥有的额外功能</p> <p><code>tryLock</code> 在一段时间内尝试去获得这把锁, 返回boolean, 是否获得到, 可以控制获取不到锁怎么办</p> <p><code>lockInterruptibly</code> 线程等待获取lock的时候可以被打断, 抛出异常, 结束线程</p> <p><code>new ReentrantLock(true);</code> 公平锁(默认是不公平的) 新线程会先去查看等待队列是否有线程, 有就进入等待队列, 没有就竞争锁</p></blockquote> <h6 id="countdownlatch-倒数的门栓"><a href="#countdownlatch-倒数的门栓" class="header-anchor">#</a> CountDownLatch 倒数的门栓</h6> <blockquote><p>倒数技术, 等到多少个线程结束(每个线程要减少, 每个线程不一定只倒数一次)</p> <p>示例代码是相当于当前线程join要等待的所有线程</p></blockquote> <h6 id="cyclicbarrier-循环栅栏"><a href="#cyclicbarrier-循环栅栏" class="header-anchor">#</a> CyclicBarrier 循环栅栏</h6> <blockquote><p><code>newCyclicBarrier(20, new Runnable(){...})</code> 满20人发车(满20个线程向下运行), 否则等待</p></blockquote> <h6 id="phaser-阶段"><a href="#phaser-阶段" class="header-anchor">#</a> Phaser 阶段</h6> <blockquote><p>按照不同阶段执行, 需要定义线程的注册/注销, 等待线程数量, 执行阶段等</p> <p>场景: 遗传算法</p></blockquote> <h6 id="readwhitelock-读写锁-共享锁-排他锁-互斥锁"><a href="#readwhitelock-读写锁-共享锁-排他锁-互斥锁" class="header-anchor">#</a> ReadWhiteLock 读写锁 (共享锁&amp;排他锁/互斥锁)</h6> <blockquote><p><code>Lock readLock = readWriteLock.readLock();</code> 获取读锁, 共享的, 可以让读线程读, 但是不允许写</p> <p><code>Lock writeLock = readWriteLock.writeLock();</code> 获取写锁, 排他的</p></blockquote> <p>自己要去了解 StampedLock</p> <h6 id="semaphore-信号量"><a href="#semaphore-信号量" class="header-anchor">#</a> Semaphore 信号量</h6> <blockquote><p><code>new Semaphore(1)</code> 设置信号量, 还可以设置是否公平, 是否先去排队(AQS队列)</p> <p><code>s.acquire()</code> 获得信号, 并使信号量减一, 如果没有信号量, 等着</p> <p><code>s.release()</code> 把信号还回去, 信号量加一, 别人可以继续获得</p> <p>场景: 限流, 最多允许同时运行的线程数量 (买票)</p></blockquote> <h6 id="exchanger-交换器"><a href="#exchanger-交换器" class="header-anchor">#</a> Exchanger 交换器</h6> <blockquote><p>线程之间交换数据</p> <p><code>Exchanger.exchange()</code> 阻塞!</p> <p>维护了两个格子, 收集数据后互相交换</p></blockquote> <h2 id="第四天-面试题-locksupport-源码阅读技巧"><a href="#第四天-面试题-locksupport-源码阅读技巧" class="header-anchor">#</a> 第四天 面试题 LockSupport 源码阅读技巧</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>淘宝面试题
	1. 实现一个容器, 提供两个方法, add, size ; 写两个线程, 线程1添加10个元素到容器中, 线程2实现监控元素个数, 当个数到5个时, 线程2给出提示并结束;
	2. 写一个固定容量同步容器, 拥有put和get方法, 以及getCount方法, 能够支持2个生产者线程以及10个消费者线程的阻塞调用;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上节课少讲了LockSupport</p> <h6 id="locksupport"><a href="#locksupport" class="header-anchor">#</a> LockSupport</h6> <blockquote><p><code>LockSupport.park()</code></p> <p><code>LockSupport.unpark(t1)</code>  可以在park之前调用</p> <p>让线程阻塞, 唤醒</p> <p>还是 unsafe 类的 park , 调用了底层C代码</p></blockquote> <p>面试题目1</p> <blockquote><p>volatile 实际中尽量别用, 用也要修饰简单变量, 修饰引用不会作用到引用对象的属性, 别的线程还是不可见</p> <p><code>obj.notify()</code> 不释放锁! 不会释放锁, 只是通知</p> <p><code>obj.wait()</code> 释放锁! 立即释放锁以便其他线程执行</p> <p><code>wait + notify</code> 需要牢牢掌握</p> <p><code>countDownLatch</code> 门栓*2</p> <p><code>LockSupport</code></p></blockquote> <p>面试题目2</p> <blockquote><p>生产消费者问题 - 我第一次阅读理解有问题</p> <p>我的解法是读写锁, get/getCount读锁不能写可以一起读, put写锁互斥锁,其他都不可以 - 有问题</p> <p>synchronize 可以写</p> <p>ReentranLock 可以设置不同的 条件Condition 两个版本都可以背</p> <p>Condition 本质是不同的等待队列</p> <p><code>while</code> 不要用 <code>if</code></p></blockquote> <p>第四天作业</p> <blockquote><p>要求用线程顺序打印A1B2C3...Z26</p> <p>阅读 CountDownLatch</p></blockquote> <p>ReentrantLock 源码阅读</p> <blockquote><p>被劝退去学设计模式</p> <p>画图 UML 方法之间的调用, 类图</p> <p>模板方法, 钩子函数</p> <p>AQS (CLH) 核心结构 state 由子类来定义 下跟队列(装Thread, 双向链表) 重点是如何入队出队</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>源码阅读原则: 
- 跑不起来不读
- 解决问题就好
- 一条线索到底
- 无关细节略过
- 一般不读静态
- 一般动态读法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="https://p0.meituan.net/travelcube/7132e4cef44c26f62835b197b239147b18062.png" alt="CLH队列"></p> <h2 id="第五天-aqs-threadlocal-四种引用"><a href="#第五天-aqs-threadlocal-四种引用" class="header-anchor">#</a> 第五天 AQS ThreadLocal 四种引用</h2> <h6 id="aqs源码阅读"><a href="#aqs源码阅读" class="header-anchor">#</a> AQS源码阅读</h6> <blockquote><p>AQS 尾部添加节点, 使用CAS操作tail, 只要观测tail节点, 来替代锁操作(提高效率!)</p> <p>如果用锁, 整个队列锁住会导致效率大幅降低</p> <p><code>acquireQueued</code>  拿到前置节点, 如果前置节点是头结点, 就去竞争, 如果拿到了锁, 就把自己设置为头结点 否则就阻塞, 等前置节点叫醒自己</p> <ul><li>VarHandler 句柄/指针/引用 (jdk1.9之后才有), 用来将基础类型作为引用类型来操作, handle还可以做cas, 原子性的加法, ++等,  效率高, 直接操作二进制码</li></ul></blockquote> <h6 id="threadlocal"><a href="#threadlocal" class="header-anchor">#</a> ThreadLocal</h6> <blockquote><p>每个线程中拥有自己的一份</p> <p>set值设置到了当前线程的map里, 不同线程拥有自己的Map</p> <p>应用场景: 声明式事务, 保证同一个Connection</p></blockquote> <h6 id="强引用-普通引用"><a href="#强引用-普通引用" class="header-anchor">#</a> 强引用, 普通引用</h6> <blockquote><p>java引用有四种, 强 软 弱 虚</p> <p>强引用, 就是普通的引用, 强引用的对象不会被回收</p></blockquote> <h6 id="softreference"><a href="#softreference" class="header-anchor">#</a> SoftReference</h6> <blockquote><p>软引用, 当有对象被软引用的时候, 只有系统内存不够用的时候会回收这个对象, 跑测试的时候需要设置 -Xms:20M -Xmx:20M (堆内存最小20m, 最大20m) 可以用做缓存...</p></blockquote> <h6 id="weakreference"><a href="#weakreference" class="header-anchor">#</a> WeakReference</h6> <blockquote><p>弱引用, 只要GC看到这个对象被弱引用的时候, 直接回收, 当强引用取消指向这个对象, 这个对象很快就会被回收</p> <p>使用场景: 容器里, ThreadLocal</p> <p>ThreadLocalMap中所存的key是弱引用指向ThreadLocal对象, 当线程结束, tl不指向ThreadLocal了, ThreadLocal就会被回收, 如果key是强引用, 这种情况下回造成内存泄漏, ThreadLocal永远不会被回收</p> <p>但即使jdk已经这样设定了弱引用, key-value值依旧存在(无法访问到, 构成内存泄漏), 这时候必须调用 ThreadLocal 对象的 remove() 方法来解决, 使用ThreadLocal时必须要注意</p></blockquote> <p><img src="https://user-gold-cdn.xitu.io/2019/9/10/16d1a23292305e7c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></p> <h6 id="虚引用-phantomreference"><a href="#虚引用-phantomreference" class="header-anchor">#</a> 虚引用 PhantomReference</h6> <blockquote><p>对api调用基本没用, 给写JVM/写框架的人回收堆外内存用的</p> <p>另: 一般生产环境中JVM堆内存最大最小设置一样</p> <p>GC看到就回收虚引用的对象, 虚引用还关联一个队列QUEUE, 只要自己被回收, 就在这个队列里放入一条记录, 只是给个通知使用.. 里面的值你都拿不到(所以没用)</p> <p>NIO中有个 DirectByteBuffer 直接内存, 可以指向JVM堆外内存, GC没有办法回收到堆外内存, JVM通过检测虚引用的通知QUEUE, 来回收堆外内存 unsafe</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>DirectByteBuffer -----------------&gt; 堆外内存
		^
		|
		|
		|
Queue[ = = = = = ]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h6 id="第五天作业"><a href="#第五天作业" class="header-anchor">#</a> 第五天作业</h6> <blockquote><p>AQS unlock源码</p> <p>WeakHashMap 类源码</p></blockquote> <h2 id="第六天-各种容器-queue"><a href="#第六天-各种容器-queue" class="header-anchor">#</a> 第六天 各种容器 QUEUE</h2> <blockquote><p>为了讲线程池作为铺垫, 需要背这张图↓</p></blockquote> <ul><li>Collection
<ul><li>List
<ul><li>CopyOnWriteList</li> <li>Vector
<ul><li>Stack</li></ul></li> <li>ArrayList</li> <li>LinkedList</li></ul></li> <li>Set
<ul><li>HashSet, LinkedHashSet</li> <li>SortedSet, TreeSet</li> <li>EnumSet</li> <li>CopyOnWriteArraySet</li> <li>ConcurrentSkipListSet</li></ul></li> <li>Queue
<ul><li>Deque</li> <li>BlockingQueue
<ul><li>ArrayBlockingQueue</li> <li>LinkedBlockingQueue</li> <li>PriorityBlockingQueue</li> <li>TransferQueue , LinkedTransferQueue</li> <li>SynchronousQueue</li></ul></li> <li>PriorityQueue</li> <li>ConcurrentLinkedQueue</li> <li>DelayQueue</li></ul></li></ul></li> <li>Map
<ul><li>HashMap
<ul><li>LinkedHashMap</li></ul></li> <li>TreeMap</li> <li>WeakHashMap</li> <li>IdentityHashMap</li></ul></li></ul> <blockquote><p>物理上的存储结构只有两种: Array 和 LinkedList</p> <p>Queue 主要用于高并发</p> <p>Deque 双端队列</p> <p>Java 1.0 只有 Vector 和 HashTable, 相关操作都加上了 synchronized, 现在基本不用</p> <p>后面陆续加上 HashMap, synchronizedHashMap, ConcurrentHashMap</p></blockquote> <h6 id="性能测试用例-以实测为主"><a href="#性能测试用例-以实测为主" class="header-anchor">#</a> 性能测试用例, 以实测为主</h6> <blockquote><p>ConcurrentHashMap 插入效率低, 读取效率高非常多 相比于HashTable和SynchronizedMap</p> <p>售票 Vector -- Queue.</p> <p>ConcurrentLinkedQueue CAS保证原子性</p></blockquote> <h6 id="线程安全的map-和不安全的map"><a href="#线程安全的map-和不安全的map" class="header-anchor">#</a> 线程安全的Map 和不安全的Map</h6> <blockquote><p>HashMap 无序, TreeMap 红黑树实现 有序</p> <p>ConcurrentHashMap CAS红黑树实现复杂, 所以没有Concurrent的TreeMap</p> <p>ConcurrentSkipListMap 跳表, 有序, 代替实现线程安全的TreeMap</p></blockquote> <h6 id="copyonwritelist-set-写时复制"><a href="#copyonwritelist-set-写时复制" class="header-anchor">#</a> CopyOnWriteList / Set 写时复制</h6> <blockquote><p>写的少, 读的多, 读的时候不加锁, 写的时候在原来的基础上复制一份List/Set, 做完写操作之后将原引用指向操作后的复制List/Set , 以此来保证线程安全</p> <p>add() 加锁, 数组扩容一格, 将数据放入</p> <p>本质上就是读写锁的变形</p></blockquote> <h6 id="queue-接口的基本操作-与list区别"><a href="#queue-接口的基本操作-与list区别" class="header-anchor">#</a> Queue 接口的基本操作, 与List区别?</h6> <blockquote><p>添加了对线程友好的api</p> <p>offer() 添加</p> <p>poll() 查询并删除</p> <p>peek() 查询不删除</p></blockquote> <h6 id="blokingqueue"><a href="#blokingqueue" class="header-anchor">#</a> BlokingQueue</h6> <blockquote><p>重点在于Blocking 阻塞</p> <p>对生产者消费者友好的线程安全模型</p> <p>在原来Queue的基础上添加了两个阻塞方法</p> <p>put() 装, 如果Queue满了, 该线程会阻塞住</p> <p>take() 拿, 如果Queue空了, 该线程会阻塞住</p> <p>源码使用 Condition的await()和signal()</p> <p>LinkedBlokingQueue 无界, 但不能超过Integer.MAX_VALUE</p> <p>ArrayBlokingQueue 有界</p> <p>SynchronusQueue</p> <p>TransferQueue</p></blockquote> <h6 id="delayqueue"><a href="#delayqueue" class="header-anchor">#</a> DelayQueue</h6> <blockquote><p>队列中加入任务需要实现Delayed接口, 定义参数, 定义参数之间比较的方法, 可以指定任务的执行顺序</p> <p>使用场景: 按时间进行任务调度</p></blockquote> <h6 id="priorityqueue"><a href="#priorityqueue" class="header-anchor">#</a> PriorityQueue</h6> <blockquote><p>底层是小顶堆?, 会根据策略对加入元素进行排序</p></blockquote> <h6 id="synchronusqueue-容量为0"><a href="#synchronusqueue-容量为0" class="header-anchor">#</a> SynchronusQueue 容量为0</h6> <blockquote><p>和 Exchanger 类似</p> <p>容量永远为0 , 直接put会一直阻塞, 直到有其他线程take()</p> <p>而使用其他方法比如add() 会直接报错, 因为队列满了</p> <p>等于两个线程交换数据</p> <p>线程池中用处最大的Queue</p></blockquote> <h6 id="transferqueue"><a href="#transferqueue" class="header-anchor">#</a> TransferQueue</h6> <blockquote><p>把数据放在队列中, 然后阻塞, 等有人把这个数据拿走之后再继续运行</p></blockquote> <h2 id="第七天-线程池"><a href="#第七天-线程池" class="header-anchor">#</a> 第七天 线程池</h2> <h6 id="两个线程-顺序打印a1b2c3-z26"><a href="#两个线程-顺序打印a1b2c3-z26" class="header-anchor">#</a> 两个线程 顺序打印A1B2C3...Z26</h6> <blockquote><p>重点掌握 wait notify 和 LockSupport</p> <p>锁下面的等待队列, notify是随机叫醒一个, condition是等待队列, 可以同一个锁有多个等待队列</p> <p>cas, LockSupport, BlockingQueue, PipedStream(效率低), exchanger</p></blockquote> <h6 id="线程池-executor-executorservice"><a href="#线程池-executor-executorservice" class="header-anchor">#</a> 线程池 Executor ExecutorService</h6> <blockquote><p>Executor 执行者, 其中有执行的方法</p> <p>ExecutorService 继承于 Executor , 拓展了执行者的生命周期</p></blockquote> <h6 id="callable"><a href="#callable" class="header-anchor">#</a> Callable</h6> <blockquote><p>与Runnable类似, 区别是call() 拥有返回值</p></blockquote> <h6 id="future"><a href="#future" class="header-anchor">#</a> Future</h6> <blockquote><p>Callable返回值该怎么拿到? Future来保存异步执行的结果</p> <p>Future的get()是阻塞的, 线程池的submit(Callable) 是异步的</p> <p>异步一般是区别于同步:</p> <p>同步: 执行的方法有返回值, 需要等到执行结束之后拿到返回值才可以继续运行后面的代码</p> <p>异步: 不需要等到返回值就可以运行后面的代码</p></blockquote> <h6 id="futuretask"><a href="#futuretask" class="header-anchor">#</a> FutureTask</h6> <blockquote><p>实现了RunnableFuture, 也就是继承了Runnable和Future, 使得自己又是可执行的任务, 又能够存储异步执行的结果</p> <p>更加好用的类</p> <p>场景: ForkJoinPool WorkStealingPool</p></blockquote> <h6 id="completablefuture"><a href="#completablefuture" class="header-anchor">#</a> CompletableFuture</h6> <blockquote><p>任务的管理类</p> <p>底层负责, 使用灵活, 使用ForkJoinPool</p> <p>supplyAsync() 异步提交任务</p> <p>allOf(future1, future2 ...) 对批量任务进行管理</p> <p>异步调用的写法 thenApply() thenAccept()</p></blockquote> <h6 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h6> <blockquote><p>维护着线程集合 和任务集合</p></blockquote> <h6 id="threadpoolexecutor"><a href="#threadpoolexecutor" class="header-anchor">#</a> ThreadPoolExecutor</h6> <blockquote><p>继承于AbstractExcutorService, 线程池的执行器</p></blockquote> <h6 id="手动定义线程池-7个参数-背过"><a href="#手动定义线程池-7个参数-背过" class="header-anchor">#</a> 手动定义线程池, 7个参数 <u>背过</u></h6> <blockquote><ol><li>核心线程数 不会归还OS的线程</li> <li>最大线程数 超出核心线程, 最大额外扩展的线程总数</li> <li>生存时间 额外线程不使用的timeout后还给OS</li> <li>时间单位</li> <li>任务队列 各种BlockingQueue, 用来装任务, 不同的队列可以产生不同的线程池</li> <li>线程工厂, 需要传ThreadFactory,</li></ol> <ul><li>实现newThread()方法, 定义产生线程的方式, 可以定义线程名字, 线程组名字(用于jstack排查问题!) 定义守护线程, 优先级等</li></ul> <ol start="7"><li>拒绝策略</li></ol> <ul><li>线程池忙, 任务队列满的时候执行的策略, JDK默认提供4种(基本不用), 一般情况下自定义</li> <li>Abort抛异常</li> <li>Discard扔掉(不加入任务队列)</li> <li>DiscardOldest扔掉任务队列中存在最久的(最早加入的)</li> <li>CallerRuns调用者(线程)处理任务</li></ul></blockquote> <h2 id="第八天"><a href="#第八天" class="header-anchor">#</a> 第八天</h2> <blockquote><p>Executors 线程池的工厂</p> <p>newSingleThreadExecutor(); 线程池只能运行一个线程, 能保证扔进去的线程顺序执行</p></blockquote> <h6 id="singlethreadexecutor"><a href="#singlethreadexecutor" class="header-anchor">#</a> SingleThreadExecutor</h6> <blockquote><p>为什么要有单线程的线程池?</p> <p>任务队列, 生命周期管理</p> <p>参数: 核心1, 最大1, 时间0, LinkedBlockingQueue(Integer.MAX_VALUE)</p></blockquote> <h6 id="cachedthreadpool"><a href="#cachedthreadpool" class="header-anchor">#</a> CachedThreadPool</h6> <blockquote><p>核心0, 最大Int.MAX_VALUE, 时间60s, SynchronousQueue</p> <p>基本上来一个任务直接启动, 使用还未到60s的空线程或线程满的时候新建线程, 可能启动线程非常多</p></blockquote> <h6 id="fixedthreadpool"><a href="#fixedthreadpool" class="header-anchor">#</a> FixedThreadPool</h6> <blockquote><p>指定固定的线程数</p> <p>核心x, 最大x, 时间0, LinkedBlockingQueue</p></blockquote> <h6 id="cached-vs-fixed"><a href="#cached-vs-fixed" class="header-anchor">#</a> Cached VS Fixed</h6> <blockquote><p>任务不会堆积, 需要处理的线程数量差异较大 - Cached</p> <p>足够的线程处理 - Fixed</p> <p>Alibaba 都不用, 估算后自定义</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>调整线程池大小
	如果线程池中线程数量过多, 最终会竞争稀缺的处理器和内存资源, 浪费大量的时间在上下文切换上;
	线程池大小与处理器利用率之比可以用下面的公式进行估算
	N(thread) = N(CPU) * U(CPU) * (1 + W/C)
			  处理器核数	  期望CPU利用率	 等待时间与计算时间的比率
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h6 id="scheduledthreadpool"><a href="#scheduledthreadpool" class="header-anchor">#</a> ScheduledThreadPool</h6> <blockquote><p>定时任务的线程池</p> <p>quartz cron 定时任务框架, 一般用这个</p> <p>核心x, DelayedWorkQueue</p> <p>scheduleAtFixedRate 固定频率执行任务</p></blockquote> <h6 id="面试题-提供一个闹钟服务-订阅服务的人特别多-10亿-怎么优化"><a href="#面试题-提供一个闹钟服务-订阅服务的人特别多-10亿-怎么优化" class="header-anchor">#</a> 面试题: 提供一个闹钟服务, 订阅服务的人特别多(10亿), 怎么优化?</h6> <blockquote><p>分治</p></blockquote> <h6 id="concurrent-parallel"><a href="#concurrent-parallel" class="header-anchor">#</a> concurrent parallel</h6> <blockquote><p>并发指任务提交, 并行指任务执行, 并行是并发的子集, 并发量, 并行度</p></blockquote> <h6 id="threadpoolexecutor-源码"><a href="#threadpoolexecutor-源码" class="header-anchor">#</a> ThreadPoolExecutor 源码</h6> <blockquote><p>addWorker() 添加线程 CAS</p> <p>worker数量先加一</p> <p>启动Worker</p> <p>worker extends AQS implements Runnable</p></blockquote> <h6 id="workstealingpool"><a href="#workstealingpool" class="header-anchor">#</a> WorkStealingPool</h6> <blockquote><p>原来的线程池是线程集合去任务队列中获取任务</p> <p>每一个线程都有自己单独维护的队列, 当某个线程执行完自己的任务, 去别的线程的任务队列中偷任务执行</p> <p>单独队列 VS 共享队列</p> <p>本质上是一个 ForkJoinPool</p></blockquote> <p><img src="https://img-blog.csdnimg.cn/20200628182327254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzQyNDgzMzQx,size_1,color_FFFFFF,t_70" alt=""></p> <h6 id="forkjoinpool"><a href="#forkjoinpool" class="header-anchor">#</a> ForkJoinPool</h6> <blockquote><p>分解汇总的任务, 把大的任务切分成一个个小任务执行(Fork), 小任务切成更小的任务, 切分逻辑可以自己定义, 执行完之后可以进行结果的汇总(Join)</p> <p>用很少的线程可以执行很多的任务(子任务) TPE做不到先执行子任务</p> <p>CPU密集型</p> <p>ForkJoinTask 需要定义特殊的任务, 可以ForkJoin的任务</p> <p>RecursiveAction 递归任务</p></blockquote> <h2 id="第九天-jmh-disruptor-生产环境测试工具"><a href="#第九天-jmh-disruptor-生产环境测试工具" class="header-anchor">#</a> 第九天 JMH Disruptor 生产环境测试工具</h2> <h6 id="jmh-性能测试"><a href="#jmh-性能测试" class="header-anchor">#</a> JMH 性能测试</h6> <blockquote><p>Java Microbenchmark Harness 基本测试</p> <p>warmup 预热 为了提前使JVM本地化</p> <p>fork 启动多少线程执行</p> <p>benchmarkMode 测试模式 Mode.Throughput 吞吐量</p> <p>Measurement 整个测试程序执行测试多少次, 执行间隔多少时间</p></blockquote> <h6 id="disruptor"><a href="#disruptor" class="header-anchor">#</a> Disruptor</h6> <blockquote><p>单机最快的消息队列</p></blockquote> <p><img src="https://img-blog.csdnimg.cn/20200629103312331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzQyNDgzMzQx,size_1,color_FFFFFF,t_70" alt="1595742181425"></p> <blockquote><p>核心: 环形buffer ringbuffer</p> <p>生产者将消息放入环形buffer中, 当生产的消息想要放置的位置发现已经被其他未消费的消息占用了, 会启动等待策略(默认提供了8种)</p> <p>队列(ringbuffer)中存储着事件Event, 由EventFactory生成, 由EventHandler来消费</p> <p>启动Disruptor默认填充满ringbuffer(加速)</p> <p>EventTranslator lambda表达式方式生成Event</p></blockquote> <h6 id="生产者类型-single-multi"><a href="#生产者类型-single-multi" class="header-anchor">#</a> 生产者类型 Single Multi</h6> <blockquote><p>single 不加锁/不安全/速度快, multi 加锁/安全</p></blockquote> <h6 id="等待策略"><a href="#等待策略" class="header-anchor">#</a> 等待策略</h6> <blockquote><p>BlockingWaitStrategy 生产满了, 阻塞</p> <p>YieldingWaitStrategy 让出cpu, 试图让消费者先消费</p> <p>SleepingWaitStrategy sleep一会</p></blockquote> <h6 id="多消费者"><a href="#多消费者" class="header-anchor">#</a> 多消费者</h6> <blockquote><p>handlerEventsWith(...)</p></blockquote> <h6 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h6> <blockquote><p>handleExceptionsFor().with()</p></blockquote> <h3 id="纤程-协程"><a href="#纤程-协程" class="header-anchor">#</a> 纤程/协程</h3> <p><img src="https://img-blog.csdnimg.cn/20200402214422641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMjYyNTcx,size_16,color_FFFFFF,t_70#pic_center" alt="1596381077713"></p> <blockquote><p>程序可以启动, - 多个进程 , 进程有多个线程 , 线程可以有多个纤程</p> <p>线程和纤程都是通过内存栈的保存实现</p> <p>纤程切换不调度内核级别资源, 而线程需要(重量级的调度)</p> <p>线程无法大量创建, 会导致CPU的切换大量消耗资源</p></blockquote> <h4 id="quasar"><a href="#quasar" class="header-anchor">#</a> Quasar</h4> <blockquote><p>agent 代理实现</p> <p>实现纤程保留自己的栈</p></blockquote></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/7/2021, 12:08:35 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.42575a28.js" defer></script><script src="/assets/js/2.0d7d09b8.js" defer></script><script src="/assets/js/30.fe8fe8c0.js" defer></script>
  </body>
</html>
