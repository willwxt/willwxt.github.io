<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高并发负载均衡 LVS + keepalived | SUCKED BloG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.42575a28.js" as="script"><link rel="preload" href="/assets/js/2.0d7d09b8.js" as="script"><link rel="preload" href="/assets/js/51.1fb1863e.js" as="script"><link rel="prefetch" href="/assets/js/10.1a30ebe5.js"><link rel="prefetch" href="/assets/js/100.022f696a.js"><link rel="prefetch" href="/assets/js/101.06eb0acb.js"><link rel="prefetch" href="/assets/js/102.e944c220.js"><link rel="prefetch" href="/assets/js/103.45b9da9a.js"><link rel="prefetch" href="/assets/js/104.cf53f5d1.js"><link rel="prefetch" href="/assets/js/105.200d7fe5.js"><link rel="prefetch" href="/assets/js/106.a0cc3502.js"><link rel="prefetch" href="/assets/js/107.4a71d17e.js"><link rel="prefetch" href="/assets/js/108.d7a39a75.js"><link rel="prefetch" href="/assets/js/109.35619cf9.js"><link rel="prefetch" href="/assets/js/11.f78ae8b3.js"><link rel="prefetch" href="/assets/js/110.f667d72e.js"><link rel="prefetch" href="/assets/js/111.de83ce6f.js"><link rel="prefetch" href="/assets/js/112.417d40bf.js"><link rel="prefetch" href="/assets/js/113.0f26c1ca.js"><link rel="prefetch" href="/assets/js/114.c7014acb.js"><link rel="prefetch" href="/assets/js/115.b502c0f1.js"><link rel="prefetch" href="/assets/js/116.10fb230e.js"><link rel="prefetch" href="/assets/js/117.f7cb9e2a.js"><link rel="prefetch" href="/assets/js/118.978d3075.js"><link rel="prefetch" href="/assets/js/119.09272191.js"><link rel="prefetch" href="/assets/js/12.140aa2af.js"><link rel="prefetch" href="/assets/js/120.32b5dbd7.js"><link rel="prefetch" href="/assets/js/121.8d618bbb.js"><link rel="prefetch" href="/assets/js/122.dcd4190d.js"><link rel="prefetch" href="/assets/js/123.2ee061d1.js"><link rel="prefetch" href="/assets/js/124.5a3760a7.js"><link rel="prefetch" href="/assets/js/125.a874a4bc.js"><link rel="prefetch" href="/assets/js/126.c6c6b7e6.js"><link rel="prefetch" href="/assets/js/127.38c35051.js"><link rel="prefetch" href="/assets/js/128.8d775ac8.js"><link rel="prefetch" href="/assets/js/129.6100ddb1.js"><link rel="prefetch" href="/assets/js/13.b2a6e590.js"><link rel="prefetch" href="/assets/js/130.9a83da2a.js"><link rel="prefetch" href="/assets/js/131.22de7670.js"><link rel="prefetch" href="/assets/js/132.f88798bf.js"><link rel="prefetch" href="/assets/js/133.925bbfed.js"><link rel="prefetch" href="/assets/js/134.481fad71.js"><link rel="prefetch" href="/assets/js/135.c3efb09b.js"><link rel="prefetch" href="/assets/js/136.758c447a.js"><link rel="prefetch" href="/assets/js/137.dcde1032.js"><link rel="prefetch" href="/assets/js/138.616a346b.js"><link rel="prefetch" href="/assets/js/139.b58dd07f.js"><link rel="prefetch" href="/assets/js/14.15374560.js"><link rel="prefetch" href="/assets/js/140.62b4c7ea.js"><link rel="prefetch" href="/assets/js/15.ffd155fa.js"><link rel="prefetch" href="/assets/js/16.feb1b022.js"><link rel="prefetch" href="/assets/js/17.6d491eb6.js"><link rel="prefetch" href="/assets/js/18.03ddaa95.js"><link rel="prefetch" href="/assets/js/19.021bbcc8.js"><link rel="prefetch" href="/assets/js/20.8aa708b0.js"><link rel="prefetch" href="/assets/js/21.59d7a21e.js"><link rel="prefetch" href="/assets/js/22.21597439.js"><link rel="prefetch" href="/assets/js/23.77303f0b.js"><link rel="prefetch" href="/assets/js/24.0789ed5b.js"><link rel="prefetch" href="/assets/js/25.244a12a8.js"><link rel="prefetch" href="/assets/js/26.a6ee95e4.js"><link rel="prefetch" href="/assets/js/27.9e0f0e9d.js"><link rel="prefetch" href="/assets/js/28.189031c5.js"><link rel="prefetch" href="/assets/js/29.b3100d33.js"><link rel="prefetch" href="/assets/js/3.2a5d4cd5.js"><link rel="prefetch" href="/assets/js/30.fe8fe8c0.js"><link rel="prefetch" href="/assets/js/31.86fec3f7.js"><link rel="prefetch" href="/assets/js/32.24cac061.js"><link rel="prefetch" href="/assets/js/33.f1db2ed0.js"><link rel="prefetch" href="/assets/js/34.c220692f.js"><link rel="prefetch" href="/assets/js/35.9e7b4779.js"><link rel="prefetch" href="/assets/js/36.0cb1d1bc.js"><link rel="prefetch" href="/assets/js/37.7d1fcf79.js"><link rel="prefetch" href="/assets/js/38.bc9bc4b3.js"><link rel="prefetch" href="/assets/js/39.10801a2a.js"><link rel="prefetch" href="/assets/js/4.b4d9a5aa.js"><link rel="prefetch" href="/assets/js/40.c980543d.js"><link rel="prefetch" href="/assets/js/41.3f4581d8.js"><link rel="prefetch" href="/assets/js/42.60b85cdf.js"><link rel="prefetch" href="/assets/js/43.1338528d.js"><link rel="prefetch" href="/assets/js/44.786fc51f.js"><link rel="prefetch" href="/assets/js/45.d65f6744.js"><link rel="prefetch" href="/assets/js/46.543c2b26.js"><link rel="prefetch" href="/assets/js/47.59f19ed2.js"><link rel="prefetch" href="/assets/js/48.60de6b25.js"><link rel="prefetch" href="/assets/js/49.f3df62ef.js"><link rel="prefetch" href="/assets/js/5.013522c1.js"><link rel="prefetch" href="/assets/js/50.fd9871d6.js"><link rel="prefetch" href="/assets/js/52.c06ce3f3.js"><link rel="prefetch" href="/assets/js/53.a3d55203.js"><link rel="prefetch" href="/assets/js/54.89ac64bc.js"><link rel="prefetch" href="/assets/js/55.ccf38d1e.js"><link rel="prefetch" href="/assets/js/56.ffb8595b.js"><link rel="prefetch" href="/assets/js/57.5f1bd695.js"><link rel="prefetch" href="/assets/js/58.7463616d.js"><link rel="prefetch" href="/assets/js/59.ea4eb5dd.js"><link rel="prefetch" href="/assets/js/6.72ad7c85.js"><link rel="prefetch" href="/assets/js/60.a2add219.js"><link rel="prefetch" href="/assets/js/61.3eae0362.js"><link rel="prefetch" href="/assets/js/62.801d1658.js"><link rel="prefetch" href="/assets/js/63.b47a17bb.js"><link rel="prefetch" href="/assets/js/64.d5e2bdea.js"><link rel="prefetch" href="/assets/js/65.24d540f4.js"><link rel="prefetch" href="/assets/js/66.09a1ae52.js"><link rel="prefetch" href="/assets/js/67.75bd38e7.js"><link rel="prefetch" href="/assets/js/68.1fe6956e.js"><link rel="prefetch" href="/assets/js/69.d3306c2d.js"><link rel="prefetch" href="/assets/js/7.60760bb7.js"><link rel="prefetch" href="/assets/js/70.95aa4503.js"><link rel="prefetch" href="/assets/js/71.7065ebf0.js"><link rel="prefetch" href="/assets/js/72.55ae5081.js"><link rel="prefetch" href="/assets/js/73.c7624eee.js"><link rel="prefetch" href="/assets/js/74.63bcc7bd.js"><link rel="prefetch" href="/assets/js/75.e2731e20.js"><link rel="prefetch" href="/assets/js/76.1711af80.js"><link rel="prefetch" href="/assets/js/77.f1c4e2d3.js"><link rel="prefetch" href="/assets/js/78.900bc856.js"><link rel="prefetch" href="/assets/js/79.a1b8c47b.js"><link rel="prefetch" href="/assets/js/8.0c261cf2.js"><link rel="prefetch" href="/assets/js/80.7cf435bf.js"><link rel="prefetch" href="/assets/js/81.fa33b2af.js"><link rel="prefetch" href="/assets/js/82.cdabd386.js"><link rel="prefetch" href="/assets/js/83.879fc50c.js"><link rel="prefetch" href="/assets/js/84.7e460788.js"><link rel="prefetch" href="/assets/js/85.339356d5.js"><link rel="prefetch" href="/assets/js/86.d526418c.js"><link rel="prefetch" href="/assets/js/87.12877e38.js"><link rel="prefetch" href="/assets/js/88.d5a7d193.js"><link rel="prefetch" href="/assets/js/89.2f4a62c2.js"><link rel="prefetch" href="/assets/js/9.50eda380.js"><link rel="prefetch" href="/assets/js/90.6d83f5bf.js"><link rel="prefetch" href="/assets/js/91.f3364825.js"><link rel="prefetch" href="/assets/js/92.158fcc7a.js"><link rel="prefetch" href="/assets/js/93.0c4e5f88.js"><link rel="prefetch" href="/assets/js/94.c5725f80.js"><link rel="prefetch" href="/assets/js/95.dc61d501.js"><link rel="prefetch" href="/assets/js/96.3a598fc5.js"><link rel="prefetch" href="/assets/js/97.712aa8be.js"><link rel="prefetch" href="/assets/js/98.e757fe7a.js"><link rel="prefetch" href="/assets/js/99.1418024a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SUCKED BloG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>高并发负载均衡 LVS + keepalived</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/point/07access/lvs.html#第二节" class="sidebar-link">第二节</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/07access/lvs.html#第三节" class="sidebar-link">第三节</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/point/07access/lvs.html#第三节-2" class="sidebar-link">第三节</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="高并发负载均衡-lvs-keepalived"><a href="#高并发负载均衡-lvs-keepalived" class="header-anchor">#</a> 高并发负载均衡 LVS + keepalived</h1> <p><a href="https://cloud.tencent.com/developer/article/1115533" target="_blank" rel="noopener noreferrer">LVS原理知多少<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://zh.linuxvirtualserver.org/handbooks" target="_blank" rel="noopener noreferrer">LVS中文站点-手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>目录: 高并发 负载均衡 高可用</p> <blockquote><p>从闲聊开始: 中国 - 入网人口基数 - 硅谷亚太研究院 - 营销 - 陌陌 - 流量-&gt;VIP用户 - 高并发 - 计算渠道引流的质量 - 计算每个渠道的转化率和购买力 - 转服务service行业</p> <p>高并发的重要性</p></blockquote> <h4 id="为什么要分层-osi-分层解耦"><a href="#为什么要分层-osi-分层解耦" class="header-anchor">#</a> 为什么要分层? OSI? - 分层解耦!</h4> <blockquote><p>开发人员可能只需要接触应用层</p> <p>其中任何一层需要维护更改, 其他任何一层不会受到影响!!</p></blockquote> <h5 id="osi七层参考模型"><a href="#osi七层参考模型" class="header-anchor">#</a> OSI七层参考模型</h5> <blockquote><p>只是模型, 没有实现</p></blockquote> <h3 id="tcp-ip-协议"><a href="#tcp-ip-协议" class="header-anchor">#</a> TCP/IP 协议</h3> <blockquote><p>定义了实现七层参考模型的协议规范</p></blockquote> <h5 id="每层可以出现不同的协议"><a href="#每层可以出现不同的协议" class="header-anchor">#</a> 每层可以出现不同的协议</h5> <blockquote><p>协议, 通信时候的约定, 报文格式</p></blockquote> <h4 id="http协议"><a href="#http协议" class="header-anchor">#</a> HTTP协议</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 骚操作</span>
<span class="token builtin class-name">cd</span> /proc/<span class="token variable">$$</span>/fd
<span class="token comment"># 表示当前运行程序的PID 在bash直接运行就是bash的pid 将这句写进脚本test.sh，运行test.sh时 $$表示执行脚本test.sh的进程的PID</span>
<span class="token comment"># fd 文件描述符</span>
<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">8</span>&lt;&gt;</span> /dev/tcp/www.baidu.com/80
<span class="token comment"># 在这个目录下创建 8(输入输出) 指向这个磁盘目录</span>
<span class="token comment"># 现在先创建了 socket</span>
<span class="token builtin class-name">echo</span> -e <span class="token string">'GET / HTTP/1.0<span class="token entity" title="\n">\n</span>'</span> <span class="token operator">&gt;&amp;</span> <span class="token number">8</span>
<span class="token comment"># -e将\n识别为换行符  &gt; 输出重定向  &gt;&amp; 表示8不是文件, 是文件描述符 'GET / HTTP/1.0\n' HTTP协议规定 </span>
<span class="token comment"># 将请求头发给socket</span>
<span class="token function">cat</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;&amp;</span> <span class="token number">8</span>
<span class="token comment"># 标准输入0 来自文件描述符8 # 把这个socket怼到当前命令行上 # 把output打印出来</span>
<span class="token builtin class-name">exec</span> <span class="token operator"><span class="token file-descriptor important">8</span>&lt;&amp;</span> - <span class="token comment"># 把8关掉</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>第一步建立连接</p> <p>第二步才是传送数据（http协议：规范标准）</p> <p>最终给你演示的是一个应用层协议</p></blockquote> <h4 id="流程"><a href="#流程" class="header-anchor">#</a> 流程</h4> <blockquote><p>应用层浏览器整理数据后, 调用传输控制层, 逐级向下调用, 最终是通过物理层进行发送</p> <p>应用层是用户态</p> <p>从传输控制层往下基本上都是内核态</p></blockquote> <h4 id="传输控制层"><a href="#传输控制层" class="header-anchor">#</a> 传输控制层</h4> <blockquote><p>TCP(面向连接, 可靠) UDP(不可靠)</p></blockquote> <h4 id="面向连接"><a href="#面向连接" class="header-anchor">#</a> 面向连接</h4> <blockquote><p>互相确认</p></blockquote> <h4 id="三次握手-为什么三次握手才能建立连接"><a href="#三次握手-为什么三次握手才能建立连接" class="header-anchor">#</a> 三次握手 为什么三次握手才能建立连接</h4> <blockquote><p>C == S ;</p> <p>s回复之后在等对方确认, 所以需要&quot;第三次握手&quot; (TCP可靠, 需要得到回复来保证可靠)</p> <p>三次握手之后双方才会开辟内存资源 建立连接</p> <p>socket 可以有的端口数量是 65535 , 不可能创建端口后不去关闭, 会达到操作系统端口上限, 所以要分手</p></blockquote> <h4 id="四次挥手-分手"><a href="#四次挥手-分手" class="header-anchor">#</a> 四次挥手/分手</h4> <blockquote><p>C == S ;</p> <p>因为TCP是可靠的传输机制, 发送信息之后对方都会返回我收到了 , 但是因为 S端 有可能还需要处理一些数据(或是还需要发送数据等) ,  所以 C端 需要一起处理直到等到 S端 发送一个可以开始断开链接的请求</p></blockquote> <h4 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h4> <blockquote><p>三次握手 - 数据传输 - 四次分手</p> <p>成为一个最小粒度, 不可被分割 --- 端点之间的传输数据是不允许被打散的 (分布式Case)</p> <p>没必要只有一个单独的确认过程, 可以额外带上数据包</p></blockquote> <h4 id="netstat-natp-nltp"><a href="#netstat-natp-nltp" class="header-anchor">#</a> netstat -natp/nltp</h4> <blockquote><p>n IP地址不要用逻辑名称显示 a 所有 t tcp p pid</p></blockquote> <table><thead><tr><th>Local Address</th> <th>Foreign Address</th> <th>State</th> <th>PID</th></tr></thead> <tbody><tr><td>本地</td> <td>对端</td> <td>连接状态</td> <td>使用进程</td></tr></tbody></table> <blockquote><p>SOCKET 就是一个 本地ip:port + 对端ip:port 独立的连接</p></blockquote> <h4 id="网络层"><a href="#网络层" class="header-anchor">#</a> 网络层</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> /etc/sysconfig/network-scripts/ifcfg-eth0
<span class="token comment"># if interface cfg config 接口配置 eth0 eth enternet</span>
<span class="token comment"># IP NETMASK GATEWAY DNS 四个维度</span>
<span class="token comment"># 通信id号点分字节 4个255</span>
<span class="token comment"># 掩码 二进制的按位与运算 得出网络号 192.168.150.0 主机位 14</span>
<span class="token comment"># 网关 </span>
route -n <span class="token comment"># 路由表</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="下一跳机制"><a href="#下一跳机制" class="header-anchor">#</a> 下一跳机制</h5> <blockquote><p>不需要存全网设备, 只需要知道自己一步之内的服务器位置</p></blockquote> <h5 id="路由表-所有设备都有路由表"><a href="#路由表-所有设备都有路由表" class="header-anchor">#</a> 路由表 所有设备都有路由表</h5> <blockquote><p>要访问 61.135.169.121 , 需要在路由表内堆Genmask做按位与运算(路由判定), 并匹配目标地址Destination</p> <p>路由表的最后一条条目, 无论什么地址都可以匹配并跳指网关, 称为默认网关</p> <p>网络工程师 --- 规划网络</p> <p>路由表的 Gateway 为 0.0.0.0 说明是同一个网络环境, 否则说明不是直连的(需要路由)</p></blockquote> <h4 id="链路层"><a href="#链路层" class="header-anchor">#</a> 链路层</h4> <blockquote><p>网络层只能找到下一跳, 链路层通过网络层计算出的IP解析为MAC来进行下一跳 (同一局域网内)</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>arp -a
<span class="token comment"># arp协议 解释IP地址和网卡硬件地址的映射 arp是同一局域网内的</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="arp"><a href="#arp" class="header-anchor">#</a> ARP</h4> <blockquote><p>计算机开机并没有 arp 表, 首先封装一个arp包(包含MAC地址FFFFFF, 默认网关)从网卡发送, 交换机会对这个包进行广播, 配对不成功的设备会把arp包丢弃, 而配对成功的设备会返回原地址一个带有自己MAC地址的arp包</p> <p>交换机 二层 具有学习能力(记录自己设备端口连接设备的MAC地址的能力)</p> <p>计算机连网后会先通告自己的地址, 减少arp请求过程</p></blockquote> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>最终数据包存有几个数据 确定最终给哪个设备/端点</p> <ol><li>链路层解析出来的MAC(下一跳)</li> <li>最终需要访问的IP地址</li> <li>最终需要访问的端口</li></ol> <p>过程中只有MAC地址会发生变化</p> <p>TCP/IP协议基于下一跳的机制, IP是端点间, MAC地址是节点间的</p> <h2 id="第二节"><a href="#第二节" class="header-anchor">#</a> 第二节</h2> <h4 id="操作"><a href="#操作" class="header-anchor">#</a> 操作</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 增加虚拟网卡 /24是掩码</span>
<span class="token function">ifconfig</span> eth0:3 <span class="token number">192.168</span>.88.88/24
<span class="token comment"># 增加路由表条目 -host是单个主机, -net需要给出掩码位</span>
route <span class="token function">add</span> -host <span class="token number">192.168</span>.88.88 gw <span class="token number">192.168</span>.150.13
route del -host <span class="token number">192.168</span>.88.88
<span class="token comment"># 通过增加路由表条目来访问对方网卡</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="网络中ip冲突-ip不能重复配置"><a href="#网络中ip冲突-ip不能重复配置" class="header-anchor">#</a> 网络中IP冲突 IP不能重复配置</h4> <h4 id="为什么tomcat慢"><a href="#为什么tomcat慢" class="header-anchor">#</a> 为什么TOMCAT慢</h4> <blockquote><p>应用层软件, 需要走完七层, 传输控制层必须完成了三次握手</p> <p>跑在JVM上, 内核中的虚拟机</p></blockquote> <h4 id="四层负载均衡服务器"><a href="#四层负载均衡服务器" class="header-anchor">#</a> 四层负载均衡服务器</h4> <blockquote><p>低层次的</p> <p>特别快, 不会和客户端握手, 数据包转发级别, 还能偷窥数据包中的请求IP, 端口</p> <p>后端的服务器必须是镜像的</p></blockquote> <h4 id="nat"><a href="#nat" class="header-anchor">#</a> NAT</h4> <blockquote><p>基于三-四层</p> <p>虚拟IP, 将虚拟出来的IP和自己IP的不同端口号进行映射来访问网络</p> <p>路由器还需要一张表, 替换源地址, 靠虚拟Client端口号来进行映射</p></blockquote> <h4 id="d-nat"><a href="#d-nat" class="header-anchor">#</a> D-NAT</h4> <blockquote><p>瓶颈: 通信非对称(上行少, 下行量多), 带宽, 算力</p></blockquote> <h4 id="思路-对外隐藏vip"><a href="#思路-对外隐藏vip" class="header-anchor">#</a> 思路: 对外隐藏VIP</h4> <blockquote><p>要对外隐藏VIP, 负载均衡服务器的包的VIP地址不能变更</p> <p>通过制造 CIP - VIP | RIP@MAC 跳到server</p></blockquote> <h4 id="dr-直接路由"><a href="#dr-直接路由" class="header-anchor">#</a> DR 直接路由</h4> <blockquote><p>基于二层 速度更快, 成本更低, 企业级使用最多</p> <p>MAC欺骗 (修改内核, 修改arp协议)</p> <p>缺陷: 因为是MAC欺骗, 所以负载均衡服务器和server必须在同一个局域网</p></blockquote> <h2 id="第三节"><a href="#第三节" class="header-anchor">#</a> 第三节</h2> <h4 id="tun隧道技术"><a href="#tun隧道技术" class="header-anchor">#</a> TUN隧道技术</h4> <blockquote><p>IP包 背着 IP包</p> <p>到达server端后解析(打开背包)</p> <p>PPPOE</p> <p>VPN &amp; 翻墙</p></blockquote> <h4 id="基础常识"><a href="#基础常识" class="header-anchor">#</a> 基础常识</h4> <blockquote><p>虚拟网卡lo</p> <p>127.0.0.1 localhost 请求发送直接rollback本机 lo是不和网络通信的 lo对外隐藏, 对内可见</p> <p>任何借口都有子接口</p></blockquote> <h4 id="调度算法"><a href="#调度算法" class="header-anchor">#</a> 调度算法</h4> <h4 id="静态调度"><a href="#静态调度" class="header-anchor">#</a> 静态调度</h4> <blockquote><p>rr 轮询 wrr dh sh</p></blockquote> <h4 id="动态调度算法"><a href="#动态调度算法" class="header-anchor">#</a> 动态调度算法</h4> <blockquote><p>lc 最少连接数</p> <p>...</p></blockquote> <h4 id="dr偷窥"><a href="#dr偷窥" class="header-anchor">#</a> DR偷窥</h4> <blockquote><p>通过偷窥客户端发送的 sync ack包, fin ack包, 来计算哪个服务有多少连接</p></blockquote> <h4 id="lvs"><a href="#lvs" class="header-anchor">#</a> LVS</h4> <blockquote><p>linux模块自带LVS 模块名称为ipvs</p> <p>ipvsadm 内核lvs模块的交互软件, 是用户态的使用C写的接口调用</p></blockquote> <h4 id="ipvsadm-基本操作"><a href="#ipvsadm-基本操作" class="header-anchor">#</a> ipvsadm 基本操作</h4> <blockquote><p>yum install ipvsadm -y 安装</p> <p>-A/-a 添加集群服务</p></blockquote> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <h4 id="vmware"><a href="#vmware" class="header-anchor">#</a> VMware</h4> <h4 id="虚拟网络"><a href="#虚拟网络" class="header-anchor">#</a> 虚拟网络</h4> <blockquote><p>VMware NAT Service</p> <p>创建虚拟网络(虚拟网卡), 地址是192.168.145.2 具有NAT功能, 并且VMware NAT Service实现和Internet之间的地址映射/转换, 可以上网</p> <p>其次, 在windows中创建虚拟网卡VMnet8, 地址为 192.168.145.1 网关指向192.168.145.2 使得windows本机可以访问到虚拟网络</p></blockquote> <h4 id="环回地址-loopback"><a href="#环回地址-loopback" class="header-anchor">#</a> 环回地址 loopback</h4> <blockquote><p>127.0.0.1 localhost</p> <p>lo 虚拟网卡</p></blockquote> <h4 id="实验手册"><a href="#实验手册" class="header-anchor">#</a> 实验手册</h4> <blockquote><p>其中一台作为LVS服务器, 持有RIP(真实访问IP)(这里使用eth0子IP) , 请求访问到之后给他后面带上服务器的MAC地址, 发到另外两台Server服务器</p> <p>Server服务器 lo网卡设置子IP(自己使用, 不共享到局域网)</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 增加虚拟网卡 /24是掩码 24个1</span>
<span class="token comment"># 也可以写 netmask 255.255.255.0</span>
<span class="token comment"># 首先给LVS主机增加访问IP</span>
<span class="token function">ifconfig</span> eth0:2 <span class="token number">192.168</span>.145.100/24 
<span class="token comment"># 禁用 down掉</span>
<span class="token function">ifconfig</span> eth0:2 down
<span class="token comment"># ***先设置隐藏协议, 再修改ip!!!********************</span>
<span class="token builtin class-name">cd</span> /proc/sys/ne/ipv4/conf/
<span class="token comment"># 修改下面的 eth0 和 all 两个接口</span>
<span class="token comment"># arp协议文件修改, 不能使用vim(不允许在该文件下创建缓存)</span>
arp_ignore 		<span class="token comment"># 0-&gt;1	使用 echo 1 &gt; arp_ignore 重定向</span>
arp_announce	<span class="token comment"># 0-&gt;2</span>
<span class="token comment"># 增加隐藏VIP 必须配255.255.255.255</span>
<span class="token function">ifconfig</span> lo:2 <span class="token number">192.168</span>.145.100 netmask <span class="token number">255.255</span>.255.255
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="搭建httpd"><a href="#搭建httpd" class="header-anchor">#</a> 搭建httpd</h5> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> httpd -y
<span class="token comment"># service httpd start</span>
<span class="token comment"># 创建一个主页 index.html</span>
<span class="token builtin class-name">cd</span> /var/www/html/	<span class="token comment"># 默认目录</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="使用lvs-ipvsadm"><a href="#使用lvs-ipvsadm" class="header-anchor">#</a> 使用lvs (ipvsadm)</h5> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 入包规则</span>
ipvsadm -A -t <span class="token number">192.168</span>.145.100:80 -s rr
ipvsadm -ln
ipvsadm -a -t <span class="token number">192.168</span>.145.100:80 -r <span class="token number">192.168</span>.150.12 -g -w <span class="token number">1</span>
ipvsadm -a -t <span class="token number">192.168</span>.145.100:80 -r <span class="token number">192.168</span>.150.13 -g -w <span class="token number">1</span>
ipvsadm -ln
ipvsadm -lnc	<span class="token comment"># 查看偷窥记录本</span>
<span class="token comment"># FIN_WAIT： 连接过，偷窥了所有的包</span>
<span class="token comment"># SYN_RECV(握手发送)： 基本上lvs都记录了，证明lvs没事，一定是后边网络层出问题</span>
ipvsadm -C <span class="token comment"># 清空</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="第三节-2"><a href="#第三节-2" class="header-anchor">#</a> 第三节</h2> <h4 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h4> <h4 id="lvs服务器可能挂掉"><a href="#lvs服务器可能挂掉" class="header-anchor">#</a> LVS服务器可能挂掉</h4> <blockquote><p>虽然服务没有下线但是用户无法访问</p></blockquote> <h4 id="server服务器可能挂掉"><a href="#server服务器可能挂掉" class="header-anchor">#</a> Server服务器可能挂掉</h4> <blockquote><p>LVS还拥有其负载条目, 会造成一部分用户无法访问</p></blockquote> <h4 id="单点故障的解决方式-一变多"><a href="#单点故障的解决方式-一变多" class="header-anchor">#</a> 单点故障的解决方式 一变多</h4> <blockquote><p>问题: VIP必须是唯一的</p> <p>两个思路:  1. 主备 2. 主主</p></blockquote> <h4 id="主备"><a href="#主备" class="header-anchor">#</a> 主备</h4> <p>方向性</p> <p>效率性</p> <h4 id="keepalived"><a href="#keepalived" class="header-anchor">#</a> keepalived</h4> <blockquote><p>代替人运维, 解决单点故障, 实现HA, 通用的工具</p> <ol><li>监控自己服务</li> <li>Master通过自己还活着, Backup监听Master状态, Backup选举</li> <li>配置</li> <li>对后端server做健康检查</li></ol> <p>Nginx也可以用keepalived保证HA</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token function">install</span> keepalived -y <span class="token comment"># 安装</span>
<span class="token builtin class-name">cd</span> /etc/keepalived/			<span class="token comment"># 配置文件夹 备份配置文件</span>
<span class="token comment"># 全局配置 </span>
<span class="token comment"># vrrp虚拟路由冗余协议 </span>
<span class="token comment"># virtual_server虚拟服务{real_server} 多个</span>
<span class="token comment"># 主机贵 备机便宜</span>
<span class="token comment"># 服务器多个网卡</span>
<span class="token comment"># 保证id的对应</span>
<span class="token comment"># 优先级</span>
<span class="token comment"># 权限</span>
<span class="token comment"># virtual_ipaddress VIP IP漂移</span>
<span class="token function">man</span> <span class="token number">5</span> keepalived.conf <span class="token comment"># 查看5类帮助文件</span>

<span class="token function">scp</span> ./keepalived.conf root@node04:<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>	<span class="token comment"># 远程拷贝</span>
<span class="token function">service</span> keepalived start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>LVS 没有数据备份的问题, 主机恢复后可以作为Master</p> <p>所有操作对用户来说都是透明的</p></blockquote> <h4 id="问题-2"><a href="#问题-2" class="header-anchor">#</a> 问题</h4> <blockquote><p>程序异常退出, 没有收回 VIP 和 LVS 配置 备机网卡也会出现 VIP</p> <p>三次握手或四次挥手会负载到不同服务器, 发送的数据包会丢包</p> <p>单兵作战</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/30/2021, 7:00:37 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.42575a28.js" defer></script><script src="/assets/js/2.0d7d09b8.js" defer></script><script src="/assets/js/51.1fb1863e.js" defer></script>
  </body>
</html>
