<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SUCKED BloG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/logo.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.35bcedcf.css" as="style"><link rel="preload" href="/assets/js/app.42575a28.js" as="script"><link rel="preload" href="/assets/js/2.0d7d09b8.js" as="script"><link rel="preload" href="/assets/js/92.158fcc7a.js" as="script"><link rel="prefetch" href="/assets/js/10.1a30ebe5.js"><link rel="prefetch" href="/assets/js/100.022f696a.js"><link rel="prefetch" href="/assets/js/101.06eb0acb.js"><link rel="prefetch" href="/assets/js/102.e944c220.js"><link rel="prefetch" href="/assets/js/103.45b9da9a.js"><link rel="prefetch" href="/assets/js/104.cf53f5d1.js"><link rel="prefetch" href="/assets/js/105.200d7fe5.js"><link rel="prefetch" href="/assets/js/106.a0cc3502.js"><link rel="prefetch" href="/assets/js/107.4a71d17e.js"><link rel="prefetch" href="/assets/js/108.d7a39a75.js"><link rel="prefetch" href="/assets/js/109.35619cf9.js"><link rel="prefetch" href="/assets/js/11.f78ae8b3.js"><link rel="prefetch" href="/assets/js/110.f667d72e.js"><link rel="prefetch" href="/assets/js/111.de83ce6f.js"><link rel="prefetch" href="/assets/js/112.417d40bf.js"><link rel="prefetch" href="/assets/js/113.0f26c1ca.js"><link rel="prefetch" href="/assets/js/114.c7014acb.js"><link rel="prefetch" href="/assets/js/115.b502c0f1.js"><link rel="prefetch" href="/assets/js/116.10fb230e.js"><link rel="prefetch" href="/assets/js/117.f7cb9e2a.js"><link rel="prefetch" href="/assets/js/118.978d3075.js"><link rel="prefetch" href="/assets/js/119.09272191.js"><link rel="prefetch" href="/assets/js/12.140aa2af.js"><link rel="prefetch" href="/assets/js/120.32b5dbd7.js"><link rel="prefetch" href="/assets/js/121.8d618bbb.js"><link rel="prefetch" href="/assets/js/122.dcd4190d.js"><link rel="prefetch" href="/assets/js/123.2ee061d1.js"><link rel="prefetch" href="/assets/js/124.5a3760a7.js"><link rel="prefetch" href="/assets/js/125.a874a4bc.js"><link rel="prefetch" href="/assets/js/126.c6c6b7e6.js"><link rel="prefetch" href="/assets/js/127.38c35051.js"><link rel="prefetch" href="/assets/js/128.8d775ac8.js"><link rel="prefetch" href="/assets/js/129.6100ddb1.js"><link rel="prefetch" href="/assets/js/13.b2a6e590.js"><link rel="prefetch" href="/assets/js/130.9a83da2a.js"><link rel="prefetch" href="/assets/js/131.22de7670.js"><link rel="prefetch" href="/assets/js/132.f88798bf.js"><link rel="prefetch" href="/assets/js/133.925bbfed.js"><link rel="prefetch" href="/assets/js/134.481fad71.js"><link rel="prefetch" href="/assets/js/135.c3efb09b.js"><link rel="prefetch" href="/assets/js/136.758c447a.js"><link rel="prefetch" href="/assets/js/137.dcde1032.js"><link rel="prefetch" href="/assets/js/138.616a346b.js"><link rel="prefetch" href="/assets/js/139.b58dd07f.js"><link rel="prefetch" href="/assets/js/14.15374560.js"><link rel="prefetch" href="/assets/js/140.62b4c7ea.js"><link rel="prefetch" href="/assets/js/15.ffd155fa.js"><link rel="prefetch" href="/assets/js/16.feb1b022.js"><link rel="prefetch" href="/assets/js/17.6d491eb6.js"><link rel="prefetch" href="/assets/js/18.03ddaa95.js"><link rel="prefetch" href="/assets/js/19.021bbcc8.js"><link rel="prefetch" href="/assets/js/20.8aa708b0.js"><link rel="prefetch" href="/assets/js/21.59d7a21e.js"><link rel="prefetch" href="/assets/js/22.21597439.js"><link rel="prefetch" href="/assets/js/23.77303f0b.js"><link rel="prefetch" href="/assets/js/24.0789ed5b.js"><link rel="prefetch" href="/assets/js/25.244a12a8.js"><link rel="prefetch" href="/assets/js/26.a6ee95e4.js"><link rel="prefetch" href="/assets/js/27.9e0f0e9d.js"><link rel="prefetch" href="/assets/js/28.189031c5.js"><link rel="prefetch" href="/assets/js/29.b3100d33.js"><link rel="prefetch" href="/assets/js/3.2a5d4cd5.js"><link rel="prefetch" href="/assets/js/30.fe8fe8c0.js"><link rel="prefetch" href="/assets/js/31.86fec3f7.js"><link rel="prefetch" href="/assets/js/32.24cac061.js"><link rel="prefetch" href="/assets/js/33.f1db2ed0.js"><link rel="prefetch" href="/assets/js/34.c220692f.js"><link rel="prefetch" href="/assets/js/35.9e7b4779.js"><link rel="prefetch" href="/assets/js/36.0cb1d1bc.js"><link rel="prefetch" href="/assets/js/37.7d1fcf79.js"><link rel="prefetch" href="/assets/js/38.bc9bc4b3.js"><link rel="prefetch" href="/assets/js/39.10801a2a.js"><link rel="prefetch" href="/assets/js/4.b4d9a5aa.js"><link rel="prefetch" href="/assets/js/40.c980543d.js"><link rel="prefetch" href="/assets/js/41.3f4581d8.js"><link rel="prefetch" href="/assets/js/42.60b85cdf.js"><link rel="prefetch" href="/assets/js/43.1338528d.js"><link rel="prefetch" href="/assets/js/44.786fc51f.js"><link rel="prefetch" href="/assets/js/45.d65f6744.js"><link rel="prefetch" href="/assets/js/46.543c2b26.js"><link rel="prefetch" href="/assets/js/47.59f19ed2.js"><link rel="prefetch" href="/assets/js/48.60de6b25.js"><link rel="prefetch" href="/assets/js/49.f3df62ef.js"><link rel="prefetch" href="/assets/js/5.013522c1.js"><link rel="prefetch" href="/assets/js/50.fd9871d6.js"><link rel="prefetch" href="/assets/js/51.1fb1863e.js"><link rel="prefetch" href="/assets/js/52.c06ce3f3.js"><link rel="prefetch" href="/assets/js/53.a3d55203.js"><link rel="prefetch" href="/assets/js/54.89ac64bc.js"><link rel="prefetch" href="/assets/js/55.ccf38d1e.js"><link rel="prefetch" href="/assets/js/56.ffb8595b.js"><link rel="prefetch" href="/assets/js/57.5f1bd695.js"><link rel="prefetch" href="/assets/js/58.7463616d.js"><link rel="prefetch" href="/assets/js/59.ea4eb5dd.js"><link rel="prefetch" href="/assets/js/6.72ad7c85.js"><link rel="prefetch" href="/assets/js/60.a2add219.js"><link rel="prefetch" href="/assets/js/61.3eae0362.js"><link rel="prefetch" href="/assets/js/62.801d1658.js"><link rel="prefetch" href="/assets/js/63.b47a17bb.js"><link rel="prefetch" href="/assets/js/64.d5e2bdea.js"><link rel="prefetch" href="/assets/js/65.24d540f4.js"><link rel="prefetch" href="/assets/js/66.09a1ae52.js"><link rel="prefetch" href="/assets/js/67.75bd38e7.js"><link rel="prefetch" href="/assets/js/68.1fe6956e.js"><link rel="prefetch" href="/assets/js/69.d3306c2d.js"><link rel="prefetch" href="/assets/js/7.60760bb7.js"><link rel="prefetch" href="/assets/js/70.95aa4503.js"><link rel="prefetch" href="/assets/js/71.7065ebf0.js"><link rel="prefetch" href="/assets/js/72.55ae5081.js"><link rel="prefetch" href="/assets/js/73.c7624eee.js"><link rel="prefetch" href="/assets/js/74.63bcc7bd.js"><link rel="prefetch" href="/assets/js/75.e2731e20.js"><link rel="prefetch" href="/assets/js/76.1711af80.js"><link rel="prefetch" href="/assets/js/77.f1c4e2d3.js"><link rel="prefetch" href="/assets/js/78.900bc856.js"><link rel="prefetch" href="/assets/js/79.a1b8c47b.js"><link rel="prefetch" href="/assets/js/8.0c261cf2.js"><link rel="prefetch" href="/assets/js/80.7cf435bf.js"><link rel="prefetch" href="/assets/js/81.fa33b2af.js"><link rel="prefetch" href="/assets/js/82.cdabd386.js"><link rel="prefetch" href="/assets/js/83.879fc50c.js"><link rel="prefetch" href="/assets/js/84.7e460788.js"><link rel="prefetch" href="/assets/js/85.339356d5.js"><link rel="prefetch" href="/assets/js/86.d526418c.js"><link rel="prefetch" href="/assets/js/87.12877e38.js"><link rel="prefetch" href="/assets/js/88.d5a7d193.js"><link rel="prefetch" href="/assets/js/89.2f4a62c2.js"><link rel="prefetch" href="/assets/js/9.50eda380.js"><link rel="prefetch" href="/assets/js/90.6d83f5bf.js"><link rel="prefetch" href="/assets/js/91.f3364825.js"><link rel="prefetch" href="/assets/js/93.0c4e5f88.js"><link rel="prefetch" href="/assets/js/94.c5725f80.js"><link rel="prefetch" href="/assets/js/95.dc61d501.js"><link rel="prefetch" href="/assets/js/96.3a598fc5.js"><link rel="prefetch" href="/assets/js/97.712aa8be.js"><link rel="prefetch" href="/assets/js/98.e757fe7a.js"><link rel="prefetch" href="/assets/js/99.1418024a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35bcedcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SUCKED BloG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/other/index.html" class="nav-link">
  index
</a></div><div class="nav-item"><a href="/question/index.html" class="nav-link">
  question
</a></div><div class="nav-item"><a href="/audition/index.html" class="nav-link">
  audition
</a></div><div class="nav-item"><a href="/point/index.html" class="nav-link">
  point
</a></div><div class="nav-item"><a href="/work/index.html" class="nav-link">
  work
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="url" class="dropdown-title"><span class="title">url</span> <span class="arrow down"></span></button> <button type="button" aria-label="url" class="mobile-dropdown-title"><span class="title">url</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/config.html" class="nav-link">
  其他
</a></li><li class="dropdown-item"><!----> <a href="https://git.code.tencent.com/u/nampy" target="_blank" rel="noopener noreferrer" class="nav-link external">
  腾讯工蜂
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/willwxt" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://nbcb.icu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ol><li>JMM Java内存区域划分
程序计数器 JavaVMStack 本地方法栈 Java堆 方法区 其中:</li></ol> <p>Java堆和方法区是被所有线程&quot;共享&quot;的, 生命周期跟随JVM
程序计数器、Java虚拟机栈和本地方法栈是线程&quot;私有&quot;的, 生命周期跟随线程</p> <p>程序计数器: 	当前线程所执行字节码的行号指示器(记录地址,线程切换时保护现场); 分支、循环、跳转、异常处理、线程恢复等基础功能
JavaVMStack:	用于执行Java方法, 每个方法都有栈帧(Stack Frame)(存储局部变量表,操作数栈,动态链接(方法地址),方法出口(返回位置))
NativeMethodStack:		用于执行Native方法, 同样有StackOverflowError/OutOfMemoryError</p> <p>JavaHeap:		占用最大,存放大部分对象,GC主要管理区域
MethodArea:		就是perm Space(1.7)和metadata(1.8)存放class字节码,方法,接口..; 包括了(run-time constant pool运行时常量池)常量, 静态变量
要注意的是永久代和元数据区(其实都是方法区) 存放class,接口,方法,常量,动态生成的class ; 永久代必须指定大小,元数据区则无上限 ; 字符串常量放在永久代, 1.8开始放在堆</p> <p>Direct Memorey: 	直接内存,NIO分配的堆外内存</p> <p>JMM Java内存模型,Java虚拟机规范中的定义,用来屏蔽掉各种硬件和操作系统的内存访问差异,定义程序中各个变量的访问规则
1. 主内存(main mem)和工作内存(线程的work mem),工作内存不能互相访问,需要通过主内存;所有变量存在主内存;
2. 内存之间的交互操作,规定8种对内存的原子操作 lock unclock read load use assign store write 以及详细规则
3. volatile变量的特殊规则, 保证可见和静止指令重排, 对于上8条操作又新增三条规则
(1.每次使用都从主存重新读 2.每次修改必须同步回主存 3.保证相关联代码的顺序与执行顺序相同)
4. --对long和double变量的特殊规则 (支持32位非原子性) 没啥用
5. 原子性, 虽然不能直接使用lock和unlock; 可以用monitorenter和monitorexit(也就是synchronized)
6. 可见性, volatile,synchronized(释放锁之前必须写回主存),final(初始化就能看见)
7. 有序性, volatile,synchronized(只有一个线程能进行lock操作)
8. Happens-before
1. 线程中的每个操作 hb 线程的后续操作
2. 解锁 			hb 下一次同一个锁的加锁
3. 对volatile变量的写 hb 读
4. 传递性: 如果 A hb B ; B hb C ;那么 A hb C
5. Thread.start() 	hb 线程中的操作
6. 线程中的操作 	hb 线程的终止监测(join, isAlive)
7. interrupt() 		hb 检测中断事件(interrupted())
8. 对象的初始化 	hb 对象的finalize()方法</p> <p>as-if-serial 重排序的结果和顺序执行的一致</p> <ol start="2"><li>java文件从编码到执行 类加载过程, 类初始化过程 (或者称为生命周期?)
.java经过javac, 编译出.class文件, 然后被ClassLoader读取到内存中作为class对象, 通过解释器或JIT即时编译器(翻译或编译), 进入执行引擎, 最终调用OS, 硬件</li></ol> <p>加载class文件 (class文件的平台无关性)	获取二进制字节/转化为运行时结构数据/生成class对象作为访问入口
loading加载(放在方法区(永久代), jdk8开始在元数据区) 一般使用类加载器
linking (verification校验 - preparation准备:静态变量赋默认值 - resolution解析:将class中的符号变成真正的引用,包括方法,接口..)
initializing开始执行Java代码,执行<clinit>(),将静态变量赋值,初始化,在堆中生成类对象
Using使用 Unloading卸载</clinit></p> <p>类加载器 双亲委派 从下往上检查, 缓存中是否有, 都没有再从上往下查找并加载
(顺序: Bootstrap(核心类/lib) - Extension(扩展/lib/ext) - App(classpath) - Customer(自定义))
- 为什么要这样设置?	安全
- 如何打破?并举例?	
基础ClassLoader,不打破只需要重写findClass,打破双亲委派需要重写整个loadClass方法
主流web服务器都会自定义类加载器(如tomcat),1.应用程序要和Java类库隔离 2.多个应用程序的Jar包共享 3.支持热替换(jsp)</p> <ol start="3"><li>对象构成</li></ol> <p>new对象过程 也分为 1.申请内存 2.赋予默认值 3.调用初始化代码(成员变量复制&gt;构造方法)
JVM指令 new dup invokespecial astore_1</p> <p>对象大小, 普通对象的构成
1.对象头8字节; 2.ClassPointer指针,指向该对象的Class对象; 3.实例数据,保存的基本类型以及引用类型; 4.Padding对齐,对齐保证块读效率,保证是8字节的倍数
数组对象的构成
上面普通对象的第3条换成数组长度+数组数据</p> <p>可以使用Java Agent可以查看对象大小; 这里的指针有个指针压缩的概念,JVM参数(-XX:+UseCompressedOops);
Object大小: 对象头8+压缩的4+padding = 16字节
数组大小 : 	对象头8+压缩ClassPointer 4 + 数组长度4 = 16字节 (不压缩指针的话是24字节)</p> <h1 id="对象头markword-8字节-64位"><a href="#对象头markword-8字节-64位" class="header-anchor">#</a> 对象头markword 8字节(64位)</h1> <div class="language- extra-class"><pre><code>	存储内容 共64-2或32-2位					锁状态2位
</code></pre></div><h1 id="锁状态2位-4位-偏向锁1位-锁标志2位无锁对象的hashcode-分代年龄-0-01偏向锁线程id-epoch分代年龄-101轻量级指向轻量级锁的指针00重量级指向重量级锁的指针10gc标记empty11"><a href="#锁状态2位-4位-偏向锁1位-锁标志2位无锁对象的hashcode-分代年龄-0-01偏向锁线程id-epoch分代年龄-101轻量级指向轻量级锁的指针00重量级指向重量级锁的指针10gc标记empty11" class="header-anchor">#</a> 锁状态			2位 	4位 		偏向锁1位 	锁标志2位
无锁	对象的hashcode 	分代年龄 	0 			01
偏向锁	线程ID 	Epoch	分代年龄 	1			01
轻量级			指向轻量级锁的指针				00
重量级			指向重量级锁的指针				10
GC标记					empty					11</h1> <div class="language- extra-class"><pre><code>Epoch: 偏向锁的时间戳
为什么GC年龄默认为15? -因为分代年龄只有4bit来表示
hashcode部分: 调用c++的os:hashcode方法, 31位hashcode; 如果你重写了就不会存在对象头里; 对象的IdentityHashCode计算后,无法进入偏向锁状态
</code></pre></div><ol start="4"><li>Heap的内存模型 常见GC 以及 GC算法</li></ol> <p>如何找到垃圾
Reference Counting 引用计数法 特点: 实现简单效率高,问题是无法解决循环引用
Root Tracing 根可达算法 从roots开始找, 如引用不到的视为垃圾; 准确高效,实现较麻烦; GC roots包括:
JVM stack 虚拟机栈(比如main线程栈帧里面引用的对象)
native method stack 调用C, C++本地方法中引用的对象
run-time constant pool 常量池, 类对象T.class
static-references in method area 静态变量引用到的对象</p> <p>GC算法 垃圾回收算法	Mark-Sweep(标记清理) Coping(拷贝) Mark-Compact(标记压缩)</p> <div class="language- extra-class"><pre><code>Mark-Sweep(标记清理): 先标记一遍可回收的对象,第二遍回收;
特点:算法简单,存活对象多的情况下效率高;但是需要两遍扫描,且容易产生碎片,程序分配较大对象时无法找到足够的连续内存

Coping(拷贝): 将内存一分为二,把存活对象全部copy到一侧,最后清理掉另一侧,一般用于Eden+Survivor回收新生代
特点: (适用于Eden区)适用于存活对象较少的情况;只需要扫描一次,而且没有碎片;空间浪费,移动对象+调整引用

Mark-Compact(标记压缩): 先标记,然后回收+整理; 一般用于回收老年代
特点: 没有碎片,内存不会减半;但是需要扫描两次,移动对象+调整引用
</code></pre></div><p>遍历对象图的标记算法: 三色标记/三色遍历,一种广度优先搜索电线实现: 白色 灰色 黑色;
黑:已遍历完:已经被标记,且引用关系已经被处理(field)
灰:已遍历到:已经被标记,field还未标记,引用关系尚未处理
白:未遍历到:还未被标记的对象
过程: 1.一开始所有对象是白色 2.把根集合直接碰到的对象标记为灰色 3.逐个扫描灰色对象的出边,这些边直接碰到的对象标记为灰色,当一个对象的所有边都扫描完,把这个对象标记为黑色 4.重复3直到不再有灰色对象</p> <p>堆内存逻辑分区(仅适用于分代垃圾回收期)	Epsilon,ZGC,Shenandoah不使用分代模型, G1仅逻辑分代
逻辑分代模型: new/yound(Eden s1 s2) 	old/tenured	; 根据对象的存活周期的不同将内存划分为几块;</p> <p>新生代,主要用来存储新创建的对象,内存较小,YGC频繁(采用复制算法);YGC扫描Eden和一个S区,将存活的复制到另一个S区;下次扫描则将两个S区互换;当对象经过老年代标准的扫描后,进入老年代
老年代,主要用来存储长时间被引用的对象, 因为比较稳定所以FGC较少(采用标记-整理算法)
永久代,存储类元数据信息,如类定义,字节码和常量,GC不会对永久代进行清理,最终会OOM
元空间,并不在虚拟机中,而是使用本地内存来存储类元数据信息</p> <p>一个对象的出生到被回收(内存分配策略):
对象首先尝试在栈上分配,然后看是否是大对象(老年代),再看是否可以TLAB(线程),再进入Eden区,经过垃圾回收一次之后进入S1/S2(from/to),第二次垃圾回收后将Eden和S1的对象放入S2,经过多次重复流程之后进入Old区(可以是15次,或者s区占用了50%),最终FGC</p> <p>概念:
YGC/MinorGC FGC/MajorGC(System.gc())
栈上分配: 特定的小对象,在某段代码块中,而且是简单对象(可以被普通类型代替)
线程本地分配TLAB Thread Local Allocation Buffer: 首先堆是共享的,所以申请内存需要加锁;为了提升内存分配的效率,对于创建的线程都会分配一块独立的空间TLAB;在TLAB上分配对象效率很高(不加锁)
动态年龄: 根据s区所占百分比,达到后把年龄最大对象放入old去
分配担保: s满了,新来对象直接进入老年代
safe point: 线程马上停下可能会有问题,需要找到安全点才能STW
STW: stop the world
Remembered Set: 用于记录从非收集部分指向收集部分的指针的集合的抽象数据结构;是一种抽象概念;分代GC模型下,一般针对YGC来说,此时RSet记录的就是从老年代指向新生代的跨代指针;对于Regional收集器,则是记录跨region的指针(每个Region中都有一个RSet,记录哪些Region指向了自己),其价值在于不需要扫描整个堆就能够找到谁引用了当前Region的对象;
另: G1的RSet是一个hash表,key是指向本Region的Region,value是CardTable;
Card Table: CT可以是RSet的一种实现方式, 通过Dirty Table的方式记录哪些Card有跨代指针,需要扫描
Remembered Set和Card Table:
一般假设RSet是对象粒度,里面存有老年代对象的指针; CT是card粒度(2的次方的内存区域,如512字节),可能包含多个对象; 但其实你可以对两者的精度任意实现
一般假设RSet使用指针数组, CT使用字节数组来实现; 实际上CT是RSet的一种特殊实现.
Collection Set: G1中的概念,是GC需要回收的Region的集合,靠RSet实现,然后用copy算法把集合中的每个region存活对象拷贝到新的region里
write-barrier: 对&quot;对引用类型字段赋值&quot;这个动作的环切,有pre和post
mutator: 应用程序,STW需要停止的对象
Evacuation: 将region中存活对象复制到新region,并把旧region清空
SATB(snapshot at the beginning)(G1): SATB目的是维持在GC开始时存活对象的快照;把引用的改变推送到satb_mark_queue(通过write-barrier实现);用region记录的TAMS指针来记录新分配的对象
TAMS(top-at-mark-start): 在TAMS以上的对象就是新分配的,所谓的隐式marked</p> <p>GC 常见的垃圾回收期	
Serial		复制算法, 单线程
Serial Old	标记整理算法, 单线程
ParNew		复制算法,Serial的多线程版本,只有ParNew和Serial能和CMS配合工作
CMS			标记清理算法,jdk1.5 真正意义上的并发收集器,但无法和PS配合, 基于Mark-Sweep算法
初始标记, 只标记根对象(STW)
并发标记, 最浪费时间的, 标记现有能找到的对象(根可达)
并发预清理(preclean),
重新标记, 标记上个并发阶段发生改变的对象 (标记新的垃圾;或垃圾被重新引用,取消标记)(STW)
并发清理(sweep), 如果是并发过程中产生的垃圾(浮动垃圾),需要下次清理
内存整理/压缩, (STW)针对内存空间碎片,进行压缩/整理
并发重置状态,等待下次CMS触发
特点:
并发-&gt;吞吐量降低/无法处理浮动垃圾-&gt;Concurrent Mode Failure-&gt;临时启用Serial Old -XX:CMSInitiatingOccupancyFraction 启动CMS的阈值,不能设置太高,否则大量出现Concurrent Mode Failure;
标记清除算法带来的空间碎片,合并整理过程无法并发,STW时间过长: -XX:+UseCMSCompactAtFullCollection 开启内存碎片的合并整理过程; -XX:+CMSFullGCsBeforeCompaction 默认每次执行Full GC都会进行压缩整理
CMS算法: 并发标记的算法,CMS使用三色标记 + Incremental Update</p> <div class="language- extra-class"><pre><code>并发标记的漏标问题: 1.标记进行时增加了一个黑到白的引用(黑需要重新扫描); 2.标记时删除了灰到白的引用(白可能遍历不到)
增量更新解决漏标(Incremental Update)(CMS): 关注引用的增加,把黑重新标记为灰色,需要重新扫描(缺点)
</code></pre></div><p>Parallel Scavenge	复制算法,目标则是达到一个可控制的吞吐量(同时体现在调节策略上), 也是多线程版本的Serial
Parallel Old		标记整理算法,jdk1.6,多线程版的Serial Old
G1		重点关注响应时间,稍微牺牲吞吐量,算法为两大部分: 并发标记+拷贝存活对象
分治法,把物理内存分为多个Regions, Regions分为Eden Survivor Old Humongous</p> <div class="language- extra-class"><pre><code>初始标记,标记所有GC Roots可直接到达的对象,并将它们的字段压入扫描栈.G1使用外部的位图记录mark信息
并发标记,不断从扫描栈取出引用递归扫描,重复扫描过程直到栈清空,过程中还会扫描SATB所记录的引用
最终标记,每个Java线程还会有一些剩下的SATB记录,需要处理完;这个暂停只需要扫描SATB buffer(而CMS需要重新扫描dirtycard+根集合)
清理,(stw)清理并重置标记状态,类似于sweep,区别是G1在marking bitmap里统计每个region被标记为活的对象有多少,对各个Region的回收价值和成本进行排序,然后根据用户期望的GC停顿时间来制定回收计划,按计划回收一些价值高的Region,回收过程是copy到新的Region,并清空原Region(也就是所谓的Evacuation)
--特点: 并发收集,低停顿,还能建立可预测的停顿时间模型;
--做到这些的基础: 
write barrier: 1.实现SATB buffer的收集 2.实现RSet中跨Region的引用记录
选择任意数量的region来独立收集,构成收集集合CSet
G1的YGC: 选定所有年轻代里的region(作为CSet进行回收)
G1的MixedGC: 选定所有年轻代里的region+老年代排序后的部分region(作为CSet进行回收)
年轻代region总是在CSet内,所以G1的RSet不维护从年轻代出发的引用
G1的fullGC也是共用Serial Old的代码, 正常情况不会调用
</code></pre></div><p>ZGC		使用颜色指针+(load barrier): GC信息记录在指针上,而不是记录在对象头部,所以无法使用指针压缩(取指针中第19-22共4位作为标记,不同标记可以代表不同空间的虚拟地址)
Shenandoah	使用颜色指针+(write barrier)
Epsilon</p> <p>GC参数
使用各种GC
-XX:+UseConcMarkSweepGC -XX:+UseG1GC -XX:+UseSerialGC -XX:+UseParallelOldGC
禁止调用System.gc()
-XX:+DisableExplictGC
-Xmn -Xms -Xmx -Xss 年轻代 最小堆 最大堆 栈空间
-XX:+UseTLAB 使用TLAB，默认打开
-XX:+PrintGC -XX:+PrintGCDetails -XX:+PrintHeapAtGC 打印GC日志, 打印各种GC信息
-Xloggc:opt/log/gc.log 生成日志
-verbose:class 类加载详细过程
-XX:+PrintVMOptions打印JVM运行参数
-XX:MaxTenuringThreshold 设置分代年龄
-XX:PreBlockSpin JVM锁升级优化自旋次数
-XX:CompileThreshold JVM优化JIT热点代码检测参数
Parallel常用参数
-XX:SurvivorRatio Eden与S区比例, 默认 8:1:1
-XX:PreTenureSizeThreshold 直接分配到Old区的大对象到底多大
-XX:MaxTenuringThreshold 老年代阈值
-XX:+ParallelGCThreads 并行收集器的线程数
-XX:+UseAdaptiveSizePolicy 自动选择size/自适应
CMS常用参数
-XX:ParallelCMSThreads CMS线程数量
-XX:CMSInitiatingOccupancyFraction 老年代占用多少开始CMS,默认约68%,如果频繁发生SerialOld,应该调小
-XX:+UseCMSCompactAtFullCollection 在FGC时进行压缩 (解决碎片化的参数)
-XX:CMSFullGCsBeforeCompactio 多少次FGC之后进行压缩
-XX:MaxGCPauseMillis 停顿时间,CMS会建立模型去达到这个建议值
G1常用参数
-XX:MaxGCPauseMillis 停顿时间,G1会建立模型去达到这个建议值
-XX:+G1HeapRegionSize 设置region大小,建议逐渐增大该值,单位m
G1NewSizePercent G1MaxNewSizePercent 新生代比例 默认5-60% ConcGCThreads 线程数</p> <ol start="5"><li><p>调优过程
GC日志查看, 可以看到GC时间/消耗时间,原因,内存
调优概念: 1.根据需求进行JVM规划(预调优) 2.优化JVM运行/问题(卡顿,OOM) 3.重启
调优规划: 根据业务场景,选择合适垃圾回收期,计算服务器需求(内存,cpu),设定参数(设定GC日志,通过压力测试调参)
电商每日百万订单,订单处理系统需要什么配置? 先找到交易高峰,比如每秒1000笔,根据CPU处理时间和每个订单产生对象大小预估内存(避免频繁GC和OOM);最后要对服务器进行压测.
12306春运抢票支撑(偏架构设计): CDN-LVS-NGINX-业务系统
文档网站响应慢,原1.5G扩到16G反而变卡: 1.原网站慢是因为内存不足频繁GC, 2.增加内存后FGC时间更长
smile jira 提交测试报告系统(响应慢,需要频繁重启保持响应): 查看日志YGC频繁,dump定位原因失败,最终扩内存换G1回收器解决
其他可能问题: tomcat http-header-size过大;lambda表达式导致方法区溢出;直接内存溢出;重写finalize引发频繁GC;
3.解决:通过PSPO换CMS或G1
系统CPU经常100%,如何调优: CPU占用看线程,内存高看堆
1.首先要找出哪个进程 top -Hp pid命令查看子线程信息,找到哪个线程占用CPU高
2.导出该线程的堆栈信息 jps和jstack命令定位线程状态,重点关注比如WAITING BLOCKED线程状态(线程命名很重要)
3.通过这个对象地址,查找jstack dump日志中所有相关线程的信息,找到持有锁的线程
4.查找哪个方法(栈帧)消耗时间,占用CPU
5.查看工作线程和垃圾回收线程哪个占用CPU高
系统内存飙高,如何查找问题: 1.jmap导出堆内存 2.分析dump文件(jhat jvisualvm..)
如何监控JVM: jstat jvisualvm jprofiler arthas top jmx
基本命令
jps 只列举Java的进程
jstack 把所有java线程信息列出来,包括线程名,调用代码行,锁对象等
jinfo 把进程的一些详细信息列出来
jstat jstat gc pid 1000 打印各种区的大小, GC时间
jconsole 和 jvisualvm 是远程的可视化的控制台,需要开启JMX, jvisualvm也可以分析jmap出的dump文件
jmap 查看堆占用,导出堆文件,线上jmap执行期间占用资源过多会导致卡顿
1.设定OOM时候自动生成dump文件 2.多服务器情况下停一台jmap 3.使用在线分析工具Arthas
jhat 堆分析工具,分析dump文件,会开启http服务,对象数量/大小等信息,还可以使用OQL进行查询</p></li> <li><p>Arthas 在线排查工具
启动,选择线程,然后自动挂到线程上,可以在arthas里输入命令进行操作,查看jvm信息,线程情况,导出堆文件..还有反编译,热替换等功能</p></li> <li><p>class文件结构
文件头CAFEBABE - 小版本号+大版本号(52.0) - 常量池数量+常量池 - 修饰用关键字 - 本类 - 父类 - 接口/ - 成员变量/ - 方法/... 可以使用javap/插件查看,JVM的汇编指令这种..</p></li> <li><p>L3缓存数据共享问题 cache-line伪共享问题 cpu乱序执行 合并写writeCombineBuffer
解决L3缓存共享数据问题 	1.总线锁 2.缓存锁(MESI等缓存一致性协议)
cache-line伪共享问题	缓存块一次读64bytes,多线程下缓存锁造成多CPU缓存之间持续同步
cpu乱序执行				cpu为了提高效率,打乱没有依赖关系的指令顺序,压榨多线程的性能
合并写 WriteCombineBuffer	一般是4个字节大小,由于ALU 速度最快,在写入L1的同时写入一个CombineBuffer,写满后直接给L2
硬件级别CPU内存屏障		sfence lfence mfence (save load mix)</p></li> <li><p>基本问题
java是解释还是编译的? (mixed-mod下)解释+编译(JIT) JIT代码热点检测(计数器 -- 方法多次, 循环多次)(热点参数-XX:CompileThreshold=10000)
javac过程? (解析文件生成抽象语法树再输出为class)
常见JVM实现: Hotspot,zing,J9,JRocket
JVM JRE JDK区别	JVM只是一种标准/规范, 有多种实现, java SE拥有java语言规范和jvm规范
i=i++;问题: 把局部变量表i的原值压栈,把i的值增加,然后再把栈里的原值弹回来赋值.. 最终i值没变
DCL问题: new 开辟内存空间(创建默认对象),并把内存地址压栈	dup double一份压栈	invokespecial弹出一个元素,初始化后赋值给它
一些JVM指令: invokeStatic静态方法, invokeVirtual多态方法, invokeInterface接口, invokeSpecial直接定位的方法, invokeDynamic动态(反射,asm,lambda,动态语言Scala)</p></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/20/2021, 9:42:07 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.42575a28.js" defer></script><script src="/assets/js/2.0d7d09b8.js" defer></script><script src="/assets/js/92.158fcc7a.js" defer></script>
  </body>
</html>
